<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Kovacs"><meta name="keywords" content="GoReplay"><meta name="description" content="GoReplay 是一个实时流量抓取工具，可以将生产环境流量实时抓取并重放到测试环境；本文主要记录 GoReplay 的相关使用。"><meta property="og:type" content="article"><meta property="og:title" content="使用 GoReplay 进行 HTTP 流量复制"><meta property="og:url" content="https://mritd.com/2021/08/03/use-goreplay-to-record-your-live-traffic/index.html"><meta property="og:site_name" content="Kovacs"><meta property="og:description" content="GoReplay 是一个实时流量抓取工具，可以将生产环境流量实时抓取并重放到测试环境；本文主要记录 GoReplay 的相关使用。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mritd.com/img/goreplay.png"><meta property="article:published_time" content="2021-08-03T10:23:00.000Z"><meta property="article:modified_time" content="2021-08-03T10:23:00.000Z"><meta property="article:author" content="Kovacs"><meta property="article:tag" content="GoReplay"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://mritd.com/img/goreplay.png"><meta name="twitter:creator" content="@kovacs_orz"><meta name="twitter:site" content="https://twitter.com/kovacs_orz"><title>使用 GoReplay 进行 HTTP 流量复制 - Kovacs</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"mritd.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!0,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:"G-H06NPECR0Z"},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-H06NPECR0Z",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-H06NPECR0Z")}))</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Kovacs" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="Kovacs" type="application/rss+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Kovacs</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/friends/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="使用 GoReplay 进行 HTTP 流量复制"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Kovacs </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-08-03 18:23" pubdate>2021年8月3日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 17 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">使用 GoReplay 进行 HTTP 流量复制</h1><div class="markdown-body"><h2 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h2><p>GoReplay 采用 Go 编写，其只有一个单独的可执行文件，在官方 <a target="_blank" rel="noopener" href="https://github.com/buger/goreplay/releases">Release</a> 页下载后将其放到 <code>PATH</code> 目录即可。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://github.com/buger/goreplay/releases/download/v1.2.0/gor_v1.2.0_x64.tar.gz<br>tar -zxvf gor_v1.2.0_x64.tar.gz<br><span class="hljs-built_in">mv</span> gor /usr/local/bin<br></code></pre></td></tr></table></figure><h2 id="二、基本使用"><a href="#二、基本使用" class="headerlink" title="二、基本使用"></a>二、基本使用</h2><p>GoReplay 命令行整体使用方式为指定输入端和输入端，然后 GoReplay 从输入端将流量复制到输出端。</p><h3 id="2-1、实时流量复制"><a href="#2-1、实时流量复制" class="headerlink" title="2.1、实时流量复制"></a>2.1、实时流量复制</h3><p>GoReplay 输入端可以指定一个 tcp 地址，然后 GoReplay 将该端口流量复制到输出端；下面样例展示从 <code>127.0.0.0:8000</code> 复制流量并输出到控制台的样例。</p><p><strong>首先启动一个 HTTP Server，这里直接使用 <code>python</code> 的 HTTP Server</strong></p><p><img src="https://cdn.oss.link/markdown/hnOfHX.png" srcset="/img/loading.gif" lazyload></p><p><strong>接着再让 gor 监听同样的端口，<code>--output-stdout</code> 指定输出端为控制台</strong></p><p><img src="https://cdn.oss.link/markdown/QhFUdM.png" srcset="/img/loading.gif" lazyload></p><p><strong>此时通过 <code>curl</code> 访问 <code>python</code> 的 HTTP Server 可以看到 gor 将 HTTP 请求复制并输出到了控制台</strong></p><p><img src="https://cdn.oss.link/markdown/uilePc.png" srcset="/img/loading.gif" lazyload></p><p>同样如果我们通过 <code>--output-http</code> 选项将输出端指定为另一个 HTTP Server，那么 gor 会将请求同步复制并发送到输出端 HTTP Server。</p><p><img src="https://cdn.oss.link/markdown/vFQiRs.png" srcset="/img/loading.gif" lazyload></p><h3 id="2-2、流量抓取与重放"><a href="#2-2、流量抓取与重放" class="headerlink" title="2.2、流量抓取与重放"></a>2.2、流量抓取与重放</h3><h4 id="2-2-1、基本使用"><a href="#2-2-1、基本使用" class="headerlink" title="2.2.1、基本使用"></a>2.2.1、基本使用</h4><p>GoReplay 可以将输出端指定为文件，从而将流量保存到文件中，然后 GoReplay 读取该保存的流量文件并重放到指定的 HTTP Server 中。</p><p><strong>首先通过 <code>--outpu-file</code> 选项将请求保存到文件中</strong></p><p><img src="https://cdn.oss.link/markdown/yuxiYQ-1627911532-lA2val.png" srcset="/img/loading.gif" lazyload></p><p><strong>使用 <code>--input-file</code> 选项读取流量信息，然后通过 <code>--output-http</code> 选项重放到目标服务器</strong></p><p><img src="https://cdn.oss.link/markdown/cRB3x4-1627911738-7pLgTp.png" srcset="/img/loading.gif" lazyload></p><h4 id="2-2-2、扩展选项"><a href="#2-2-2、扩展选项" class="headerlink" title="2.2.2、扩展选项"></a>2.2.2、扩展选项</h4><p>在将流量保存到文件时，默认情况下 GoReplay 以块形式写入文件，并且每个块将生成一个独立的文件名(<code>test_0.gor</code>)，如果想要将所有块的流量全部写入一个文件中，<strong>可以设置 <code>--output-file-append</code> 为 <code>true</code>。</strong></p><p>同时 GoReplay 输出文件名支持日期占位符，例如 <code>--output-file %Y%m%d.gor</code> 会生成 <code>20210801.gor</code> 这种文件名；所有可用的日期占位符如下:</p><ul><li><code>%Y</code>: year including the century (at least 4 digits)</li><li><code>%m</code>: month of the year (01..12)</li><li><code>%d</code>: Day of the month (01..31)</li><li><code>%H</code>: Hour of the day, 24-hour clock (00..23)</li><li><code>%M</code>: Minute of the hour (00..59)</li><li><code>%S</code>: Second of the minute (00..60)</li></ul><p>请求比较多时，将流量保存到文件可能会导致文件很大，这时候可以使用 <code>.gz</code> 结尾作为文件名，GoReplay 读取到 <code>.gz</code> 后缀后会自动进行 GZip 压缩处理。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">gor --input-raw :8000 --output-file test.gor.gz<br></code></pre></td></tr></table></figure><p>如果需要对多个文件进行聚合重放，只需要指定多个文件即可，重放过程中 GoReplay 会自动保持请求顺序:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">gor --input-file *.gor --output-http http://127.0.0.1:8080<br></code></pre></td></tr></table></figure><p>在使用文件输入时，GoReplay 还支持压力测试，通过 <code>test.gor|200%</code> 这种方式指定的文件名，GoReplay 会以两倍的速率进行请求重放:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Replay from file on 2x speed </span><br>gor --input-file <span class="hljs-string">&quot;requests.gor|200%&quot;</span> --output-http <span class="hljs-string">&quot;staging.com&quot;</span><br></code></pre></td></tr></table></figure><h3 id="2-3、数据丢失与缓冲区"><a href="#2-3、数据丢失与缓冲区" class="headerlink" title="2.3、数据丢失与缓冲区"></a>2.3、数据丢失与缓冲区</h3><p>GoReplay 采用比较底层的数据包拦截技术，当一个 TCP 数据包到达时内核 GoReplay 会进行拦截；然而数据包可以乱序到达，接下来内核需要重建 TCP 流来保证上层应用能以正确的顺序读取 TCP 数据包，这时候内核就会有一个数据包的缓冲区；默认情况下 Linux 系统的缓冲区为 2M，Windiws 为 1M，当特定的 HTTP 请求数据包超过缓冲区时，GoReplay 就无法正确的拦截(因为 GoReplay 需要一个完整的 HTTP 请求数据包用于保存到文件或者重放)，同时可能会导致请求丢失、请求损坏等问题。</p><p>为了解决这种问题，GoReplay 提供了 <code>--input-raw-buffer-size</code> 选项用于调整缓冲区大小，例如 <code>--input-raw-buffer-size 10485760</code> 选项会将缓冲区调整为 10M。</p><h3 id="2-4、速率限制"><a href="#2-4、速率限制" class="headerlink" title="2.4、速率限制"></a>2.4、速率限制</h3><p>某些情况下可能为了方便调试，我们在生产环境抓取流量并镜像到测试环境进行重放；但是可能由于生产环境流量比较大，我们并不需要如此大的请求速率，这时候可以通过速率限制让 GoReplay 帮我们控制请求数量。</p><p><strong>绝对数量限制:</strong> 使用 <code>--output-http &quot;ADDRESS|N&quot;</code> 形式的参数时，GoReplay 会保证镜像的流量请求每秒不会超过 “N” 个。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># staging.server will not get more than ten requests per second</span><br>gor --input-tcp :28020 --output-http <span class="hljs-string">&quot;http://staging.com|10&quot;</span><br></code></pre></td></tr></table></figure><p><strong>百分比限制限制:</strong> 使用 <code>--output-http &quot;ADDRESS|N%&quot;</code> 形式的参数时，GoReplay 会保证镜像的流量维持在总流量的 “N%”。</p><h3 id="2-5、请求过滤"><a href="#2-5、请求过滤" class="headerlink" title="2.5、请求过滤"></a>2.5、请求过滤</h3><p>在某些时候我们只期望把生产环境的特定流量重放到测试环境，或者禁止一些流量重放到测试环境，这时候我们可以使用 GoReplay 的过滤功能；GoReplay 提供以下选项来提供过滤功能:</p><ul><li><code>--http-allow-header</code>: 允许重放的 HTTP 头(支持正则)</li><li><code>--http-allow-method</code>: 允许重放的 HTTP 方法</li><li><code>--http-allow-url</code>: 允许重放的 URL(支持正则)</li><li><code>--http-disallow-header</code>: 不允许的 HTTP 头(支持正则)</li><li><code>--http-disallow-url</code>: 不允许的 HTTP URL(支持正则)</li></ul><p>以下是官方给出的命令样例:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># only forward requests being sent to the /api endpoint</span><br>gor --input-raw :8080 --output-http staging.com --http-allow-url /api<br><br><span class="hljs-comment"># only forward requests NOT being sent to the /api... endpoint</span><br>gor --input-raw :8080 --output-http staging.com --http-disallow-url /api<br><br><span class="hljs-comment"># only forward requests with an api version of 1.0x</span><br>gor --input-raw :8080 --output-http staging.com --http-allow-header api-version:^1\.0\d<br><br><span class="hljs-comment"># only forward requests NOT containing User-Agent header value &quot;Replayed by Gor&quot;</span><br>gor --input-raw :8080 --output-http staging.com --http-disallow-header <span class="hljs-string">&quot;User-Agent: Replayed by Gor&quot;</span><br><br>gor --input-raw :80 --output-http <span class="hljs-string">&quot;http://staging.server&quot;</span> \<br>    --http-allow-method GET \<br>    --http-allow-method OPTIONS<br></code></pre></td></tr></table></figure><h3 id="2-6、请求重写"><a href="#2-6、请求重写" class="headerlink" title="2.6、请求重写"></a>2.6、请求重写</h3><p>有时候可能测试环境的 URL 路径与生产环境完全不同，此时如果直接把生产环境的流量在测试环境重放可能会导致请求路径错误等情况；为此 GoReplay 提供了 URL 重写、参数设置、请求头设置等功能。</p><p><strong>通过 <code>--http-rewrite-url</code> 选项进行 URL 重写</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Rewrites all `/v1/user/&lt;user_id&gt;/ping` requests to `/v2/user/&lt;user_id&gt;/ping`</span><br>gor --input-raw :8080 --output-http staging.com --http-rewrite-url /v1/user/([^\\/]+)/ping:/v2/user/<span class="hljs-variable">$1</span>/ping<br></code></pre></td></tr></table></figure><p><strong>设置 URL 参数</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">gor --input-raw :8080 --output-http staging.com --http-set-param api_key=1<br></code></pre></td></tr></table></figure><p><strong>设置请求头</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">gor --input-raw :80 --output-http <span class="hljs-string">&quot;http://staging.server&quot;</span> \<br>    --http-header <span class="hljs-string">&quot;User-Agent: Replayed by Gor&quot;</span> \<br>    --http-header <span class="hljs-string">&quot;Enable-Feature-X: true&quot;</span><br></code></pre></td></tr></table></figure><p><strong>Host 头是一个特殊的请求头，默认情况下 GoReplay 会将其自动设置为目标重放地址的域名，如果想关闭这种默认行为请使用 <code>--http-original-host</code> 选项。</strong></p><h2 id="三、其他高级配置"><a href="#三、其他高级配置" class="headerlink" title="三、其他高级配置"></a>三、其他高级配置</h2><h3 id="3-1、中继服务器"><a href="#3-1、中继服务器" class="headerlink" title="3.1、中继服务器"></a>3.1、中继服务器</h3><p>GoReplay 可以使用中继服务器从而实现链式的流量传递，使用中继服务器时只需要将输出端设置为 TCP 模式，然后中继服务器输入端也设置为 TCP 模式即可:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Run on servers where you want to catch traffic. You can run it on each `web` machine.</span><br>gor --input-raw :80 --output-tcp replay.local:28020<br><br><span class="hljs-comment"># Replay server (replay.local).</span><br>gor --input-tcp replay.local:28020 --output-http http://staging.com<br></code></pre></td></tr></table></figure><p>如果有多个中继服务器，可以使用 <code>--split-output</code> 选项让每个抓取流量的 GoReplay 使用轮询算法向每个中继服务器发送流量:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">gor --input-raw :80 --split-output --output-tcp replay1.local:28020 --output-tcp replay2.local:28020<br></code></pre></td></tr></table></figure><h3 id="3-2、输出到-ElasticSearch"><a href="#3-2、输出到-ElasticSearch" class="headerlink" title="3.2、输出到 ElasticSearch"></a>3.2、输出到 ElasticSearch</h3><p>GoReplay 支持将输出端设置为 ElasticSearch:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">./gor --input-raw :8000 --output-http http://staging.com --output-http-elasticsearch localhost:9200/gor<br></code></pre></td></tr></table></figure><p>输出到 ES 时不需要预先创建索引，GoReplay 会自动完成，输出到 ES 后其数据结构如下:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> ESRequestResponse <span class="hljs-keyword">struct</span> &#123;<br>	ReqURL               <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Req_URL&quot;`</span><br>	ReqMethod            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Req_Method&quot;`</span><br>	ReqUserAgent         <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Req_User-Agent&quot;`</span><br>	ReqAcceptLanguage    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Req_Accept-Language,omitempty&quot;`</span><br>	ReqAccept            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Req_Accept,omitempty&quot;`</span><br>	ReqAcceptEncoding    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Req_Accept-Encoding,omitempty&quot;`</span><br>	ReqIfModifiedSince   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Req_If-Modified-Since,omitempty&quot;`</span><br>	ReqConnection        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Req_Connection,omitempty&quot;`</span><br>	ReqCookies           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Req_Cookies,omitempty&quot;`</span><br>	RespStatus           <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Resp_Status&quot;`</span><br>	RespStatusCode       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Resp_Status-Code&quot;`</span><br>	RespProto            <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Resp_Proto,omitempty&quot;`</span><br>	RespContentLength    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Resp_Content-Length,omitempty&quot;`</span><br>	RespContentType      <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Resp_Content-Type,omitempty&quot;`</span><br>	RespTransferEncoding <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Resp_Transfer-Encoding,omitempty&quot;`</span><br>	RespContentEncoding  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Resp_Content-Encoding,omitempty&quot;`</span><br>	RespExpires          <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Resp_Expires,omitempty&quot;`</span><br>	RespCacheControl     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Resp_Cache-Control,omitempty&quot;`</span><br>	RespVary             <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Resp_Vary,omitempty&quot;`</span><br>	RespSetCookie        <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;Resp_Set-Cookie,omitempty&quot;`</span><br>	Rtt                  <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;RTT&quot;`</span><br>	Timestamp            time.Time<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3、Kafka-对接"><a href="#3-3、Kafka-对接" class="headerlink" title="3.3、Kafka 对接"></a>3.3、Kafka 对接</h3><p>除了输出到 ES 以外，GoReplay 还支持输出到 Kafka 以及从 Kafka 中读取数据:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">gor --input-raw :8080 --output-kafka-host <span class="hljs-string">&#x27;192.168.0.1:9092,192.168.0.2:9092&#x27;</span> --output-kafka-topic <span class="hljs-string">&#x27;kafka-log&#x27;</span><br><br>gor --input-kafka-host <span class="hljs-string">&#x27;192.168.0.1:9092,192.168.0.2:9092&#x27;</span> --input-kafka-topic <span class="hljs-string">&#x27;kafka-log&#x27;</span> --output-stdout<br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/linux/" class="category-chain-item">Linux</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/goreplay/" class="print-no-link">#GoReplay</a></div></div><div class="license-box my-3"><div class="license-title"><div>使用 GoReplay 进行 HTTP 流量复制</div><div>https://mritd.com/2021/08/03/use-goreplay-to-record-your-live-traffic/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Kovacs</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2021年8月3日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2021/08/20/switching-rrom-nginx-too-caddy/" title="从 Nginx 切换到 Caddy"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">从 Nginx 切换到 Caddy</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2021/07/29/test-the-k0s-cluster/" title="k0s 折腾笔记"><span class="hidden-mobile">k0s 折腾笔记</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://mritd.com/2021/08/03/use-goreplay-to-record-your-live-traffic/",this.page.identifier="/2021/08/03/use-goreplay-to-record-your-live-traffic/"};Fluid.utils.loadComments("#disqus_thread",(function(){var e=document,t=e.createElement("script");t.src="//bleem.disqus.com/embed.js",t.setAttribute("data-timestamp",new Date),(e.head||e.body).appendChild(t)}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-docker"></i> <a href="https://bandwagonhost.com/aff.php?aff=61367" target="_blank" rel="nofollow noopener"><span>BandwagonHost</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!0,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>