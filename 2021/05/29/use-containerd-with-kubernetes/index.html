<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Kovacs"><meta name="keywords" content="Containerd"><meta name="description" content="换到 Containerd 小半年了，没事写写。"><meta property="og:type" content="article"><meta property="og:title" content="Kubernetes 切换到 Containerd"><meta property="og:url" content="https://mritd.com/2021/05/29/use-containerd-with-kubernetes/index.html"><meta property="og:site_name" content="Kovacs"><meta property="og:description" content="换到 Containerd 小半年了，没事写写。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mritd.com/img/containerd.jpg"><meta property="article:published_time" content="2021-05-29T15:01:00.000Z"><meta property="article:modified_time" content="2021-05-29T15:01:00.000Z"><meta property="article:author" content="Kovacs"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Kubernetes"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://mritd.com/img/containerd.jpg"><meta name="twitter:creator" content="@kovacs_orz"><meta name="twitter:site" content="https://twitter.com/kovacs_orz"><title>Kubernetes 切换到 Containerd - Kovacs</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"mritd.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!0,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:"G-H06NPECR0Z"},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-H06NPECR0Z",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-H06NPECR0Z")}))</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Kovacs" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="Kovacs" type="application/rss+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Kovacs</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/friends/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Kubernetes 切换到 Containerd"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Kovacs </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-05-29 23:01" pubdate>2021年5月29日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.4k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 20 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">Kubernetes 切换到 Containerd</h1><div class="markdown-body"><h2 id="一、环境准备"><a href="#一、环境准备" class="headerlink" title="一、环境准备"></a>一、环境准备</h2><ul><li>Ubuntu 20.04 x5</li><li>Etcd 3.4.16</li><li>Kubernetes 1.21.1</li><li>Containerd 1.3.3</li></ul><h3 id="1-1、处理-IPVS"><a href="#1-1、处理-IPVS" class="headerlink" title="1.1、处理 IPVS"></a>1.1、处理 IPVS</h3><p>由于 Kubernetes 新版本 Service 实现切换到 IPVS，所以需要确保内核加载了 IPVS modules；以下命令将设置系统启动自动加载 IPVS 相关模块，执行完成后需要重启。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Kernel modules</span><br><span class="hljs-built_in">cat</span> &gt; /etc/modules-load.d/50-kubernetes.conf &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string"># Load some kernel modules needed by kubernetes at boot</span><br><span class="hljs-string">nf_conntrack</span><br><span class="hljs-string">br_netfilter</span><br><span class="hljs-string">ip_vs</span><br><span class="hljs-string">ip_vs_lc</span><br><span class="hljs-string">ip_vs_wlc</span><br><span class="hljs-string">ip_vs_rr</span><br><span class="hljs-string">ip_vs_wrr</span><br><span class="hljs-string">ip_vs_lblc</span><br><span class="hljs-string">ip_vs_lblcr</span><br><span class="hljs-string">ip_vs_dh</span><br><span class="hljs-string">ip_vs_sh</span><br><span class="hljs-string">ip_vs_fo</span><br><span class="hljs-string">ip_vs_nq</span><br><span class="hljs-string">ip_vs_sed</span><br><span class="hljs-string">EOF</span><br><br><span class="hljs-comment"># sysctl</span><br><span class="hljs-built_in">cat</span> &gt; /etc/sysctl.d/50-kubernetes.conf &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">net.ipv4.ip_forward=1</span><br><span class="hljs-string">net.bridge.bridge-nf-call-iptables=1</span><br><span class="hljs-string">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="hljs-string">fs.inotify.max_user_watches=525000</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure><p>重启完成后务必检查相关 module 加载以及内核参数设置:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># check ipvs modules</span><br>➜ ~ lsmod | grep ip_vs<br>ip_vs_sed              16384  0<br>ip_vs_nq               16384  0<br>ip_vs_fo               16384  0<br>ip_vs_sh               16384  0<br>ip_vs_dh               16384  0<br>ip_vs_lblcr            16384  0<br>ip_vs_lblc             16384  0<br>ip_vs_wrr              16384  0<br>ip_vs_rr               16384  0<br>ip_vs_wlc              16384  0<br>ip_vs_lc               16384  0<br>ip_vs                 155648  22 ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed<br>nf_conntrack          139264  1 ip_vs<br>nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs<br>libcrc32c              16384  5 nf_conntrack,btrfs,xfs,raid456,ip_vs<br><br><span class="hljs-comment"># check sysctl</span><br>➜ ~ sysctl -a | grep ip_forward<br>net.ipv4.ip_forward = 1<br>net.ipv4.ip_forward_update_priority = 1<br>net.ipv4.ip_forward_use_pmtu = 0<br><br>➜ ~ sysctl -a | grep bridge-nf-call<br>net.bridge.bridge-nf-call-arptables = 1<br>net.bridge.bridge-nf-call-ip6tables = 1<br>net.bridge.bridge-nf-call-iptables = 1<br></code></pre></td></tr></table></figure><h3 id="1-2、安装-Containerd"><a href="#1-2、安装-Containerd" class="headerlink" title="1.2、安装 Containerd"></a>1.2、安装 Containerd</h3><p>Containerd 在 Ubuntu 20 中已经在默认官方仓库中包含，所以只需要 apt 安装即可:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 其他软件包后面可能会用到，所以顺手装了</span><br>apt install containerd bridge-utils nfs-common tree -y<br></code></pre></td></tr></table></figure><p>安装成功后可以通过执行 <code>ctr images ls</code> 命令验证，<strong>本章节不会对 Containerd 配置做说明，Containerd 配置文件将在 Kubernetes 安装时进行配置。</strong></p><h2 id="二、安装-kubernetes"><a href="#二、安装-kubernetes" class="headerlink" title="二、安装 kubernetes"></a>二、安装 kubernetes</h2><h3 id="2-1、安装-Etcd-集群"><a href="#2-1、安装-Etcd-集群" class="headerlink" title="2.1、安装 Etcd 集群"></a>2.1、安装 Etcd 集群</h3><p>Etcd 对于 Kubernetes 来说是核心中的核心，所以个人还是比较喜欢在宿主机安装；宿主机安装情况下为了方便我打包了一些 <strong><code>*-pack</code></strong> 的工具包，用于快速处理:</p><p>安装 CFSSL 和 ETCD</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 下载安装包</span><br>wget https://github.com/mritd/etcd-pack/releases/download/v3.4.16/etcd_v3.4.16.run<br>wget https://github.com/mritd/cfssl-pack/releases/download/v1.5.0/cfssl_v1.5.0.run<br><br><span class="hljs-comment"># 安装 cfssl 和 etcd</span><br><span class="hljs-built_in">chmod</span> +x *.run<br>./etcd_v3.4.16.run install<br>./cfssl_v1.5.0.run install<br></code></pre></td></tr></table></figure><p>安装完成后，<strong>自行调整 <code>/etc/cfssl/etcd/etcd-csr.json</code> 相关 IP</strong>，然后执行同目录下 <code>create.sh</code> 生成证书。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs sh">➜ ~ <span class="hljs-built_in">cat</span> /etc/cfssl/etcd/etcd-csr.json<br>&#123;<br>    <span class="hljs-string">&quot;key&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;algo&quot;</span>: <span class="hljs-string">&quot;rsa&quot;</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: 2048<br>    &#125;,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>        &#123;<br>            <span class="hljs-string">&quot;O&quot;</span>: <span class="hljs-string">&quot;etcd&quot;</span>,<br>            <span class="hljs-string">&quot;OU&quot;</span>: <span class="hljs-string">&quot;etcd Security&quot;</span>,<br>            <span class="hljs-string">&quot;L&quot;</span>: <span class="hljs-string">&quot;Beijing&quot;</span>,<br>            <span class="hljs-string">&quot;ST&quot;</span>: <span class="hljs-string">&quot;Beijing&quot;</span>,<br>            <span class="hljs-string">&quot;C&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span><br>        &#125;<br>    ],<br>    <span class="hljs-string">&quot;CN&quot;</span>: <span class="hljs-string">&quot;etcd&quot;</span>,<br>    <span class="hljs-string">&quot;hosts&quot;</span>: [<br>        <span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br>        <span class="hljs-string">&quot;localhost&quot;</span>,<br>        <span class="hljs-string">&quot;*.etcd.node&quot;</span>,<br>        <span class="hljs-string">&quot;*.kubernetes.node&quot;</span>,<br>        <span class="hljs-string">&quot;10.0.0.11&quot;</span>,<br>        <span class="hljs-string">&quot;10.0.0.12&quot;</span>,<br>        <span class="hljs-string">&quot;10.0.0.13&quot;</span><br>    ]<br>&#125;<br><br><span class="hljs-comment"># 复制到 3 台 master</span><br>➜ ~ <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> `<span class="hljs-built_in">seq</span> 1 3`; <span class="hljs-keyword">do</span> scp /etc/cfssl/etcd/*.pem root@10.0.0.1<span class="hljs-variable">$ip</span>:/etc/etcd/ssl; <span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><p>证书生成完成后调整每台机器的 Etcd 配置文件，然后修复权限启动。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 复制配置</span><br><span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> `<span class="hljs-built_in">seq</span> 1 3`; <span class="hljs-keyword">do</span> scp /etc/etcd/etcd.cluster.yaml root@10.0.0.1<span class="hljs-variable">$ip</span>:/etc/etcd/etcd.yaml; <span class="hljs-keyword">done</span><br><br><span class="hljs-comment"># 修复权限</span><br><span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> `<span class="hljs-built_in">seq</span> 1 3`; <span class="hljs-keyword">do</span> ssh root@10.0.0.1<span class="hljs-variable">$ip</span> <span class="hljs-built_in">chown</span> -R etcd:etcd /etc/etcd; <span class="hljs-keyword">done</span><br><br><span class="hljs-comment"># 每台机器启动</span><br>systemctl start etcd<br></code></pre></td></tr></table></figure><p>启动完成后通过 <code>etcdctl</code> 验证集群状态:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 稳妥点应该执行 etcdctl endpoint health</span><br>➜ ~ etcdctl member list<br>55fcbe0adaa45350, started, etcd3, https://10.0.0.13:2380, https://10.0.0.13:2379, <span class="hljs-literal">false</span><br>cebdf10928a06f3c, started, etcd1, https://10.0.0.11:2380, https://10.0.0.11:2379, <span class="hljs-literal">false</span><br>f7a9c20602b8532e, started, etcd2, https://10.0.0.12:2380, https://10.0.0.12:2379, <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><h3 id="2-2、安装-kubeadm"><a href="#2-2、安装-kubeadm" class="headerlink" title="2.2、安装 kubeadm"></a>2.2、安装 kubeadm</h3><p>kubeadm 国内用户建议使用 aliyun 的安装源:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># kubeadm</span><br>apt-get install -y apt-transport-https<br>curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -<br><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span><br><span class="hljs-string">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="hljs-string">EOF</span><br>apt update<br><br><span class="hljs-comment"># ebtables、ethtool kubelet 可能会用，具体忘了，反正从官方文档上看到的</span><br>apt install kubelet kubeadm kubectl ebtables ethtool -y<br></code></pre></td></tr></table></figure><h3 id="2-3、安装-kube-apiserver-proxy"><a href="#2-3、安装-kube-apiserver-proxy" class="headerlink" title="2.3、安装 kube-apiserver-proxy"></a>2.3、安装 kube-apiserver-proxy</h3><p>kube-apiserver-proxy 是我自己编译的一个仅开启四层代理的 Nginx，其主要负责监听 <code>127.0.0.1:6443</code> 并负载到所有的 Api Server 地址(<code>0.0.0.0:5443</code>):</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://github.com/mritd/kube-apiserver-proxy-pack/releases/download/v1.20.0/kube-apiserver-proxy_v1.20.0.run<br><span class="hljs-built_in">chmod</span> +x *.run<br>./kube-apiserver-proxy_v1.20.0.run install<br></code></pre></td></tr></table></figure><p>安装完成后根据 IP 地址不同自行调整 Nginx 配置文件，然后启动:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs sh">➜ ~ <span class="hljs-built_in">cat</span> /etc/kubernetes/apiserver-proxy.conf<br>error_log syslog:server=unix:/dev/log notice;<br><br>worker_processes auto;<br>events &#123;<br>        multi_accept on;<br>        use epoll;<br>        worker_connections 1024;<br>&#125;<br><br>stream &#123;<br>    upstream kube_apiserver &#123;<br>        least_conn;<br>        server 10.0.0.11:5443;<br>        server 10.0.0.12:5443;<br>        server 10.0.0.13:5443;<br>    &#125;<br><br>    server &#123;<br>        listen        0.0.0.0:6443;<br>        proxy_pass    kube_apiserver;<br>        proxy_timeout 10m;<br>        proxy_connect_timeout 1s;<br>    &#125;<br>&#125;<br><br>systemctl start kube-apiserver-proxy<br></code></pre></td></tr></table></figure><h3 id="2-4、安装-kubeadm-config"><a href="#2-4、安装-kubeadm-config" class="headerlink" title="2.4、安装 kubeadm-config"></a>2.4、安装 kubeadm-config</h3><p>kubeadm-config 是一系列配置文件的组合以及 kubeadm 安装所需的必要镜像文件的打包，安装完成后将会自动配置 Containerd、ctrictl 等:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://github.com/mritd/kubeadm-config-pack/releases/download/v1.21.1/kubeadm-config_v1.21.1.run<br><span class="hljs-built_in">chmod</span> +x *.run<br><br><span class="hljs-comment"># --load 选项用于将 kubeadm 所需镜像 load 到 containerd 中</span><br>./kubeadm-config_v1.21.1.run install --load<br></code></pre></td></tr></table></figure><h4 id="2-4-1、containerd-配置"><a href="#2-4-1、containerd-配置" class="headerlink" title="2.4.1、containerd 配置"></a>2.4.1、containerd 配置</h4><p>Containerd 配置位于 <code>/etc/containerd/config.toml</code>，其配置如下:</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-attr">version</span> = <span class="hljs-number">2</span><br><span class="hljs-comment"># 指定存储根目录</span><br><span class="hljs-attr">root</span> = <span class="hljs-string">&quot;/data/containerd&quot;</span><br><span class="hljs-attr">state</span> = <span class="hljs-string">&quot;/run/containerd&quot;</span><br><span class="hljs-comment"># OOM 评分</span><br><span class="hljs-attr">oom_score</span> = -<span class="hljs-number">999</span><br><br><span class="hljs-section">[grpc]</span><br>  <span class="hljs-attr">address</span> = <span class="hljs-string">&quot;/run/containerd/containerd.sock&quot;</span><br><br><span class="hljs-section">[metrics]</span><br>  <span class="hljs-attr">address</span> = <span class="hljs-string">&quot;127.0.0.1:1234&quot;</span><br><br><span class="hljs-section">[plugins]</span><br>  <span class="hljs-section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;]</span><br>    <span class="hljs-comment"># sandbox 镜像</span><br>    <span class="hljs-attr">sandbox_image</span> = <span class="hljs-string">&quot;k8s.gcr.io/pause:3.4.1&quot;</span><br>    <span class="hljs-section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]</span><br>      <span class="hljs-attr">snapshotter</span> = <span class="hljs-string">&quot;overlayfs&quot;</span><br>      <span class="hljs-attr">default_runtime_name</span> = <span class="hljs-string">&quot;runc&quot;</span><br>      <span class="hljs-section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]</span><br>        <span class="hljs-section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]</span><br>          <span class="hljs-attr">runtime_type</span> = <span class="hljs-string">&quot;io.containerd.runc.v2&quot;</span><br>          <span class="hljs-comment"># 开启 systemd cgroup</span><br>          <span class="hljs-section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]</span><br>            <span class="hljs-attr">SystemdCgroup</span> = <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h4 id="2-4-2、crictl-配置"><a href="#2-4-2、crictl-配置" class="headerlink" title="2.4.2、crictl 配置"></a>2.4.2、crictl 配置</h4><p>在切换到 Containerd 以后意味着以前的 <code>docker</code> 命令将不再可用，containerd 默认自带了一个 <code>ctr</code> 命令，同时 CRI 规范会自带一个 <code>crictl</code> 命令；<code>crictl</code> 命令配置文件存放在 <code>/etc/crictl.yaml</code> 中:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">runtime-endpoint:</span> <span class="hljs-string">unix:///run/containerd/containerd.sock</span><br><span class="hljs-attr">image-endpoint:</span> <span class="hljs-string">unix:///run/containerd/containerd.sock</span><br><span class="hljs-attr">pull-image-on-create:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h4 id="2-4-3、kubeadm-配置"><a href="#2-4-3、kubeadm-配置" class="headerlink" title="2.4.3、kubeadm 配置"></a>2.4.3、kubeadm 配置</h4><p>kubeadm 配置目前分为 2 个，一个是用于首次引导启动的 init 配置，另一个是用于其他节点 join 到 master 的配置；其中比较重要的 init 配置如下:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># /etc/kubernetes/kubeadm.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubeadm.k8s.io/v1beta2</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">InitConfiguration</span><br><span class="hljs-comment"># kubeadm token create</span><br><span class="hljs-attr">bootstrapTokens:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">token:</span> <span class="hljs-string">&quot;c2t0rj.cofbfnwwrb387890&quot;</span><br><span class="hljs-attr">nodeRegistration:</span><br>  <span class="hljs-comment"># CRI 地址(Containerd)</span><br>  <span class="hljs-attr">criSocket:</span> <span class="hljs-string">unix:///run/containerd/containerd.sock</span><br>  <span class="hljs-attr">kubeletExtraArgs:</span><br>    <span class="hljs-attr">runtime-cgroups:</span> <span class="hljs-string">&quot;/system.slice/containerd.service&quot;</span><br>    <span class="hljs-attr">rotate-server-certificates:</span> <span class="hljs-string">&quot;true&quot;</span><br><span class="hljs-attr">localAPIEndpoint:</span><br>  <span class="hljs-attr">advertiseAddress:</span> <span class="hljs-string">&quot;10.0.0.11&quot;</span><br>  <span class="hljs-attr">bindPort:</span> <span class="hljs-number">5443</span><br><span class="hljs-comment"># kubeadm certs certificate-key</span><br><span class="hljs-attr">certificateKey:</span> <span class="hljs-string">31f1e534733a1607e5ba67b2834edd3a7debba41babb1fac1bee47072a98d88b</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubeadm.k8s.io/v1beta2</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterConfiguration</span><br><span class="hljs-attr">clusterName:</span> <span class="hljs-string">&quot;kuberentes&quot;</span><br><span class="hljs-attr">kubernetesVersion:</span> <span class="hljs-string">&quot;v1.21.1&quot;</span><br><span class="hljs-attr">certificatesDir:</span> <span class="hljs-string">&quot;/etc/kubernetes/pki&quot;</span><br><span class="hljs-comment"># Other components of the current control plane only connect to the apiserver on the current host.</span><br><span class="hljs-comment"># This is the expected behavior, see: https://github.com/kubernetes/kubeadm/issues/2271</span><br><span class="hljs-attr">controlPlaneEndpoint:</span> <span class="hljs-string">&quot;127.0.0.1:6443&quot;</span><br><span class="hljs-attr">etcd:</span><br>  <span class="hljs-attr">external:</span><br>    <span class="hljs-attr">endpoints:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;https://10.0.0.11:2379&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;https://10.0.0.12:2379&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;https://10.0.0.13:2379&quot;</span><br>    <span class="hljs-attr">caFile:</span> <span class="hljs-string">&quot;/etc/etcd/ssl/etcd-ca.pem&quot;</span><br>    <span class="hljs-attr">certFile:</span> <span class="hljs-string">&quot;/etc/etcd/ssl/etcd.pem&quot;</span><br>    <span class="hljs-attr">keyFile:</span> <span class="hljs-string">&quot;/etc/etcd/ssl/etcd-key.pem&quot;</span><br><span class="hljs-attr">networking:</span><br>  <span class="hljs-attr">serviceSubnet:</span> <span class="hljs-string">&quot;10.66.0.0/16&quot;</span><br>  <span class="hljs-attr">podSubnet:</span> <span class="hljs-string">&quot;10.88.0.1/16&quot;</span><br>  <span class="hljs-attr">dnsDomain:</span> <span class="hljs-string">&quot;cluster.local&quot;</span><br><span class="hljs-attr">apiServer:</span><br>  <span class="hljs-attr">extraArgs:</span><br>    <span class="hljs-attr">v:</span> <span class="hljs-string">&quot;4&quot;</span><br>    <span class="hljs-attr">alsologtostderr:</span> <span class="hljs-string">&quot;true&quot;</span><br><span class="hljs-comment">#    audit-log-maxage: &quot;21&quot;</span><br><span class="hljs-comment">#    audit-log-maxbackup: &quot;10&quot;</span><br><span class="hljs-comment">#    audit-log-maxsize: &quot;100&quot;</span><br><span class="hljs-comment">#    audit-log-path: &quot;/var/log/kube-audit/audit.log&quot;</span><br><span class="hljs-comment">#    audit-policy-file: &quot;/etc/kubernetes/audit-policy.yaml&quot;</span><br>    <span class="hljs-attr">authorization-mode:</span> <span class="hljs-string">&quot;Node,RBAC&quot;</span><br>    <span class="hljs-attr">event-ttl:</span> <span class="hljs-string">&quot;720h&quot;</span><br>    <span class="hljs-attr">runtime-config:</span> <span class="hljs-string">&quot;api/all=true&quot;</span><br>    <span class="hljs-attr">service-node-port-range:</span> <span class="hljs-string">&quot;30000-50000&quot;</span><br>    <span class="hljs-attr">service-cluster-ip-range:</span> <span class="hljs-string">&quot;10.66.0.0/16&quot;</span><br><span class="hljs-comment">#    insecure-bind-address: &quot;0.0.0.0&quot;</span><br><span class="hljs-comment">#    insecure-port: &quot;8080&quot;</span><br>    <span class="hljs-comment"># The fraction of requests that will be closed gracefully(GOAWAY) to prevent</span><br>    <span class="hljs-comment"># HTTP/2 clients from getting stuck on a single apiserver.</span><br>    <span class="hljs-attr">goaway-chance:</span> <span class="hljs-string">&quot;0.001&quot;</span><br><span class="hljs-comment">#  extraVolumes:</span><br><span class="hljs-comment">#  - name: &quot;audit-config&quot;</span><br><span class="hljs-comment">#    hostPath: &quot;/etc/kubernetes/audit-policy.yaml&quot;</span><br><span class="hljs-comment">#    mountPath: &quot;/etc/kubernetes/audit-policy.yaml&quot;</span><br><span class="hljs-comment">#    readOnly: true</span><br><span class="hljs-comment">#    pathType: &quot;File&quot;</span><br><span class="hljs-comment">#  - name: &quot;audit-log&quot;</span><br><span class="hljs-comment">#    hostPath: &quot;/var/log/kube-audit&quot;</span><br><span class="hljs-comment">#    mountPath: &quot;/var/log/kube-audit&quot;</span><br><span class="hljs-comment">#    pathType: &quot;DirectoryOrCreate&quot;</span><br>  <span class="hljs-attr">certSANs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;*.kubernetes.node&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;10.0.0.11&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;10.0.0.12&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;10.0.0.13&quot;</span><br>  <span class="hljs-attr">timeoutForControlPlane:</span> <span class="hljs-string">1m</span><br><span class="hljs-attr">controllerManager:</span><br>  <span class="hljs-attr">extraArgs:</span><br>    <span class="hljs-attr">v:</span> <span class="hljs-string">&quot;4&quot;</span><br>    <span class="hljs-attr">node-cidr-mask-size:</span> <span class="hljs-string">&quot;19&quot;</span><br>    <span class="hljs-attr">deployment-controller-sync-period:</span> <span class="hljs-string">&quot;10s&quot;</span><br>    <span class="hljs-attr">experimental-cluster-signing-duration:</span> <span class="hljs-string">&quot;8670h&quot;</span><br>    <span class="hljs-attr">node-monitor-grace-period:</span> <span class="hljs-string">&quot;20s&quot;</span><br>    <span class="hljs-attr">pod-eviction-timeout:</span> <span class="hljs-string">&quot;2m&quot;</span><br>    <span class="hljs-attr">terminated-pod-gc-threshold:</span> <span class="hljs-string">&quot;30&quot;</span><br><span class="hljs-attr">scheduler:</span><br>  <span class="hljs-attr">extraArgs:</span><br>    <span class="hljs-attr">v:</span> <span class="hljs-string">&quot;4&quot;</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubelet.config.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">KubeletConfiguration</span><br><span class="hljs-attr">failSwapOn:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">oomScoreAdj:</span> <span class="hljs-number">-900</span><br><span class="hljs-attr">cgroupDriver:</span> <span class="hljs-string">&quot;systemd&quot;</span><br><span class="hljs-attr">kubeletCgroups:</span> <span class="hljs-string">&quot;/system.slice/kubelet.service&quot;</span><br><span class="hljs-attr">nodeStatusUpdateFrequency:</span> <span class="hljs-string">5s</span><br><span class="hljs-attr">rotateCertificates:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">evictionSoft:</span><br>  <span class="hljs-attr">&quot;imagefs.available&quot;:</span> <span class="hljs-string">&quot;15%&quot;</span><br>  <span class="hljs-attr">&quot;memory.available&quot;:</span> <span class="hljs-string">&quot;512Mi&quot;</span><br>  <span class="hljs-attr">&quot;nodefs.available&quot;:</span> <span class="hljs-string">&quot;15%&quot;</span><br>  <span class="hljs-attr">&quot;nodefs.inodesFree&quot;:</span> <span class="hljs-string">&quot;10%&quot;</span><br><span class="hljs-attr">evictionSoftGracePeriod:</span><br>  <span class="hljs-attr">&quot;imagefs.available&quot;:</span> <span class="hljs-string">&quot;3m&quot;</span><br>  <span class="hljs-attr">&quot;memory.available&quot;:</span> <span class="hljs-string">&quot;1m&quot;</span><br>  <span class="hljs-attr">&quot;nodefs.available&quot;:</span> <span class="hljs-string">&quot;3m&quot;</span><br>  <span class="hljs-attr">&quot;nodefs.inodesFree&quot;:</span> <span class="hljs-string">&quot;1m&quot;</span><br><span class="hljs-attr">evictionHard:</span><br>  <span class="hljs-attr">&quot;imagefs.available&quot;:</span> <span class="hljs-string">&quot;10%&quot;</span><br>  <span class="hljs-attr">&quot;memory.available&quot;:</span> <span class="hljs-string">&quot;256Mi&quot;</span><br>  <span class="hljs-attr">&quot;nodefs.available&quot;:</span> <span class="hljs-string">&quot;10%&quot;</span><br>  <span class="hljs-attr">&quot;nodefs.inodesFree&quot;:</span> <span class="hljs-string">&quot;5%&quot;</span><br><span class="hljs-attr">evictionMaxPodGracePeriod:</span> <span class="hljs-number">30</span><br><span class="hljs-attr">imageGCLowThresholdPercent:</span> <span class="hljs-number">70</span><br><span class="hljs-attr">imageGCHighThresholdPercent:</span> <span class="hljs-number">80</span><br><span class="hljs-attr">kubeReserved:</span><br>  <span class="hljs-attr">&quot;cpu&quot;:</span> <span class="hljs-string">&quot;500m&quot;</span><br>  <span class="hljs-attr">&quot;memory&quot;:</span> <span class="hljs-string">&quot;512Mi&quot;</span><br>  <span class="hljs-attr">&quot;ephemeral-storage&quot;:</span> <span class="hljs-string">&quot;1Gi&quot;</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubeproxy.config.k8s.io/v1alpha1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">KubeProxyConfiguration</span><br><span class="hljs-comment"># kube-proxy specific options here</span><br><span class="hljs-attr">clusterCIDR:</span> <span class="hljs-string">&quot;10.88.0.1/16&quot;</span><br><span class="hljs-attr">mode:</span> <span class="hljs-string">&quot;ipvs&quot;</span><br><span class="hljs-attr">oomScoreAdj:</span> <span class="hljs-number">-900</span><br><span class="hljs-attr">ipvs:</span><br>  <span class="hljs-attr">minSyncPeriod:</span> <span class="hljs-string">5s</span><br>  <span class="hljs-attr">syncPeriod:</span> <span class="hljs-string">5s</span><br>  <span class="hljs-attr">scheduler:</span> <span class="hljs-string">&quot;wrr&quot;</span><br></code></pre></td></tr></table></figure><p>init 配置具体含义请自行参考官方文档，相对于 init 配置，join 配置比较简单，<strong>不过需要注意的是如果需要 join 为 master 则需要 <code>controlPlane</code> 这部分，否则请注释掉 <code>controlPlane</code>。</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># /etc/kubernetes/kubeadm-join.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubeadm.k8s.io/v1beta2</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">JoinConfiguration</span><br><span class="hljs-attr">controlPlane:</span><br>  <span class="hljs-attr">localAPIEndpoint:</span><br>    <span class="hljs-attr">advertiseAddress:</span> <span class="hljs-string">&quot;10.0.0.12&quot;</span><br>    <span class="hljs-attr">bindPort:</span> <span class="hljs-number">5443</span><br>  <span class="hljs-attr">certificateKey:</span> <span class="hljs-string">31f1e534733a1607e5ba67b2834edd3a7debba41babb1fac1bee47072a98d88b</span><br><span class="hljs-attr">discovery:</span><br>  <span class="hljs-attr">bootstrapToken:</span><br>    <span class="hljs-attr">apiServerEndpoint:</span> <span class="hljs-string">&quot;127.0.0.1:6443&quot;</span><br>    <span class="hljs-attr">token:</span> <span class="hljs-string">&quot;c2t0rj.cofbfnwwrb387890&quot;</span><br>    <span class="hljs-comment"># Please replace with the &quot;--discovery-token-ca-cert-hash&quot; value printed</span><br>    <span class="hljs-comment"># after the kubeadm init command is executed successfully</span><br>    <span class="hljs-attr">caCertHashes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;sha256:97590810ae34a82501717e33acfca76f16044f1a365c5ad9a1c66433c386c75c&quot;</span><br><span class="hljs-attr">nodeRegistration:</span><br>  <span class="hljs-attr">criSocket:</span> <span class="hljs-string">unix:///run/containerd/containerd.sock</span><br>  <span class="hljs-attr">kubeletExtraArgs:</span><br>    <span class="hljs-attr">runtime-cgroups:</span> <span class="hljs-string">&quot;/system.slice/containerd.service&quot;</span><br>    <span class="hljs-attr">rotate-server-certificates:</span> <span class="hljs-string">&quot;true&quot;</span><br></code></pre></td></tr></table></figure><h3 id="2-5、拉起-master"><a href="#2-5、拉起-master" class="headerlink" title="2.5、拉起 master"></a>2.5、拉起 master</h3><p>在调整好配置后，拉起 master 节点只需要一条命令:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubeadm init --config /etc/kubernetes/kubeadm.yaml --upload-certs --ignore-preflight-errors=Swap<br></code></pre></td></tr></table></figure><p>拉起完成后记得保存相关 Token 以便于后续使用。</p><h3 id="2-6、拉起其他-master"><a href="#2-6、拉起其他-master" class="headerlink" title="2.6、拉起其他 master"></a>2.6、拉起其他 master</h3><p>在第一个 master 启动完成后，使用 <code>join</code> 命令让其他 master 加入即可；<strong>需要注意的是 <code>kubeadm-join.yaml</code> 配置中需要替换 <code>caCertHashes</code> 为第一个 master 拉起后的 <code>discovery-token-ca-cert-hash</code> 的值。</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubeadm <span class="hljs-built_in">join</span> 127.0.0.1:6443 --config /etc/kubernetes/kubeadm-join.yaml --ignore-preflight-errors=Swap<br></code></pre></td></tr></table></figure><h3 id="2-7、拉起其他-node"><a href="#2-7、拉起其他-node" class="headerlink" title="2.7、拉起其他 node"></a>2.7、拉起其他 node</h3><p>node 节点拉起与拉起其他 master 节点一样，唯一不同的是需要注释掉配置中的 <code>controlPlane</code> 部分。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># /etc/kubernetes/kubeadm-join.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubeadm.k8s.io/v1beta2</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">JoinConfiguration</span><br><span class="hljs-comment">#controlPlane:</span><br><span class="hljs-comment">#  localAPIEndpoint:</span><br><span class="hljs-comment">#    advertiseAddress: &quot;10.0.0.12&quot;</span><br><span class="hljs-comment">#    bindPort: 5443</span><br><span class="hljs-comment">#  certificateKey: 31f1e534733a1607e5ba67b2834edd3a7debba41babb1fac1bee47072a98d88b</span><br><span class="hljs-attr">discovery:</span><br>  <span class="hljs-attr">bootstrapToken:</span><br>    <span class="hljs-attr">apiServerEndpoint:</span> <span class="hljs-string">&quot;127.0.0.1:6443&quot;</span><br>    <span class="hljs-attr">token:</span> <span class="hljs-string">&quot;c2t0rj.cofbfnwwrb387890&quot;</span><br>    <span class="hljs-comment"># Please replace with the &quot;--discovery-token-ca-cert-hash&quot; value printed</span><br>    <span class="hljs-comment"># after the kubeadm init command is executed successfully</span><br>    <span class="hljs-attr">caCertHashes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;sha256:97590810ae34a82501717e33acfca76f16044f1a365c5ad9a1c66433c386c75c&quot;</span><br><span class="hljs-attr">nodeRegistration:</span><br>  <span class="hljs-attr">criSocket:</span> <span class="hljs-string">unix:///run/containerd/containerd.sock</span><br>  <span class="hljs-attr">kubeletExtraArgs:</span><br>    <span class="hljs-attr">runtime-cgroups:</span> <span class="hljs-string">&quot;/system.slice/containerd.service&quot;</span><br>    <span class="hljs-attr">rotate-server-certificates:</span> <span class="hljs-string">&quot;true&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubeadm <span class="hljs-built_in">join</span> 127.0.0.1:6443 --config /etc/kubernetes/kubeadm-join.yaml --ignore-preflight-errors=Swap<br></code></pre></td></tr></table></figure><h3 id="2-8、其他处理"><a href="#2-8、其他处理" class="headerlink" title="2.8、其他处理"></a>2.8、其他处理</h3><p>由于 kubelet 开启了证书轮转，所以新集群会有大量 csr 请求，批量允许即可:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl get csr | grep Pending | awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs kubectl certificate approve<br></code></pre></td></tr></table></figure><p>同时为了 master 节点也能负载 pod，需要调整污点:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl taint nodes --all node-role.kubernetes.io/master-<br></code></pre></td></tr></table></figure><p>后续 CNI 等不在本文内容范围内。</p><h2 id="三、Containerd-常用操作"><a href="#三、Containerd-常用操作" class="headerlink" title="三、Containerd 常用操作"></a>三、Containerd 常用操作</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 列出镜像</span><br>ctr images <span class="hljs-built_in">ls</span><br><br><span class="hljs-comment"># 列出 k8s 镜像</span><br>ctr -n k8s.io images <span class="hljs-built_in">ls</span><br><br><span class="hljs-comment"># 导入镜像</span><br>ctr -n k8s.io images import xxxx.tar<br><br><span class="hljs-comment"># 导出镜像</span><br>ctr -n k8s.io images <span class="hljs-built_in">export</span> kube-scheduler.tar k8s.gcr.io/kube-scheduler:v1.21.1<br></code></pre></td></tr></table></figure><h2 id="四、资源仓库"><a href="#四、资源仓库" class="headerlink" title="四、资源仓库"></a>四、资源仓库</h2><p>本文中所有 <code>*-pack</code> 仓库地址如下:</p><ul><li><a target="_blank" rel="noopener" href="https://github.com/mritd/cfssl-pack">https://github.com/mritd/cfssl-pack</a></li><li><a target="_blank" rel="noopener" href="https://github.com/mritd/etcd-pack">https://github.com/mritd/etcd-pack</a></li><li><a target="_blank" rel="noopener" href="https://github.com/mritd/kube-apiserver-proxy-pack">https://github.com/mritd/kube-apiserver-proxy-pack</a></li><li><a target="_blank" rel="noopener" href="https://github.com/mritd/kubeadm-config-pack">https://github.com/mritd/kubeadm-config-pack</a></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/kubernetes/" class="category-chain-item">Kubernetes</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/linux/" class="print-no-link">#Linux</a> <a href="/tags/kubernetes/" class="print-no-link">#Kubernetes</a></div></div><div class="license-box my-3"><div class="license-title"><div>Kubernetes 切换到 Containerd</div><div>https://mritd.com/2021/05/29/use-containerd-with-kubernetes/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Kovacs</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2021年5月29日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2021/05/31/golang-check-certificate-expiration-time/" title="Golang 监控 HTTPS 证书过期时间"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Golang 监控 HTTPS 证书过期时间</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2021/05/29/mysql-schema-diff/" title="MySQL 表结构对比"><span class="hidden-mobile">MySQL 表结构对比</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://mritd.com/2021/05/29/use-containerd-with-kubernetes/",this.page.identifier="/2021/05/29/use-containerd-with-kubernetes/"};Fluid.utils.loadComments("#disqus_thread",(function(){var e=document,t=e.createElement("script");t.src="//bleem.disqus.com/embed.js",t.setAttribute("data-timestamp",new Date),(e.head||e.body).appendChild(t)}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-docker"></i> <a href="https://bandwagonhost.com/aff.php?aff=61367" target="_blank" rel="nofollow noopener"><span>BandwagonHost</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!0,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>