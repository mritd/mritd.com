<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Kovacs"><meta name="keywords" content="kubernetes,Longhorn"><meta name="description" content="Longhorn 是 Rancher Labs 开源的一个轻量级云原生微服务化存储方案，本篇文章将详细介绍 Longhorn 安装使用以及其设计架构"><meta property="og:type" content="article"><meta property="og:title" content="Longhorn 微服务化存储初试"><meta property="og:url" content="https://mritd.com/2021/03/06/longhorn-storage-test/index.html"><meta property="og:site_name" content="Kovacs"><meta property="og:description" content="Longhorn 是 Rancher Labs 开源的一个轻量级云原生微服务化存储方案，本篇文章将详细介绍 Longhorn 安装使用以及其设计架构"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mritd.com/img/longhorn.png"><meta property="article:published_time" content="2021-03-06T05:40:22.000Z"><meta property="article:modified_time" content="2021-03-06T05:40:22.000Z"><meta property="article:author" content="Kovacs"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="CSI"><meta property="article:tag" content="Longhorn"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://mritd.com/img/longhorn.png"><meta name="twitter:creator" content="@kovacs_orz"><meta name="twitter:site" content="https://twitter.com/kovacs_orz"><title>Longhorn 微服务化存储初试 - Kovacs</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"mritd.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!0,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:"G-H06NPECR0Z"},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-H06NPECR0Z",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-H06NPECR0Z")}))</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Kovacs" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="Kovacs" type="application/rss+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Kovacs</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/friends/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Longhorn 微服务化存储初试"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Kovacs </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-03-06 13:40" pubdate>2021年3月6日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.1k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 26 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">Longhorn 微服务化存储初试</h1><div class="markdown-body"><h2 id="一、Longhorn-安装"><a href="#一、Longhorn-安装" class="headerlink" title="一、Longhorn 安装"></a>一、Longhorn 安装</h2><h3 id="1-1、准备工作"><a href="#1-1、准备工作" class="headerlink" title="1.1、准备工作"></a>1.1、准备工作</h3><p>Longhorn 官方推荐的最小配置如下，如果数据并不算太重要可适当缩减和调整，具体请自行斟酌:</p><ul><li>3 Nodes</li><li>4 vCPUs per Node</li><li>4 GiB per Node</li><li>SSD&#x2F;NVMe or similar performance block device on the node for storage(We don’t recommend using spinning disks with Longhorn, due to low IOPS.)</li></ul><p>本次安装测试环境如下:</p><ul><li>Ubuntu 20.04(8c16g)</li><li>Disk 200g</li><li>Kubernetes 1.20.4(kubeadm)</li><li>Longhorn 1.1.0</li></ul><h3 id="1-2、安装-Longhorn-Helm"><a href="#1-2、安装-Longhorn-Helm" class="headerlink" title="1.2、安装 Longhorn(Helm)"></a>1.2、安装 Longhorn(Helm)</h3><p>安装 Longhorn 推荐使用 Helm，因为在卸载时 kubectl 无法直接使用 delete 卸载，需要进行其他清理工作；helm 安装命令如下:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># add Longhorn repo</span><br>helm repo add longhorn https://charts.longhorn.io<br><br><span class="hljs-comment"># update</span><br>helm repo update<br><br><span class="hljs-comment"># create namespace</span><br>kubectl create namespace longhorn-system<br><br><span class="hljs-comment"># install</span><br>helm install longhorn longhorn/longhorn --namespace longhorn-system --values longhorn-values.yaml<br></code></pre></td></tr></table></figure><p>其中 <code>longhorn-values.yaml</code> 请从 <a target="_blank" rel="noopener" href="https://github.com/longhorn/charts/blob/longhorn-1.1.0/charts/longhorn/values.yaml">Charts 仓库</a> 下载，本文仅修改了以下两项:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">defaultSettings:</span><br>  <span class="hljs-comment"># 默认存储目录(默认为 /var/lib/longhorn)</span><br>  <span class="hljs-attr">defaultDataPath:</span> <span class="hljs-string">&quot;/data/longhorn&quot;</span><br>  <span class="hljs-comment"># 默认副本数量</span><br>  <span class="hljs-attr">defaultReplicaCount:</span> <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>安装完成后 Pod 运行情况如下所示:</p><p><img src="https://cdn.oss.link/markdown/M5ZYyb1614931770247.png" srcset="/img/loading.gif" lazyload alt="M5ZYyb1614931770247"></p><p>此后可通过集群 Ingress 或者 NodePort 等方式暴露 service <code>longhorn-frontend</code> 的 80 端口来访问 Longhorn UI；<strong>注意，Ingress 等负载均衡其如果采用 HTTPS 访问请确保向 Longhorn UI 传递了 <code>X-Forwarded-Proto: https</code> 头，否则可能导致 Websocket 不安全链接以及跨域等问题，后果就是 UI 出现一些神奇的小问题(我排查了好久…)。</strong></p><p><img src="https://cdn.oss.link/markdown/vIFU281614931897632.png" srcset="/img/loading.gif" lazyload alt="vIFU281614931897632"></p><h3 id="1-3、卸载-Longhorn"><a href="#1-3、卸载-Longhorn" class="headerlink" title="1.3、卸载 Longhorn"></a>1.3、卸载 Longhorn</h3><p>如果在安装过程中有任何操作错误，或想重新安装验证相关设置，可通过以下命令卸载 Longhorn:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 卸载</span><br>helm uninstall longhorn -n longhorn-system<br></code></pre></td></tr></table></figure><h2 id="二、Longhorn-架构"><a href="#二、Longhorn-架构" class="headerlink" title="二、Longhorn 架构"></a>二、Longhorn 架构</h2><h3 id="2-1、Design"><a href="#2-1、Design" class="headerlink" title="2.1、Design"></a>2.1、Design</h3><p>Longhorn 总体设计分为两层: <strong>数据平面和控制平面</strong>；Longhorn Engine 是一个存储控制器，对应数据平面；Longhorn Manager 对应控制平面。</p><h4 id="2-1-1、Longhorn-Manager"><a href="#2-1-1、Longhorn-Manager" class="headerlink" title="2.1.1、Longhorn Manager"></a>2.1.1、Longhorn Manager</h4><p>Longhorn Manager 使用 Operator 模式，作为 Daemonset 运行在每个节点上；Longhorn Manager 负责接收 Longhorn UI 以及 Kubernetes Volume 插件的 API 调用，然后创建和管理 Volume；</p><p>Longhorn Manager 在与 kubernetes API 通信并创建 Longhorn Volume CRD(heml 安装直接创建了相关 CRD，查看代码后发现 Manager 里面似乎也会判断并创建一下)，此后 Longhorn Manager watch 相关 CRD 资源和 Kubernetes 原生资源(PV&#x2F;PVC…)，一但集群内创建了 Longhorn Volume 则 Longhorn Manager 负责创建物理 Volume。</p><p>当 Longhorn Manager 创建 Volume 时，Longhorn Manager 首先会在 Volume 所在节点创建 Longhorn Engine 实例(对比实际行为后发现所谓的 “实例” 其实只是运行了一个 Linux 进程，并非创建 Pod)，然后根据副本数量在所需放置副本的节点上创建对应的副本。</p><h4 id="2-1-2、Longhorn-Engine"><a href="#2-1-2、Longhorn-Engine" class="headerlink" title="2.1.2、Longhorn Engine"></a>2.1.2、Longhorn Engine</h4><p>Longhorn Engine 始终与其使用 Volume 的 Pod 在同一节点上，它跨存储在多个节点上的多个副本同步复制卷；同时数据的多路径保证 Longhorn Volume 的 HA，单个副本或者 Engine 出现问题不会影响到所有副本或 Pod 对 Volume 的访问。</p><p>下图中展示了 Longhorn 的 HA 架构，每个 Kubernetes Volume 将会对应一个 Longhorn Engine，每个 Engine 管理 Volume 的多个副本，Engine 与 副本实质都会是一个单独的 Linux 进程运行:</p><p><img src="https://cdn.oss.link/markdown/Yxljct1614932095536.png" srcset="/img/loading.gif" lazyload alt="Yxljct1614932095536"></p><p><strong>注意: 图中的 Engine 并非是单独的一个 Pod，而是每一个 Volume 会对应一个 golang exec 出来的 Linux 进程。</strong></p><h3 id="2-2、CSI-Plugin"><a href="#2-2、CSI-Plugin" class="headerlink" title="2.2、CSI Plugin"></a>2.2、CSI Plugin</h3><p>CSI 部分不做过多介绍，具体参考 <a href="https://mritd.com/2020/08/19/how-to-write-a-csi-driver-for-kubernetes/">如何编写 CSI 插件</a>；以下为简要说明:</p><ul><li>Kubernetes CSI 被抽象为具体的 CSI 容器并通过 gRPC 调用目标 plugin</li><li>Longhorn CSI Plugin 负责接收标准 CSI 容器发起的 gRPC 调用</li><li>Longhorn CSI Plugin 将 Kubernetes CSI gRPC 调用转换为自己的 Longhorn API 调用，并将其转发到 Longhorn Manager 控制平面</li><li>Longhorn 某些功能使用了 iSCSI，所以可能需要在节点上安装 open-iscsi 或 iscsiadm</li></ul><h3 id="2-3、Longhorn-UI"><a href="#2-3、Longhorn-UI" class="headerlink" title="2.3、Longhorn UI"></a>2.3、Longhorn UI</h3><p>Longhorn UI 向外暴露一个 Dashboard，并用过 Longhorn API 与 Longhorn Manager 控制平面交互；Longhorn UI 在架构上类似于 Longhorn CSI Plugin 的替代者，只不过一个是通过 Web UI 转化为 Longhorn API，另一个是将 CSI gRPC 转换为 Longhorn API。</p><h3 id="2-4、Replicas-And-Snapshots"><a href="#2-4、Replicas-And-Snapshots" class="headerlink" title="2.4、Replicas And Snapshots"></a>2.4、Replicas And Snapshots</h3><p>在 Longhorn 微服务架构中，副本也作为单独的进程运行，其实质存储文件采用 Linux 的稀释文件方式；每个副本均包含 Longhorn Volume 的快照链，快照就像一个 Image 层，其中最旧的快照用作基础层，而较新的快照位于顶层。如果数据会覆盖旧快照中的数据，则仅将其包含在新快照中；整个快照链展示了数据的当前状态。</p><p>在进行快照时，Longhorn 会创建差异磁盘(differencing disk)文件，每个差异磁盘文件被看作是一个快照，当 Longhorn 读取文件时从上层开始依次查找，其示例图如下:</p><p><img src="https://cdn.oss.link/markdown/tOvsJ91614932116138.jpg" srcset="/img/loading.gif" lazyload alt="tOvsJ91614932116138"></p><p><strong>为了提高读取性能，Longhorn 维护了一个读取索引，该索引记录了每个 4K 存储块中哪个差异磁盘包含有效数据；读取索引会占用一定的内存，每个 4K 块占用一个字节，字节大小的读取索引意味着每个卷最多可以拍摄 254 个快照，在大约 1TB 的卷中读取索引大约会消耗256MB 的内存。</strong></p><h3 id="2-5、Backups-and-Secondary-Storage"><a href="#2-5、Backups-and-Secondary-Storage" class="headerlink" title="2.5、Backups and Secondary Storage"></a>2.5、Backups and Secondary Storage</h3><p>由于数据大小、网络延迟等限制，跨区域同步复制无法做到很高的时效性，所以 Longhorn 提供了称之为 Secondary Storage 的备份方案；Secondary Storage 依赖外部的 NFS、S3 等存储设施，一旦在 Longhorn 中配置了 Backup Storage，Longhorn 将会通过卷的指定版本快照完成备份；<strong>备份过程中 Longhorn 将会抹平快照信息，这意味着快照历史变更将会丢失，相同的原始卷备份是增量的，通过不断的应用差异磁盘文件完成；为了避免海量小文件带来的性能瓶颈，Longhorn 采用 2MB 分块进行备份，任何边界内 4k 块变动都会触发 2MB 块的备份行为；Longhorn 的备份功能为跨集群、跨区域提供完善的灾难恢复机制。</strong>Longhorn 备份机制如下图所示:</p><p><img src="https://cdn.oss.link/markdown/6EShuz1614932147884.jpg" srcset="/img/loading.gif" lazyload alt="6EShuz1614932147884"></p><h3 id="2-6、Longhorn-Pods"><a href="#2-6、Longhorn-Pods" class="headerlink" title="2.6、Longhorn Pods"></a>2.6、Longhorn Pods</h3><p>上面的大部分其实来源于对官方文档 <a target="_blank" rel="noopener" href="https://longhorn.io/docs/1.1.0/concepts/">Architecture and Concepts</a> 的翻译；在翻译以及阅读文档过程中，通过对比文档与实际行为，还有阅读源码发现了一些细微差异，这里着重介绍一下这些 Pod 都是怎么回事:</p><p><img src="https://cdn.oss.link/markdown/1EUF4y-1615008575-QcVGUt.png" srcset="/img/loading.gif" lazyload alt="1EUF4y-1615008575-QcVGUt"></p><h4 id="2-6-1、longhorn-manager"><a href="#2-6-1、longhorn-manager" class="headerlink" title="2.6.1、longhorn-manager"></a>2.6.1、longhorn-manager</h4><p>longhorn-manager 与文档描述一致，其通过 Helm 安装时直接以 Daemonset 方式 Create 出来，然后 longhorn-manager 开启 HTTP API(9500) 等待其他组件请求；<strong>同时 longhorn-manager 还会使用 Operator 模式监听各种资源，包括不限于 Longhorn CRD 以及集群的 PV(C) 等资源，然后作出对应的响应。</strong></p><h4 id="2-6-2、longhorn-driver-deployer"><a href="#2-6-2、longhorn-driver-deployer" class="headerlink" title="2.6.2、longhorn-driver-deployer"></a>2.6.2、longhorn-driver-deployer</h4><p>Helm 安装时创建了 longhorn-driver-deployer Deployment，longhorn-driver-deployer 实际上也是 longhorn-manager 镜像启动，只不过启动后会沟通 longhorn-manager HTTP API，然后创建所有 CSI 相关容器，包括 <code>csi-provisioner</code>、<code>csi-snapshotter</code>、<code>longhorn-csi-plugin</code> 等。</p><h4 id="2-6-3、instance-manager-e"><a href="#2-6-3、instance-manager-e" class="headerlink" title="2.6.3、instance-manager-e"></a>2.6.3、instance-manager-e</h4><p>上面所说的每个 Engine 对应一个 Linux 进程其实就是通过这个 Pod 完成的，<strong>instance-manager-e 由 longhorn-manager 创建，创建完成后 instance-manager-e 监听 gRPC 8500 端口，其只要职责就是接收 gRPC 请求，并启动 Engine 进程；从上面我们 Engine 介绍可以得知 Engine 与 Volume 绑定，所以理论上集群内 Volume 被创建时有某个 “东西” 创建了 CRD <code>engines.longhorn.io</code>，然后又有人 watch 了 <code>engines.longhorn.io</code> 并通知 instance-manager-e 启动 Engine 进程；这里不负责任的推测是 longhorn-manager 干的，但是没看代码不敢说死…</strong></p><p><img src="https://cdn.oss.link/markdown/hfk9uQ1614943191222.png" srcset="/img/loading.gif" lazyload alt="hfk9uQ1614943191222"></p><p>同理 <code>instance-manager-r</code> 是负责启动副本的 Linux 进程的，工作原理与 <code>instance-manager-e</code> 相同，通过简单的查看代码(IDE 没打开…哈哈哈)推测，<code>instance-manager-e/-r</code> 应该是 longhorn-manager Operator 下的产物，其维护了一个自己的 “Daemonset”，但是 kubectl 是看不到的。</p><h4 id="2-6-4、longhorn-ui"><a href="#2-6-4、longhorn-ui" class="headerlink" title="2.6.4、longhorn-ui"></a>2.6.4、longhorn-ui</h4><p>longhorn-ui 很简单，就是个 UI 界面，然后 HTTP API 沟通 longhorn-manager，这里不再做过多说明。</p><h2 id="三、Longhorn-使用"><a href="#三、Longhorn-使用" class="headerlink" title="三、Longhorn 使用"></a>三、Longhorn 使用</h2><h3 id="3-1、常规使用"><a href="#3-1、常规使用" class="headerlink" title="3.1、常规使用"></a>3.1、常规使用</h3><p>默认情况下 Helm 安装完成后会自动创建 StorageClass，如果集群中只有 Longhorn 作为存储，那么 Longhorn 的 StorageClass 将作为默认 StorageClass。关于 StorageClass、PV、PVC 如果使用这里不做过多描述，请参考官方 <a target="_blank" rel="noopener" href="https://longhorn.io/docs/1.1.0/references/examples/">Example</a> 文档；</p><p><strong>需要注意的是 Longhorn 作为块存储仅支持 <code>ReadWriteOnce</code> 模式，如果想支持 <code>ReadWriteMany</code> 模式，则需要在节点安装 <code>nfs-common</code>，Longhorn 将会自动创建 <code>share-manager</code> 容器然后通过 NFSV4 共享这个 Volume 从而实现 <code>ReadWriteMany</code>；</strong>具体请参考 <a target="_blank" rel="noopener" href="https://longhorn.io/docs/1.1.0/advanced-resources/rwx-workloads/">Support for ReadWriteMany (RWX) workloads</a>。</p><h3 id="3-2、添加删除磁盘"><a href="#3-2、添加删除磁盘" class="headerlink" title="3.2、添加删除磁盘"></a>3.2、添加删除磁盘</h3><p>如果出现磁盘损坏重建或者添加删除磁盘，请直接访问 UI 界面，通过下拉菜单操作即可；在操作前请将节点调整到维护模式并驱逐副本，具体请参考 <a target="_blank" rel="noopener" href="https://longhorn.io/docs/1.1.0/volumes-and-nodes/disks-or-nodes-eviction/">Evicting Replicas on Disabled Disks or Nodes</a>。</p><p><img src="https://cdn.oss.link/markdown/0tedBl1614945096177.png" srcset="/img/loading.gif" lazyload alt="0tedBl1614945096177"></p><p><strong>需要注意的是添加新磁盘时，磁盘挂载的软连接路径不能工作，请使用原始挂载路径或通过 <code>mount --bind</code> 命令设置新路径。</strong></p><p><img src="https://cdn.oss.link/markdown/Ps8QRR1614945234562.png" srcset="/img/loading.gif" lazyload alt="Ps8QRR1614945234562"></p><h3 id="3-3、创建快照及回滚"><a href="#3-3、创建快照及回滚" class="headerlink" title="3.3、创建快照及回滚"></a>3.3、创建快照及回滚</h3><p>当创建好 Volume 以后可以用过 Longhorn UI 在线对 Volume 创建快照，<strong>但是回滚快照过程需要 Workload(Pod) 离线，同时 Volume 必须以维护模式 reattach 到某一个 Host 节点上，然后在 Longhorn UI 进行调整；</strong>以下为快照创建回滚测试:</p><p><strong>test.pvc.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">longhorn-simple-pvc</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">longhorn</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">1Gi</span><br></code></pre></td></tr></table></figure><p><strong>test.po.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">longhorn-simple-pod</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span><br>  <span class="hljs-attr">containers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">volume-test</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:stable-alpine</span><br>      <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>      <span class="hljs-attr">livenessProbe:</span><br>        <span class="hljs-attr">exec:</span><br>          <span class="hljs-attr">command:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">ls</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">/data/lost+found</span><br>        <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span><br>        <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>      <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">volv</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/data</span><br>      <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>  <span class="hljs-attr">volumes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">volv</span><br>      <span class="hljs-attr">persistentVolumeClaim:</span><br>        <span class="hljs-attr">claimName:</span> <span class="hljs-string">longhorn-simple-pvc</span><br></code></pre></td></tr></table></figure><h4 id="3-3-1、创建快照"><a href="#3-3-1、创建快照" class="headerlink" title="3.3.1、创建快照"></a>3.3.1、创建快照</h4><p>首先创建相关资源:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl create -f test.pvc.yaml<br>kubectl create -f test.po.yaml<br></code></pre></td></tr></table></figure><p>创建完成后在 Longhorn UI 中可以看到刚刚创建出的 Volume:</p><p><img src="https://cdn.oss.link/markdown/L3hnYi-1615000011-UBMIEE.png" srcset="/img/loading.gif" lazyload alt="L3hnYi-1615000011-UBMIEE"></p><p>点击 Name 链接进入到 Volume 详情，然后点击 <code>Take Snapshot</code> 按钮即可拍摄快照；<strong>有些情况下 UI 响应缓慢可能导致 <code>Take Snapshot</code> 按钮变灰，刷新两次即可恢复。</strong></p><p><img src="https://cdn.oss.link/markdown/TkKNCz-1615001806-jjaakH.png" srcset="/img/loading.gif" lazyload alt="TkKNCz-1615001806-jjaakH"></p><p>快照在回滚后仍然可以进行交叉创建</p><p><img src="https://cdn.oss.link/markdown/ykQs66-1615002223-B2Z9Sa.png" srcset="/img/loading.gif" lazyload alt="ykQs66-1615002223-B2Z9Sa"></p><h4 id="3-3-2、回滚快照"><a href="#3-3-2、回滚快照" class="headerlink" title="3.3.2、回滚快照"></a>3.3.2、回滚快照</h4><p><strong>回滚快照时必须停止 Pod:</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 停止</span><br>kubectl delete -f test.po.yaml<br></code></pre></td></tr></table></figure><p><strong>然后重新将 Volume Attach 到宿主机:</strong></p><p><img src="https://cdn.oss.link/markdown/uuAFT8-1615001937-bGA3Sq.png" srcset="/img/loading.gif" lazyload alt="uuAFT8-1615001937-bGA3Sq"></p><p><strong>注意要开启维护模式</strong></p><p><img src="https://cdn.oss.link/markdown/bFcbW3-1615002020-Q8nG15.png" srcset="/img/loading.gif" lazyload alt="bFcbW3-1615002020-Q8nG15"></p><p>稍等片刻等待所有副本 “Running” 然后 Revert 即可</p><p><img src="https://cdn.oss.link/markdown/xLZdSP-1615002098-p8sueg.png" srcset="/img/loading.gif" lazyload alt="xLZdSP-1615002098-p8sueg"></p><p>回滚完成后，需要 Detach Volume，以便供重新创建的 Pod 使用</p><p><img src="https://cdn.oss.link/markdown/JYZZLe-1615002351-x6A6TE.png" srcset="/img/loading.gif" lazyload alt="JYZZLe-1615002351-x6A6TE"></p><h4 id="3-3-3、定时快照"><a href="#3-3-3、定时快照" class="headerlink" title="3.3.3、定时快照"></a>3.3.3、定时快照</h4><p>除了手动创建快照之外，Longhorn 还支持定时对 Volume 进行快照处理；要使用定时任务，请进入 Volume 详情页面，在 <code>Recurring Snapshot and Backup Schedule</code> 选项卡下新增定时任务即可:</p><p><img src="https://cdn.oss.link/markdown/iUpPnA-1615006838-wM4tBA.png" srcset="/img/loading.gif" lazyload alt="iUpPnA-1615006838-wM4tBA"></p><p><strong>如果不想为内核 Volume 都手动设置自动快照，可以用过调整 StorageClass 来实现为每个自动创建的 PV 进行自动快照，具体请阅读 <a target="_blank" rel="noopener" href="https://longhorn.io/docs/1.1.0/snapshots-and-backups/scheduling-backups-and-snapshots/#set-up-recurring-jobs-using-a-storageclass">Set up Recurring Jobs using a StorageClass</a> 文档。</strong></p><h3 id="3-4、Volume-扩容"><a href="#3-4、Volume-扩容" class="headerlink" title="3.4、Volume 扩容"></a>3.4、Volume 扩容</h3><p>Longhorn 支持对 Volume 进行扩容，扩容方式和回滚快照类似，都需要 Deacth Volume 并开启维护模式。</p><p><strong>首先停止 Workload</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs sh">➜ ~ kubectl <span class="hljs-built_in">exec</span> -it longhorn-simple-pod -- <span class="hljs-built_in">df</span> -h<br>Filesystem                Size      Used Available Use% Mounted on<br>overlay                 199.9G      4.7G    195.2G   2% /<br>tmpfs                    64.0M         0     64.0M   0% /dev<br>tmpfs                     7.8G         0      7.8G   0% /sys/fs/cgroup<br>/dev/longhorn/pvc-1c9e23f4-af29-4a48-9560-87983267b8d3<br>                        975.9M      2.5M    957.4M   0% /data<br>/dev/sda4                60.0G      7.7G     52.2G  13% /etc/hosts<br>/dev/sda4                60.0G      7.7G     52.2G  13% /dev/termination-log<br>/dev/sdc1               199.9G      4.7G    195.2G   2% /etc/hostname<br>/dev/sdc1               199.9G      4.7G    195.2G   2% /etc/resolv.conf<br>shm                      64.0M         0     64.0M   0% /dev/shm<br>tmpfs                     7.8G     12.0K      7.8G   0% /run/secrets/kubernetes.io/serviceaccount<br>tmpfs                     7.8G         0      7.8G   0% /proc/acpi<br>tmpfs                    64.0M         0     64.0M   0% /proc/kcore<br>tmpfs                    64.0M         0     64.0M   0% /proc/keys<br>tmpfs                    64.0M         0     64.0M   0% /proc/timer_list<br>tmpfs                    64.0M         0     64.0M   0% /proc/sched_debug<br>tmpfs                     7.8G         0      7.8G   0% /proc/scsi<br>tmpfs                     7.8G         0      7.8G   0% /sys/firmware<br><br>➜ ~ kubectl delete -f test.po.yaml<br>pod <span class="hljs-string">&quot;longhorn-simple-pod&quot;</span> deleted<br></code></pre></td></tr></table></figure><p><strong>然后直接使用 <code>kubectl</code> 编辑 PVC，调整 <code>spec.resources.requests.storage</code></strong></p><p><img src="https://cdn.oss.link/markdown/LT9aSo-1615006002-L1veZr.png" srcset="/img/loading.gif" lazyload alt="LT9aSo-1615006002-L1veZr"></p><p>保存后可以从 Longhorn UI 中看到 Volume 在自动 resize</p><p><img src="https://cdn.oss.link/markdown/zG4ugo-1615006070-f7POdb.png" srcset="/img/loading.gif" lazyload alt="zG4ugo-1615006070-f7POdb"></p><p>重新创建 Workload 可以看到 Volume 已经扩容成功</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs sh">➜ ~ kubectl create -f test.po.yaml<br>pod/longhorn-simple-pod created<br><br>➜ ~ kubectl <span class="hljs-built_in">exec</span> -it longhorn-simple-pod -- <span class="hljs-built_in">df</span> -h<br>Filesystem                Size      Used Available Use% Mounted on<br>overlay                 199.9G      6.9G    193.0G   3% /<br>tmpfs                    64.0M         0     64.0M   0% /dev<br>tmpfs                     7.8G         0      7.8G   0% /sys/fs/cgroup<br>/dev/longhorn/pvc-1c9e23f4-af29-4a48-9560-87983267b8d3<br>                          4.9G      4.0M      4.9G   0% /data<br>/dev/sda4                60.0G      7.6G     52.4G  13% /etc/hosts<br>/dev/sda4                60.0G      7.6G     52.4G  13% /dev/termination-log<br>/dev/sdc1               199.9G      6.9G    193.0G   3% /etc/hostname<br>/dev/sdc1               199.9G      6.9G    193.0G   3% /etc/resolv.conf<br>shm                      64.0M         0     64.0M   0% /dev/shm<br>tmpfs                     7.8G     12.0K      7.8G   0% /run/secrets/kubernetes.io/serviceaccount<br>tmpfs                     7.8G         0      7.8G   0% /proc/acpi<br>tmpfs                    64.0M         0     64.0M   0% /proc/kcore<br>tmpfs                    64.0M         0     64.0M   0% /proc/keys<br>tmpfs                    64.0M         0     64.0M   0% /proc/timer_list<br>tmpfs                    64.0M         0     64.0M   0% /proc/sched_debug<br>tmpfs                     7.8G         0      7.8G   0% /proc/scsi<br>tmpfs                     7.8G         0      7.8G   0% /sys/firmware<br></code></pre></td></tr></table></figure><p><strong>Volume 扩展过程中 Longhorn 会自动处理文件系统相关调整，但是并不是百分百会处理，一般 Longhorn 仅在以下情况做自动处理：</strong></p><ul><li>扩展后大小大约当前大小(进行扩容)</li><li>Longhorn Volume 中存在一个 Linux 文件系统</li><li>Longhorn Volume 中的 Linux 文件系统为 ext4 或 xfs</li><li>Longhorn Volume 使用 <code>block device</code> 作为 frontend</li></ul><p>非这几种情况外，如还原到更小容量的 Snapshot，可能需要手动调整文件系统，具体请参考 <a target="_blank" rel="noopener" href="https://longhorn.io/docs/1.1.0/volumes-and-nodes/expansion/#filesystem-expansion">Filesystem expansion</a> 章节文档。</p><h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p>总体来说目前 Longhorn 是一个比较清量级的存储解决方案，微服务化使其更加可靠，同时官方文档完善社区响应也比较迅速；最主要的是 Longhorn 采用的技术方案不会过于复杂，通过文档以及阅读源码至少可以比较快速的了解其背后实现，而反观一些其他大型存储要么文档不全，要么实现技术复杂，普通用户很难窥视其核心；综合来说在小型存储选择上比较推荐 Longhorn，至于稳定性么，很不负责的说我也不知道，毕竟我也是新手，备份还没折腾呢…</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/kubernetes/" class="category-chain-item">Kubernetes</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/kubernetes/" class="print-no-link">#Kubernetes</a> <a href="/tags/csi/" class="print-no-link">#CSI</a> <a href="/tags/longhorn/" class="print-no-link">#Longhorn</a></div></div><div class="license-box my-3"><div class="license-title"><div>Longhorn 微服务化存储初试</div><div>https://mritd.com/2021/03/06/longhorn-storage-test/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Kovacs</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2021年3月6日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2021/05/29/mysql-schema-diff/" title="MySQL 表结构对比"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">MySQL 表结构对比</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2021/01/07/lets-start-using-caddy2/" title="Caddy2 简明教程"><span class="hidden-mobile">Caddy2 简明教程</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://mritd.com/2021/03/06/longhorn-storage-test/",this.page.identifier="/2021/03/06/longhorn-storage-test/"};Fluid.utils.loadComments("#disqus_thread",(function(){var t=document,e=t.createElement("script");e.src="//bleem.disqus.com/embed.js",e.setAttribute("data-timestamp",new Date),(t.head||t.body).appendChild(e)}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-docker"></i> <a href="https://bandwagonhost.com/aff.php?aff=61367" target="_blank" rel="nofollow noopener"><span>BandwagonHost</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!0,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>