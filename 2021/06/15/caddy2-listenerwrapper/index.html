<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Kovacs"><meta name="keywords" content="Caddy,Caddy2,ListenerWrapper"><meta name="description" content="最近分析了一下 Caddy2 的 ListenerWrapper，觉得很厉害索性写下来"><meta property="og:type" content="article"><meta property="og:title" content="Caddy2 的 ListenerWrapper"><meta property="og:url" content="https://mritd.com/2021/06/15/caddy2-listenerwrapper/index.html"><meta property="og:site_name" content="Kovacs"><meta property="og:description" content="最近分析了一下 Caddy2 的 ListenerWrapper，觉得很厉害索性写下来"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mritd.com/img/caddy.jpg"><meta property="article:published_time" content="2021-06-15T06:04:00.000Z"><meta property="article:modified_time" content="2021-06-15T06:04:00.000Z"><meta property="article:author" content="Kovacs"><meta property="article:tag" content="Caddy"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://mritd.com/img/caddy.jpg"><meta name="twitter:creator" content="@kovacs_orz"><meta name="twitter:site" content="https://twitter.com/kovacs_orz"><title>Caddy2 的 ListenerWrapper - Kovacs</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"mritd.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!0,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:"G-H06NPECR0Z"},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-H06NPECR0Z",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-H06NPECR0Z")}))</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Kovacs" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="Kovacs" type="application/rss+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Kovacs</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/friends/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Caddy2 的 ListenerWrapper"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Kovacs </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-06-15 14:04" pubdate>2021年6月15日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 1.3k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 11 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">Caddy2 的 ListenerWrapper</h1><div class="markdown-body"><blockquote><p>本文所有源码分析基于 Caddy2 v2.4.2 版本进行，未来版本可能源码会有变化，阅读本文时请自行将源码切换到 v2.4.2 版本。</p></blockquote><h2 id="一、这玩意是什么？"><a href="#一、这玩意是什么？" class="headerlink" title="一、这玩意是什么？"></a>一、这玩意是什么？</h2><p>Caddy2 对配置文件中的 <code>listener_wrappers</code> 配置有以下描述:</p><blockquote><p>Allows configuring listener wrappers, which can modify the behaviour of the base listener. They are applied in the given order.</p></blockquote><p>同时对于 <code>tls</code> 这个 <code>listener_wrappers</code> 还做了一下说明:</p><blockquote><p>There is a special no-op tls listener wrapper provided as a standard module which marks where TLS should be handled in the chain of listener wrappers. It should only be used if another listener wrapper must be placed in front of the TLS handshake.</p></blockquote><p>综上所述，简单的理解就是 <code>listener_wrappers</code> 在 Caddy2 中用于改变链接行为，这个行为可以理解为我们可以自定义接管链接，这些 “接管” 更偏向于底层，比如在 TLS 握手之前做点事情或者在 TLS 握手之后做点事情，这样我们就可以实现一些魔法操作。</p><h2 id="二、加载与初始化"><a href="#二、加载与初始化" class="headerlink" title="二、加载与初始化"></a>二、加载与初始化</h2><p>在 Caddy2 启动时首先会进行配置文件解析，例如解析 Caddyfile、json 等格式的配置文件，<code>listener_wrappers</code> 在配置文件中被定义为一个 <code>ServerOption</code>:</p><p><strong><a target="_blank" rel="noopener" href="https://github.com/caddyserver/caddy/blob/v2.4.2/caddyconfig/httpcaddyfile/serveroptions.go#L47">caddyconfig&#x2F;httpcaddyfile&#x2F;serveroptions.go:47</a></strong></p><p><img src="https://cdn.oss.link/markdown/s7XueV.jpg" srcset="/img/loading.gif" lazyload></p><p>该配置最终会被注入到 Server 的 listenerWrappers 属性中(先解析为 <code>ListenerWrappersRaw</code> 然后再实例化)</p><p><strong><a target="_blank" rel="noopener" href="https://github.com/caddyserver/caddy/blob/v2.4.2/modules/caddyhttp/server.go#L132">modules&#x2F;caddyhttp&#x2F;server.go:132</a></strong></p><p><img src="https://cdn.oss.link/markdown/vs5icq.jpg" srcset="/img/loading.gif" lazyload></p><p>最后在 App 的启动过程中遍历 listenerWrappers 并逐个应用，在应用 <code>listenerWrappers</code> 时有个比较重要的顺序处理:</p><p><strong>首先 Caddy2 会尝试在 <code>net.Listener</code> 上应用一部分 <code>listenerWrappers</code>，当触及到 <code>tls</code> 这个 token 的 <code>listenerWrappers</code> 之后终止应用；终止前已被应用的这部分 <code>listenerWrappers</code> 被认为是 TLS 握手之前的自定义处理，然后在 TLS 握手之后再次应用剩下的 <code>listenerWrappers</code>，后面这部分被认为是 TLS 握手之后的自定义处理。</strong></p><p><strong><a target="_blank" rel="noopener" href="https://github.com/caddyserver/caddy/blob/v2.4.2/modules/caddyhttp/app.go#L318">modules&#x2F;caddyhttp&#x2F;app.go:318</a></strong><br><img src="https://cdn.oss.link/markdown/6KQipF.jpg" srcset="/img/loading.gif" lazyload></p><p>最终对 ListenerWrapper 加载流程分析如下:</p><ul><li>首先解析配置文件，并将配置转化为 Server 的 <code>ListenerWrappersRaw []json.RawMessage</code></li><li>然后通过 <code>ctx.LoadModule(srv, &quot;ListenerWrappersRaw&quot;)</code> 实例化 ListenerWrapper</li><li>在 <code>ctx.LoadModule</code> 时，如果发现了 <code>tls</code> 指令则按照配置文件顺序排序 ListenerWrapper 切片，否则将 <code>tls</code> 这个特殊的 ListenerWrapper 放在首位；<strong>这意味着在配置中不写 <code>tls</code> 时，所有 ListenerWrapper 永远处于 TLS 握手之后</strong></li><li>最后在 App 启动时按照切片顺序应用 ListenerWrapper，需要注意的是 ListenerWrapper 接口针对的是 <code>net.Listener</code> 的处理，其底层是 <code>net.Conn</code>；<strong>这意味着 ListenerWrapper 不会对 UDP(<code>net.PacketConn</code>) 做处理，代码中也可以看到 ListenerWrapper 并未对 HTTP3 处理</strong></li></ul><h2 id="三、具体实际应用"><a href="#三、具体实际应用" class="headerlink" title="三、具体实际应用"></a>三、具体实际应用</h2><p>说了半天，也分析了源码，那么最终回到问题原点: <strong>ListenerWrapper 能干什么？</strong>答案就是自定义协议，例如神奇的 <a target="_blank" rel="noopener" href="https://github.com/imgk/caddy-trojan">caddy-trojan</a> 插件。</p><p>caddy-trojan 插件实现了 ListenerWrapper，在 App 启动时通过源码可以看到，<strong>TLS 握手完成后原始的 TCP 链接将交由这个 ListenerWrapper 处理:</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// finish wrapping listener where we left off before TLS</span><br><span class="hljs-keyword">for</span> i := lnWrapperIdx; i &lt; <span class="hljs-built_in">len</span>(srv.listenerWrappers); i++ &#123;<br>	ln = srv.listenerWrappers[i].WrapListener(ln)<br>&#125;<br></code></pre></td></tr></table></figure><p>该插件对 <code>WrapListener</code> 方法的实现如下:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// WrapListener implements caddy.ListenWrapper</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *ListenerWrapper)</span></span> WrapListener(l net.Listener) net.Listener &#123;<br>	ln := NewListener(l, m.upstream, m.logger)<br>	<span class="hljs-comment">// 异步后台捕获新链接</span><br>	<span class="hljs-keyword">go</span> ln.loop()<br>	<span class="hljs-keyword">return</span> ln<br>&#125;<br></code></pre></td></tr></table></figure><p>所以这个 wrapper 核心处理在 <code>loop()</code> 中:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// loop is ...</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *Listener)</span></span> loop() &#123;<br>	<span class="hljs-keyword">for</span> &#123;<br>		conn, err := l.Listener.Accept()<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">select</span> &#123;<br>			<span class="hljs-keyword">case</span> &lt;-l.closed:<br>				<span class="hljs-keyword">return</span><br>			<span class="hljs-keyword">default</span>:<br>				l.logger.Error(fmt.Sprintf(<span class="hljs-string">&quot;accept net.Conn error: %v&quot;</span>, err))<br>			&#125;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br><br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c net.Conn, lg *zap.Logger, up *Upstream)</span></span> &#123;<br>			b := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, HeaderLen+<span class="hljs-number">2</span>)<br>			<span class="hljs-keyword">if</span> _, err := io.ReadFull(c, b); err != <span class="hljs-literal">nil</span> &#123;<br>				<span class="hljs-keyword">if</span> errors.Is(err, io.EOF) &#123;<br>					lg.Error(fmt.Sprintf(<span class="hljs-string">&quot;read prefix error: read tcp %v -&gt; %v: read: %v&quot;</span>, c.RemoteAddr(), c.LocalAddr(), err))<br>				&#125; <span class="hljs-keyword">else</span> &#123;<br>					lg.Error(fmt.Sprintf(<span class="hljs-string">&quot;read prefix error: %v&quot;</span>, err))<br>				&#125;<br>				c.Close()<br>				<span class="hljs-keyword">return</span><br>			&#125;<br><br>			<span class="hljs-comment">// check the net.Conn</span><br>			<span class="hljs-keyword">if</span> ok := up.Validate(ByteSliceToString(b[:HeaderLen])); !ok &#123;<br>				<span class="hljs-keyword">select</span> &#123;<br>				<span class="hljs-keyword">case</span> &lt;-l.closed:<br>					c.Close()<br>				<span class="hljs-keyword">default</span>:<br>					l.conns &lt;- &amp;rawConn&#123;Conn: c, r: bytes.NewReader(b)&#125;<br>				&#125;<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>			<span class="hljs-keyword">defer</span> c.Close()<br>			lg.Info(fmt.Sprintf(<span class="hljs-string">&quot;handle trojan net.Conn from %v&quot;</span>, c.RemoteAddr()))<br><br>			nr, nw, err := Handle(io.Reader(c), io.Writer(c))<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				lg.Error(fmt.Sprintf(<span class="hljs-string">&quot;handle net.Conn error: %v&quot;</span>, err))<br>			&#125;<br>			up.Consume(ByteSliceToString(b[:HeaderLen]), nr, nw)<br>		&#125;(conn, l.logger, l.upstream)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>可以看到，当新链接进入时，首先对包头做检测 <code>if ok := up.Validate(ByteSliceToString(b[:HeaderLen]))</code>；如果检测通过那么这个链接就完全插件自己处理后续逻辑了；如果不通过则将此链接返回给 Caddy2，让 Caddy2 继续处理。</strong></p><p>这里面涉及到一个一开始让我不解的问题: “链接不可重复读”，后来看源码才明白作者处理方式很简单: <strong>包装一个 <code>rawConn</code>，在验证部分由于已经读了一点数据，如果验证不通过就把它存起来，然后让下一个读操作先读这个 buffer，从而实现原始数据组装。</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// rawConn is ...</span><br><span class="hljs-keyword">type</span> rawConn <span class="hljs-keyword">struct</span> &#123;<br>	net.Conn<br>	r *bytes.Reader<br>&#125;<br><br><span class="hljs-comment">// Read is ...</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *rawConn)</span></span> Read(b []<span class="hljs-type">byte</span>) (<span class="hljs-type">int</span>, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">if</span> c.r == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> c.Conn.Read(b)<br>	&#125;<br>	n, err := c.r.Read(b)<br>	<span class="hljs-keyword">if</span> errors.Is(err, io.EOF) &#123;<br>		c.r = <span class="hljs-literal">nil</span><br>		<span class="hljs-keyword">return</span> n, <span class="hljs-literal">nil</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> n, err<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="四、思考和总结"><a href="#四、思考和总结" class="headerlink" title="四、思考和总结"></a>四、思考和总结</h2><p>ListenerWrapper 是 Caddy2 一个强大的扩展能力，在 ListenerWrapper 基础上我们可以实现对 TCP 链接自定义处理，我们因此可以创造一些奇奇怪怪的协议。同时我们通过让链接重新交由 Caddy2 处理又能做到完美的伪装: <strong>当你去尝试访问时，如果密码学验证不通过，那么后续行为就与标准 Caddy2 表现一致，主动探测基本无效。对任何自己创造的 ListenerWrapper 来说，如果开启了类似 AEAD 这种加密，探测行为本身就会被转接到对抗密码学原理上。</strong></p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/golang/" class="category-chain-item">Golang</a> <span>></span> <a href="/categories/golang/caddy/" class="category-chain-item">Caddy</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/caddy/" class="print-no-link">#Caddy</a></div></div><div class="license-box my-3"><div class="license-title"><div>Caddy2 的 ListenerWrapper</div><div>https://mritd.com/2021/06/15/caddy2-listenerwrapper/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Kovacs</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2021年6月15日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2021/06/27/golang-context-source-code/" title="Golang Context 源码分析"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Golang Context 源码分析</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2021/06/06/jetbrains-plugins/" title="JetBrains 常用插件"><span class="hidden-mobile">JetBrains 常用插件</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://mritd.com/2021/06/15/caddy2-listenerwrapper/",this.page.identifier="/2021/06/15/caddy2-listenerwrapper/"};Fluid.utils.loadComments("#disqus_thread",(function(){var e=document,t=e.createElement("script");t.src="//bleem.disqus.com/embed.js",t.setAttribute("data-timestamp",new Date),(e.head||e.body).appendChild(t)}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-docker"></i> <a href="https://bandwagonhost.com/aff.php?aff=61367" target="_blank" rel="nofollow noopener"><span>BandwagonHost</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!0,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>