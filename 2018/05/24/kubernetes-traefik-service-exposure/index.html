<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Kovacs"><meta name="keywords" content="kubernetes,traefik"><meta name="description" content="最近准备重新折腾一下 Kubernetes 的服务暴露方式，以前的方式是彻底剥离 Kubenretes 本身的服务发现，然后改动应用实现 应用+Consul+Fabio 的服务暴露方式；总感觉这种方式不算优雅，所以折腾了一下 Traefik，试了下效果还不错，以下记录了使用 Traefik 的新的服务暴露方式(本文仅针对 HTTP 协议)"><meta property="og:type" content="article"><meta property="og:title" content="Traefik 另类的服务暴露方式"><meta property="og:url" content="https://mritd.com/2018/05/24/kubernetes-traefik-service-exposure/index.html"><meta property="og:site_name" content="Kovacs"><meta property="og:description" content="最近准备重新折腾一下 Kubernetes 的服务暴露方式，以前的方式是彻底剥离 Kubenretes 本身的服务发现，然后改动应用实现 应用+Consul+Fabio 的服务暴露方式；总感觉这种方式不算优雅，所以折腾了一下 Traefik，试了下效果还不错，以下记录了使用 Traefik 的新的服务暴露方式(本文仅针对 HTTP 协议)"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mritd.com/img/traefik_service.jpg"><meta property="article:published_time" content="2018-05-24T15:53:09.000Z"><meta property="article:modified_time" content="2018-05-24T15:53:09.000Z"><meta property="article:author" content="Kovacs"><meta property="article:tag" content="Kubernetes"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://mritd.com/img/traefik_service.jpg"><meta name="twitter:creator" content="@kovacs_orz"><meta name="twitter:site" content="https://twitter.com/kovacs_orz"><title>Traefik 另类的服务暴露方式 - Kovacs</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"mritd.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!0,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:"G-H06NPECR0Z"},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-H06NPECR0Z",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-H06NPECR0Z")}))</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Kovacs" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="Kovacs" type="application/rss+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Kovacs</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/friends/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Traefik 另类的服务暴露方式"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Kovacs </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2018-05-24 23:53" pubdate>2018年5月24日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.2k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 19 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">Traefik 另类的服务暴露方式</h1><div class="markdown-body"><blockquote><p>最近准备重新折腾一下 Kubernetes 的服务暴露方式，以前的方式是彻底剥离 Kubenretes 本身的服务发现，然后改动应用实现 应用+Consul+Fabio 的服务暴露方式；总感觉这种方式不算优雅，所以折腾了一下 Traefik，试了下效果还不错，以下记录了使用 Traefik 的新的服务暴露方式(本文仅针对 HTTP 协议)；</p></blockquote><h2 id="一、Traefik-服务暴露方案"><a href="#一、Traefik-服务暴露方案" class="headerlink" title="一、Traefik 服务暴露方案"></a>一、Traefik 服务暴露方案</h2><h3 id="1-1、以前的-Consul-Fabio-方案"><a href="#1-1、以前的-Consul-Fabio-方案" class="headerlink" title="1.1、以前的 Consul+Fabio 方案"></a>1.1、以前的 Consul+Fabio 方案</h3><p>以前的服务暴露方案是修改应用代码，使其能对接 Consul，然后 Consul 负责健康监测，检测通过后 Fabio 负责读取，最终上层 Nginx 将流量打到 Fabio 上，Fabio 再将流量路由到健康的 Pod 上；总体架构如下</p><p><img src="https://cdn.oss.link/markdown/hkwp3.png" srcset="/img/loading.gif" lazyload alt="consul+fabio"></p><p>这种架构目前有几点不太好的地方，首先是必须应用能成功集成 Consul，需要动应用代码不通用；其次组件过多增加维护成本，尤其是调用链日志不好追踪；这里面需要吐槽下 Consul 和 Fabio，Consul 的集群设计模式要想做到完全的 HA 那么需要在每个 pod 中启动一个 agent，因为只要这个 agent 挂了那么集群认为其上所有注册服务都挂了，这点很恶心人；而 Fabio 的日志目前好像还是不支持合理的输出，好像只能 stdout；目前来看不论是组件复杂度还是维护成本都不怎么友好</p><h3 id="1-2、新的-Traefik-方案"><a href="#1-2、新的-Traefik-方案" class="headerlink" title="1.2、新的 Traefik 方案"></a>1.2、新的 Traefik 方案</h3><p>使用 Traefik 首先想到就是直接怼 Ingress，这个确实方便也简单；但是在集群 kube-proxy 不走 ipvs 的情况下 iptables 性能确实堪忧；虽说 Traefik 会直连 Pod，但是你 Ingress 暴露 80、443 端口在本机没有对应 Ingress Controller 的情况下还是会走一下 iptables；<strong>不论是换 kube-router、kube-proxy 走 ipvs 都不是我想要的，我们需要一种完全远离 Kubernetes Service 的新路子</strong>；在看 Traefik 文档的时候，其中说明了 Traefik 只利用 Kubernetes 的 API 来读取相关后端数据，那么我们就可以以此来使用如下的套路</p><p><img src="https://cdn.oss.link/markdown/tfo2f.png" srcset="/img/loading.gif" lazyload alt="traefik"></p><p>这个套路的方案很简单，<strong>将 Traefik 部署在物理机上，让其直连 Kubernets api 以读取 Ingress 配置和 Pod IP 等信息，然后在这几台物理机上部署好 Kubernetes 的网络组件使其能直连 Pod IP</strong>；这种方案能够让流量经过 Traefik 直接路由到后端 Pod，健康检测还是由集群来做；<strong>由于 Traefik 连接 Kubernetes api 需要获取一些数据；所以在集群内还是像往常一样创建 Ingress，只不过此时我们并没有 Ingress Controller；这样避免了经过 iptables 转发，不占用全部集群机器的 80、443 端口，同时还能做到高可控</strong></p><h2 id="二、Traefik-部署"><a href="#二、Traefik-部署" class="headerlink" title="二、Traefik 部署"></a>二、Traefik 部署</h2><p>部署之前首先需要有一个正常访问的集群，然后在另外几台机器上部署 Kubernetes 的网络组件；最终要保证另外几台机器能够直接连通 Pod 的 IP，我这里偷懒直接在 Kubernetes 的其中几个 Node 上部署 Traefik</p><h3 id="2-1、Docker-Compose"><a href="#2-1、Docker-Compose" class="headerlink" title="2.1、Docker Compose"></a>2.1、Docker Compose</h3><p>Traefik 的 Docker Compose 如下</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.5&#x27;</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">traefik:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">traefik:v1.6.1-alpine</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">traefik</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">--configFile=/etc/traefik.toml</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;2080:2080&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;2180:2180&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./traefik.toml:/etc/traefik.toml</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./k8s-root-ca.pem:/etc/kubernetes/ssl/k8s-root-ca.pem</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./log:/var/log/traefik</span><br></code></pre></td></tr></table></figure><p>由于 Kubernetes 集群开启了 RBAC 认证同时采用 TLS 通讯，所以需要挂载 Kubernetes CA 证书，还需要为 Traefik 创建对应的 RBAC 账户以使其能够访问 Kubernetes API</p><h3 id="2-2、创建-RBAC-账户"><a href="#2-2、创建-RBAC-账户" class="headerlink" title="2.2、创建 RBAC 账户"></a>2.2、创建 RBAC 账户</h3><p>Traefik 连接 Kubernetes API 时需要使用 Service Account 的 Token，Service Account 以及 ClusterRole 等配置具体见 <a target="_blank" rel="noopener" href="https://docs.traefik.io/user-guide/kubernetes/">官方文档</a>，下面是我从当前版本的文档中 Copy 出来的</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">traefik-ingress-controller</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1beta1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">traefik-ingress-controller</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">services</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">endpoints</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">secrets</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">extensions</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1beta1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">traefik-ingress-controller</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">traefik-ingress-controller</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">traefik-ingress-controller</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br></code></pre></td></tr></table></figure><p>创建好以后需要提取 Service Account 的 Token 方便下面使用，提取命令如下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl describe secret -n kube-system $(kubectl get secrets -n kube-system | grep traefik-ingress-controller | <span class="hljs-built_in">cut</span> -f1 -d <span class="hljs-string">&#x27; &#x27;</span>) | grep -E <span class="hljs-string">&#x27;^token&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="2-3、创建-Traefik-配置"><a href="#2-3、创建-Traefik-配置" class="headerlink" title="2.3、创建 Traefik 配置"></a>2.3、创建 Traefik 配置</h3><p>Traefik 的具体配置细节请参考 <a target="_blank" rel="noopener" href="https://docs.traefik.io/configuration/commons/">官方文档</a>，以下仅给出一个样例配置</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-comment"># DEPRECATED - for general usage instruction see [lifeCycle.graceTimeOut].</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># If both the deprecated option and the new one are given, the deprecated one</span><br><span class="hljs-comment"># takes precedence.</span><br><span class="hljs-comment"># A value of zero is equivalent to omitting the parameter, causing</span><br><span class="hljs-comment"># [lifeCycle.graceTimeOut] to be effective. Pass zero to the new option in</span><br><span class="hljs-comment"># order to disable the grace period.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: &quot;0s&quot;</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># graceTimeOut = &quot;10s&quot;</span><br><br><span class="hljs-comment"># Enable debug mode.</span><br><span class="hljs-comment"># This will install HTTP handlers to expose Go expvars under /debug/vars and</span><br><span class="hljs-comment"># pprof profiling data under /debug/pprof.</span><br><span class="hljs-comment"># The log level will be set to DEBUG unless `logLevel` is specified.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: false</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># debug = true</span><br><br><span class="hljs-comment"># Periodically check if a new version has been released.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: true</span><br><span class="hljs-comment">#</span><br><span class="hljs-attr">checkNewVersion</span> = <span class="hljs-literal">false</span><br><br><span class="hljs-comment"># Backends throttle duration.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: &quot;2s&quot;</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># providersThrottleDuration = &quot;2s&quot;</span><br><br><span class="hljs-comment"># Controls the maximum idle (keep-alive) connections to keep per-host.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: 200</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># maxIdleConnsPerHost = 200</span><br><br><span class="hljs-comment"># If set to true invalid SSL certificates are accepted for backends.</span><br><span class="hljs-comment"># This disables detection of man-in-the-middle attacks so should only be used on secure backend networks.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: false</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># insecureSkipVerify = true</span><br><br><span class="hljs-comment"># Register Certificates in the rootCA.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: []</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># rootCAs = [ &quot;/mycert.cert&quot; ]</span><br><br><span class="hljs-comment"># Entrypoints to be used by frontends that do not specify any entrypoint.</span><br><span class="hljs-comment"># Each frontend can specify its own entrypoints.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: [&quot;http&quot;]</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># defaultEntryPoints = [&quot;http&quot;, &quot;https&quot;]</span><br><br><span class="hljs-comment"># Allow the use of 0 as server weight.</span><br><span class="hljs-comment"># - false: a weight 0 means internally a weight of 1.</span><br><span class="hljs-comment"># - true: a weight 0 means internally a weight of 0 (a server with a weight of 0 is removed from the available servers).</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: false</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># AllowMinWeightZero = true</span><br><br><span class="hljs-attr">logLevel</span> = <span class="hljs-string">&quot;INFO&quot;</span><br><br><span class="hljs-section">[traefikLog]</span><br>  <span class="hljs-attr">filePath</span> = <span class="hljs-string">&quot;/var/log/traefik/traefik.log&quot;</span><br>  <span class="hljs-attr">format</span>   = <span class="hljs-string">&quot;json&quot;</span><br><br><span class="hljs-section">[accessLog]</span><br>  <span class="hljs-attr">filePath</span> = <span class="hljs-string">&quot;/var/log/traefik/access.log&quot;</span><br>  <span class="hljs-attr">format</span> = <span class="hljs-string">&quot;json&quot;</span><br><br>  <span class="hljs-section">[accessLog.filters]</span><br>    <span class="hljs-attr">statusCodes</span> = [<span class="hljs-string">&quot;200-511&quot;</span>]<br>    <span class="hljs-attr">retryAttempts</span> = <span class="hljs-literal">true</span><br><br><span class="hljs-comment">#  [accessLog.fields]</span><br><span class="hljs-comment">#    defaultMode = &quot;keep&quot;</span><br><span class="hljs-comment">#    [accessLog.fields.names]</span><br><span class="hljs-comment">#      &quot;ClientUsername&quot; = &quot;drop&quot;</span><br><span class="hljs-comment">#      # ...</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#    [accessLog.fields.headers]</span><br><span class="hljs-comment">#      defaultMode = &quot;keep&quot;</span><br><span class="hljs-comment">#      [accessLog.fields.headers.names]</span><br><span class="hljs-comment">#        &quot;User-Agent&quot; = &quot;redact&quot;</span><br><span class="hljs-comment">#        &quot;Authorization&quot; = &quot;drop&quot;</span><br><span class="hljs-comment">#        &quot;Content-Type&quot; = &quot;keep&quot;</span><br><span class="hljs-comment">#        # ...</span><br><br><br><span class="hljs-section">[entryPoints]</span><br>  <span class="hljs-section">[entryPoints.http]</span><br>    <span class="hljs-attr">address</span> = <span class="hljs-string">&quot;:2080&quot;</span><br>    <span class="hljs-attr">compress</span> = <span class="hljs-literal">true</span><br>  <span class="hljs-section">[entryPoints.traefik]</span><br>    <span class="hljs-attr">address</span> = <span class="hljs-string">&quot;:2180&quot;</span><br>    <span class="hljs-attr">compress</span> = <span class="hljs-literal">true</span><br><br><span class="hljs-comment">#    [entryPoints.http.whitelist]</span><br><span class="hljs-comment">#      sourceRange = [&quot;192.168.1.0/24&quot;]</span><br><span class="hljs-comment">#      useXForwardedFor = true</span><br><br><span class="hljs-comment">#    [entryPoints.http.tls]</span><br><span class="hljs-comment">#      minVersion = &quot;VersionTLS12&quot;</span><br><span class="hljs-comment">#      cipherSuites = [</span><br><span class="hljs-comment">#        &quot;TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256&quot;,</span><br><span class="hljs-comment">#        &quot;TLS_RSA_WITH_AES_256_GCM_SHA384&quot;</span><br><span class="hljs-comment">#       ]</span><br><span class="hljs-comment">#      [[entryPoints.http.tls.certificates]]</span><br><span class="hljs-comment">#        certFile = &quot;path/to/my.cert&quot;</span><br><span class="hljs-comment">#        keyFile = &quot;path/to/my.key&quot;</span><br><span class="hljs-comment">#      [[entryPoints.http.tls.certificates]]</span><br><span class="hljs-comment">#        certFile = &quot;path/to/other.cert&quot;</span><br><span class="hljs-comment">#        keyFile = &quot;path/to/other.key&quot;</span><br><span class="hljs-comment">#      # ...</span><br><span class="hljs-comment">#      [entryPoints.http.tls.clientCA]</span><br><span class="hljs-comment">#        files = [&quot;path/to/ca1.crt&quot;, &quot;path/to/ca2.crt&quot;]</span><br><span class="hljs-comment">#        optional = false</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#    [entryPoints.http.redirect]</span><br><span class="hljs-comment">#      entryPoint = &quot;https&quot;</span><br><span class="hljs-comment">#      regex = &quot;^http://localhost/(.*)&quot;</span><br><span class="hljs-comment">#      replacement = &quot;http://mydomain/$1&quot;</span><br><span class="hljs-comment">#      permanent = true</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#    [entryPoints.http.auth]</span><br><span class="hljs-comment">#      headerField = &quot;X-WebAuth-User&quot;</span><br><span class="hljs-comment">#      [entryPoints.http.auth.basic]</span><br><span class="hljs-comment">#        users = [</span><br><span class="hljs-comment">#          &quot;test:$apr1$H6uskkkW$IgXLP6ewTrSuBkTrqE8wj/&quot;,</span><br><span class="hljs-comment">#          &quot;test2:$apr1$d9hr9HBB$4HxwgUir3HP4EsggP/QNo0&quot;,</span><br><span class="hljs-comment">#        ]</span><br><span class="hljs-comment">#        usersFile = &quot;/path/to/.htpasswd&quot;</span><br><span class="hljs-comment">#      [entryPoints.http.auth.digest]</span><br><span class="hljs-comment">#        users = [</span><br><span class="hljs-comment">#          &quot;test:traefik:a2688e031edb4be6a3797f3882655c05&quot;,</span><br><span class="hljs-comment">#          &quot;test2:traefik:518845800f9e2bfb1f1f740ec24f074e&quot;,</span><br><span class="hljs-comment">#        ]</span><br><span class="hljs-comment">#        usersFile = &quot;/path/to/.htdigest&quot;</span><br><span class="hljs-comment">#      [entryPoints.http.auth.forward]</span><br><span class="hljs-comment">#        address = &quot;https://authserver.com/auth&quot;</span><br><span class="hljs-comment">#        trustForwardHeader = true</span><br><span class="hljs-comment">#        [entryPoints.http.auth.forward.tls]</span><br><span class="hljs-comment">#          ca =  [ &quot;path/to/local.crt&quot;]</span><br><span class="hljs-comment">#          caOptional = true</span><br><span class="hljs-comment">#          cert = &quot;path/to/foo.cert&quot;</span><br><span class="hljs-comment">#          key = &quot;path/to/foo.key&quot;</span><br><span class="hljs-comment">#          insecureSkipVerify = true</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#    [entryPoints.http.proxyProtocol]</span><br><span class="hljs-comment">#      insecure = true</span><br><span class="hljs-comment">#      trustedIPs = [&quot;10.10.10.1&quot;, &quot;10.10.10.2&quot;]</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#    [entryPoints.http.forwardedHeaders]</span><br><span class="hljs-comment">#      trustedIPs = [&quot;10.10.10.1&quot;, &quot;10.10.10.2&quot;]</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#  [entryPoints.https]</span><br><span class="hljs-comment">#    # ...</span><br><br><span class="hljs-comment">################################################################</span><br><span class="hljs-comment"># Kubernetes Ingress configuration backend</span><br><span class="hljs-comment">################################################################</span><br><br><span class="hljs-comment"># Enable Kubernetes Ingress configuration backend.</span><br><span class="hljs-section">[kubernetes]</span><br><br><span class="hljs-comment"># Kubernetes server endpoint.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional for in-cluster configuration, required otherwise.</span><br><span class="hljs-comment"># Default: empty</span><br><span class="hljs-comment">#</span><br><span class="hljs-attr">endpoint</span> = <span class="hljs-string">&quot;https://172.16.0.36:6443&quot;</span><br><br><span class="hljs-comment"># Bearer token used for the Kubernetes client configuration.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: empty</span><br><span class="hljs-comment">#</span><br><span class="hljs-attr">token</span> = <span class="hljs-string">&quot;eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJ0cmFlZmlrLWluZ3Jlc3MtY29udHJvbGxlci10b2tlbi1zbm5iNSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJ0cmFlZmlrLWlyZ3Jlc3MtY29udHJvbGxlciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImE4NmI3YWEzLTVmNjQtMTFlOC1hZjYxLWM4MWY2NmUwMzRhNyIsInN1YiI6InN5c3RlbTpxZXJ2aWNlYWNjb3VudDPrdWJlLXN5c3RlbTp0cmFlZmlrLWluZ3Jlc3MtY29udHJvbGxlciJ9.vOFEITuANWGnkER8gukWkTs54BmHXqNpzM55bOb5qXPmI3pZsbei3gtE6tZoqME9P5Lb85cav-8mGZJcoQqqxNBkZJ1YRqy_1O9Apkxa4jA68ipe_NB3L5-exH5cEIrU8iql_r7ycDaKwzsMnAWGPolp1dRkF31u5u8g68oLwF3GR8Z5g4_tLJlTvA53doX7k6Wd6vUygTS3EaQ_qvfXwbcIeaSdWWo2Mym6O0CvIap4jH2w21MbredGURqkRlXEPezKAgRVkr75CdvuvwORnT8YxFLVwuAJs70V-13Ib9v6HAK64GmzcqkAuJtZT8NZKl8Y4TfRGl2_RMq2tk86gD4ShDMedcrto44ZUYHQccsSlpaW5PsN2KBBNPN0-6ca3jIpOmnJojAFUYGM42Wymnx9_4XwHUeeA18-RrercmOaRMdlNq8BzBomAxQB99TqUzRIqpe6m5OotXvouCUnE7qjMwRWmQ5LHjqUGEw_A1pHcalFXQZK0sOCaJOJZIJbc_8rVX-4uxkCBxoIXmzjq8x5a_xPsN4L0aWifkP6co--agw3kOT0O6my8T_CbcZGO9e3OqYPdT4FSl92XlXW8EXHdDpCUJ10aoqJGG2vZSud7IoDxkcScpkj3n6TvyvSRVtk3CtYiIYBpgi7-X2JKkun1a7yFpLogyazz9VlUE4&quot;</span><br><br><span class="hljs-comment"># Path to the certificate authority file.</span><br><span class="hljs-comment"># Used for the Kubernetes client configuration.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: empty</span><br><span class="hljs-comment">#</span><br><span class="hljs-attr">certAuthFilePath</span> = <span class="hljs-string">&quot;/etc/kubernetes/ssl/k8s-root-ca.pem&quot;</span><br><br><span class="hljs-comment"># Array of namespaces to watch.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: all namespaces (empty array).</span><br><span class="hljs-comment">#</span><br><span class="hljs-attr">namespaces</span> = [<span class="hljs-string">&quot;default&quot;</span>]<br><br><span class="hljs-comment"># Ingress label selector to filter Ingress objects that should be processed.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: empty (process all Ingresses)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># labelselector = &quot;A and not B&quot;</span><br><br><span class="hljs-comment"># Value of `kubernetes.io/ingress.class` annotation that identifies Ingress objects to be processed.</span><br><span class="hljs-comment"># If the parameter is non-empty, only Ingresses containing an annotation with the same value are processed.</span><br><span class="hljs-comment"># Otherwise, Ingresses missing the annotation, having an empty value, or the value `traefik` are processed.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Note : `ingressClass` option must begin with the &quot;traefik&quot; prefix.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: empty</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># ingressClass = &quot;traefik-internal&quot;</span><br><br><span class="hljs-comment"># Disable PassHost Headers.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: false</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># disablePassHostHeaders = true</span><br><br><span class="hljs-comment"># Enable PassTLSCert Headers.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: false</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># enablePassTLSCert = true</span><br><br><span class="hljs-comment"># Override default configuration template.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Optional</span><br><span class="hljs-comment"># Default: &lt;built-in template&gt;</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># filename = &quot;kubernetes.tmpl&quot;</span><br><br><br><span class="hljs-comment"># API definition</span><br><span class="hljs-section">[api]</span><br>  <span class="hljs-comment"># Name of the related entry point</span><br>  <span class="hljs-comment">#</span><br>  <span class="hljs-comment"># Optional</span><br>  <span class="hljs-comment"># Default: &quot;traefik&quot;</span><br>  <span class="hljs-comment">#</span><br>  <span class="hljs-attr">entryPoint</span> = <span class="hljs-string">&quot;traefik&quot;</span><br><br>  <span class="hljs-comment"># Enabled Dashboard</span><br>  <span class="hljs-comment">#</span><br>  <span class="hljs-comment"># Optional</span><br>  <span class="hljs-comment"># Default: true</span><br>  <span class="hljs-comment">#</span><br>  <span class="hljs-attr">dashboard</span> = <span class="hljs-literal">true</span><br><br>  <span class="hljs-comment"># Enable debug mode.</span><br>  <span class="hljs-comment"># This will install HTTP handlers to expose Go expvars under /debug/vars and</span><br>  <span class="hljs-comment"># pprof profiling data under /debug/pprof.</span><br>  <span class="hljs-comment"># Additionally, the log level will be set to DEBUG.</span><br>  <span class="hljs-comment">#</span><br>  <span class="hljs-comment"># Optional</span><br>  <span class="hljs-comment"># Default: false</span><br>  <span class="hljs-comment">#</span><br>  <span class="hljs-attr">debug</span> = <span class="hljs-literal">false</span><br><br><span class="hljs-comment"># Ping definition</span><br><span class="hljs-comment">#[ping]</span><br><span class="hljs-comment">#  # Name of the related entry point</span><br><span class="hljs-comment">#  #</span><br><span class="hljs-comment">#  # Optional</span><br><span class="hljs-comment">#  # Default: &quot;traefik&quot;</span><br><span class="hljs-comment">#  #</span><br><span class="hljs-comment">#  entryPoint = &quot;traefik&quot;</span><br></code></pre></td></tr></table></figure><h3 id="2-4、启动-Traefik"><a href="#2-4、启动-Traefik" class="headerlink" title="2.4、启动 Traefik"></a>2.4、启动 Traefik</h3><p>所有文件准备好以后直接执行 <code>docker-compose up -d</code> 启动即可，所有文件目录结构如下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">traefik<br>├── docker-compose.yaml<br>├── k8s-root-ca.pem<br>├── <span class="hljs-built_in">log</span><br>│   ├── access.log<br>│   └── traefik.log<br>├── rbac.yaml<br>└── traefik.toml<br></code></pre></td></tr></table></figure><p>启动成功后可以访问 <code>http://IP:2180</code> 查看 Traefik 的控制面板</p><p><img src="https://cdn.oss.link/markdown/phrps.png" srcset="/img/loading.gif" lazyload alt="dashboard"></p><h2 id="三、增加-Ingress-配置并测试"><a href="#三、增加-Ingress-配置并测试" class="headerlink" title="三、增加 Ingress 配置并测试"></a>三、增加 Ingress 配置并测试</h2><h3 id="3-1、增加-Ingress-配置"><a href="#3-1、增加-Ingress-配置" class="headerlink" title="3.1、增加 Ingress 配置"></a>3.1、增加 Ingress 配置</h3><p>虽然这种部署方式脱离了 Kubernetes 的 Service 与 Ingress 负载，但是 Traefik 还是需要通过 Kubernetes 的 Ingress 配置来确定后端负载规则，所以 Ingress 对象我们仍需照常创建；以下为一个 Demo 项目的 deployment、service、ingress 配置示例</p><ul><li>demo.deploy.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">demo</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">5</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">demo</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">demo</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">demo</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">mritd/demo</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><ul><li>demo.svc.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">demo</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">svc:</span> <span class="hljs-string">demo</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">demo</span><br></code></pre></td></tr></table></figure><ul><li>demo.ing.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">demo</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">traefik.ingress.kubernetes.io/preserve-host:</span> <span class="hljs-string">&quot;true&quot;</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">demo.mritd.me</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">demo</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">8080</span><br></code></pre></td></tr></table></figure><h3 id="3-2、测试访问"><a href="#3-2、测试访问" class="headerlink" title="3.2、测试访问"></a>3.2、测试访问</h3><p>部署好后应当能从 Traefik 的 Dashboard 中看到新增的 demo ingress，如下所示</p><p><img src="https://cdn.oss.link/markdown/zociy.png" srcset="/img/loading.gif" lazyload alt="dashboard-demo"></p><p>最后我们使用 curl 测试即可</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 在不使用 Host 头的情况下 Traefik 会返 404(Traefik 根据 Host 路由后端，具体配置参考官方文档)</span><br>test36.node ➜  ~ curl http://172.16.0.36:2080<br>404 page not found<br><br><span class="hljs-comment"># 指定 Host 头来路由到 demo 的相关 Pod</span><br>test36.node ➜  ~ curl -H <span class="hljs-string">&quot;Host: demo.mritd.me&quot;</span> http://172.16.0.36:2080<br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;zh&quot;</span>&gt;<br>&lt;<span class="hljs-built_in">head</span>&gt;<br>    &lt;meta http-equiv=<span class="hljs-string">&quot;Content-Type&quot;</span> content=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span>&gt;<br>    &lt;title&gt;Running!&lt;/title&gt;<br>    &lt;style <span class="hljs-built_in">type</span>=<span class="hljs-string">&quot;text/css&quot;</span>&gt;<br>        body &#123;<br>            width: 100%;<br>            min-height: 100%;<br>            background: linear-gradient(to bottom, <span class="hljs-comment">#fff 0, #b8edff 50%, #83dfff 100%);</span><br>            background-attachment: fixed;<br>        &#125;<br>    &lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body class=<span class="hljs-string">&quot; hasGoogleVoiceExt&quot;</span>&gt;<br>&lt;div align=<span class="hljs-string">&quot;center&quot;</span>&gt;<br>    &lt;h1&gt;Your container is running!&lt;/h1&gt;<br>    &lt;img src=<span class="hljs-string">&quot;./docker.png&quot;</span> alt=<span class="hljs-string">&quot;docker&quot;</span>&gt;<br>&lt;/div&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><h2 id="四、其他说明"><a href="#四、其他说明" class="headerlink" title="四、其他说明"></a>四、其他说明</h2><p>写这篇文章的目的是给予一种新的服务暴露思路，这篇文章的某些配置并不适合生产使用；<strong>生产环境尽量使用独立的机器部署 Traefik，同时最好宿主机二进制方式部署；应用的 Deployment 也应当加入健康检测以防止错误的流量路由</strong>；至于 Traefik 的具体细节配置，比如访问日志、Entrypoints 配置、如何连接 Kubernets HA api 等不在本文范畴内，请自行查阅文档；</p><p>最后说一下，关于 Traefik 的 HA 只需要部署多个实例即可，还有 Traefik 本身不做日志滚动等，需要自行处理一下日志。</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/kubernetes/" class="category-chain-item">Kubernetes</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/kubernetes/" class="print-no-link">#Kubernetes</a></div></div><div class="license-box my-3"><div class="license-title"><div>Traefik 另类的服务暴露方式</div><div>https://mritd.com/2018/05/24/kubernetes-traefik-service-exposure/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Kovacs</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2018年5月24日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2018/08/09/create-a-plugin-for-kubectl/" title="编写 kubectl 插件"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">编写 kubectl 插件</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2018/05/11/add-commit-message-style-check-to-your-gitlab/" title="为你的 GitLab 增加提交信息检测"><span class="hidden-mobile">为你的 GitLab 增加提交信息检测</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://mritd.com/2018/05/24/kubernetes-traefik-service-exposure/",this.page.identifier="/2018/05/24/kubernetes-traefik-service-exposure/"};Fluid.utils.loadComments("#disqus_thread",(function(){var e=document,t=e.createElement("script");t.src="//bleem.disqus.com/embed.js",t.setAttribute("data-timestamp",new Date),(e.head||e.body).appendChild(t)}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-docker"></i> <a href="https://bandwagonhost.com/aff.php?aff=61367" target="_blank" rel="nofollow noopener"><span>BandwagonHost</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!0,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>