<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Kovacs"><meta name="keywords" content="MySQL,Binlog"><meta name="description" content="公司很多开发每天在 MySQL 上手动执行 SQL, 虽然有备份机制但是扛不住执行次数多, 最近决定模拟一下误删数据进行数据恢复, 这里记录下 BinLog 方式的恢复流程."><meta property="og:type" content="article"><meta property="og:title" content="MySQL Binlog 数据恢复"><meta property="og:url" content="https://mritd.com/2024/01/11/mysql-binlog-restore/index.html"><meta property="og:site_name" content="Kovacs"><meta property="og:description" content="公司很多开发每天在 MySQL 上手动执行 SQL, 虽然有备份机制但是扛不住执行次数多, 最近决定模拟一下误删数据进行数据恢复, 这里记录下 BinLog 方式的恢复流程."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mritd.com/img/mysql.jpg"><meta property="article:published_time" content="2024-01-11T07:20:00.000Z"><meta property="article:modified_time" content="2024-01-11T07:20:00.000Z"><meta property="article:author" content="Kovacs"><meta property="article:tag" content="MySQL"><meta property="article:tag" content="Database"><meta property="article:tag" content="Binlog"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://mritd.com/img/mysql.jpg"><meta name="twitter:creator" content="@kovacs_orz"><meta name="twitter:site" content="https://twitter.com/kovacs_orz"><title>MySQL Binlog 数据恢复 - Kovacs</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"mritd.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!0,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:"G-H06NPECR0Z"},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-H06NPECR0Z",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-H06NPECR0Z")}))</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Kovacs" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="Kovacs" type="application/rss+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Kovacs</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/friends/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="MySQL Binlog 数据恢复"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Kovacs </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-01-11 15:20" pubdate>2024年1月11日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 5.6k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 47 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">MySQL Binlog 数据恢复</h1><div class="markdown-body"><h2 id="一、恢复原理"><a href="#一、恢复原理" class="headerlink" title="一、恢复原理"></a>一、恢复原理</h2><blockquote><p>发现很多网上的教程都是不完整的, 整个流程中完全不符合实际生产环境, 所以这里做一下简要说明.</p></blockquote><h3 id="1-1、Binlog-是什么"><a href="#1-1、Binlog-是什么" class="headerlink" title="1.1、Binlog 是什么"></a>1.1、Binlog 是什么</h3><blockquote><p>MySQL Binary Log (BinLog) is a record of all changes made to a MySQL database. It serves as an audit trail of changes and can be used for various purposes, such as data recovery, replication, and database monitoring. BinLogs are created by the MySQL server and contain a record of all SQL statements that modify data.</p></blockquote><p>简而言之, Binlog 是 MySQL 内部记录数据修改的 “日志”, <strong>通过 Binlog 我们可以重放以前的执行流程.</strong></p><h3 id="1-2、Binlog-恢复前提"><a href="#1-2、Binlog-恢复前提" class="headerlink" title="1.2、Binlog 恢复前提"></a>1.2、Binlog 恢复前提</h3><p>想要使用 MySQL Binlog 进行恢复数据, 大致需要两个前提:</p><ul><li>1、你要有 Binlog, 也就是说 MySQL 服务器必须已经开启了 Binlog</li><li>2、你需要有一个被删除时间点之前的完整备份</li></ul><p>网上很多 Binlog 恢复都不谈核心问题, 核心问题就是你想<strong>做恢复之前必须有一份删除时间点之前的完整数据库备份, 因为本质上恢复流程就是重放所有 SQL 执行, 只不过只重放到被删之前而已.</strong></p><h2 id="二、数据库配置"><a href="#二、数据库配置" class="headerlink" title="二、数据库配置"></a>二、数据库配置</h2><p>对于 MySQL 8.0.x 可以使用以下配置让 MySQL 开启 Binlog 记录, 样例中有些配置不是必须的, 请自行参考引用文章:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 开启 binlog</span><br><span class="hljs-attr">log_bin</span>=/data/mysql/binlogs/mysql-bin<br><span class="hljs-comment"># 作为从库时，同步信息依然写入 binlog，方便链式同步</span><br><span class="hljs-attr">log_slave_updates</span>=<span class="hljs-number">1</span><br><span class="hljs-comment"># 每 n 次事务 binlog 刷新到磁盘</span><br><span class="hljs-comment"># refs http://liyangliang.me/posts/2014/03/innodb_flush_log_at_trx_commit-and-sync_binlog/</span><br><span class="hljs-attr">sync_binlog</span>=<span class="hljs-number">100</span><br><span class="hljs-attr">innodb_flush_log_at_trx_commit</span>=<span class="hljs-number">2</span><br><span class="hljs-comment"># binlog 格式(refs https://zhuanlan.zhihu.com/p/33504555)</span><br><span class="hljs-attr">binlog_format</span>=row<br><span class="hljs-comment"># binlog 自动清理时间(20d)</span><br><span class="hljs-attr">binlog_expire_logs_seconds</span>=<span class="hljs-number">1728000</span><br><span class="hljs-comment"># 开启 relay-log，一般作为 slave 时开启</span><br><span class="hljs-attr">relay_log</span>=mysql-replay<br><span class="hljs-comment"># 每个 session binlog 缓存</span><br><span class="hljs-attr">binlog_cache_size</span>=<span class="hljs-number">4</span>M<br><span class="hljs-comment"># binlog 滚动大小</span><br><span class="hljs-attr">max_binlog_size</span>=<span class="hljs-number">1024</span>M<br></code></pre></td></tr></table></figure><h2 id="三、测试环境准备"><a href="#三、测试环境准备" class="headerlink" title="三、测试环境准备"></a>三、测试环境准备</h2><blockquote><p>本测试中所有数据库版本为 8.0.35, 理论上 5.x 版本和更高版本思路应该一致.</p></blockquote><h3 id="3-1、测试环境"><a href="#3-1、测试环境" class="headerlink" title="3.1、测试环境"></a>3.1、测试环境</h3><p>为了测试数据恢复搭建了一套测试环境, 测试环境中所有节点统一采用 Percona MySQL 8.0.35, 备份工具采用 Percona XtraBackup 执行完整全量备份. 其中数据库安装系统为 Ubuntu 22.04, 一个主库一个从库, 另外恢复操作在单独的测试库进行; 全部节点如下:</p><ul><li>172.16.11.251(bintest1): 主库, 假设在此进行数据删除</li><li>172.16.11.252(bintest2): 从库, 实时同步主库数据, 生产环境负责定时备份</li><li>172.16.11.253(bintest3): 测试库, Binlog 数据恢复在此进行</li></ul><h3 id="3-2、测试数据"><a href="#3-2、测试数据" class="headerlink" title="3.2、测试数据"></a>3.2、测试数据</h3><p>测试时采用独立的数据库(<code>bintest</code>), 测试删除数据的表为 <code>userinfo</code>, 建表语句以及测试数据如下所示:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 创建数据库<br><span class="hljs-keyword">CREATE</span> DATABASE bintest <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci;<br><br># 创建测试表<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> userinfo<br>(<br>    id          <span class="hljs-type">BIGINT</span> AUTO_INCREMENT,<br>    name        <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)           <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    idno        <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)           <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    address     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)           <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    create_time DATETIME <span class="hljs-keyword">DEFAULT</span> NOW() <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    <span class="hljs-keyword">CONSTRAINT</span> userinfo_pk<br>        <span class="hljs-keyword">PRIMARY</span> KEY (id)<br>);<br><br># 插入测试数据<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> userinfo(name,idno,address) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;李瑞芳&#x27;</span>,<span class="hljs-string">&#x27;636920199802136451&#x27;</span>,<span class="hljs-string">&#x27;山西省临汾市顺靯路5032号疞嶥小区14单元2141室&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> userinfo(name,idno,address) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;方方竣&#x27;</span>,<span class="hljs-string">&#x27;146324198806075248&#x27;</span>,<span class="hljs-string">&#x27;甘肃省天水市婄煄路3816号没卾小区17单元229室&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> userinfo(name,idno,address) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;常明珠&#x27;</span>,<span class="hljs-string">&#x27;441439198304217281&#x27;</span>,<span class="hljs-string">&#x27;湖南省湘西土家族苗族自治州僄籓路3511号贪堕小区7单元2074室&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> userinfo(name,idno,address) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;陆奕然&#x27;</span>,<span class="hljs-string">&#x27;629162201311010724&#x27;</span>,<span class="hljs-string">&#x27;广西壮族自治区玉林市秈瑨路704号鮗捤小区11单元2409室&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> userinfo(name,idno,address) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;郝博雅&#x27;</span>,<span class="hljs-string">&#x27;138088201811117959&#x27;</span>,<span class="hljs-string">&#x27;河南省驻马店市紎筦路1380号攃摍小区13单元2363室&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> userinfo(name,idno,address) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;夏婉君&#x27;</span>,<span class="hljs-string">&#x27;122839198907076789&#x27;</span>,<span class="hljs-string">&#x27;山西省忻州市聜鳁路24号詿臜小区12单元1961室&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> userinfo(name,idno,address) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;邱新宜&#x27;</span>,<span class="hljs-string">&#x27;129192199311154795&#x27;</span>,<span class="hljs-string">&#x27;辽宁省葫芦岛市攣盗路7356号嚓檧小区14单元1326室&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> userinfo(name,idno,address) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;吴东&#x27;</span>,<span class="hljs-string">&#x27;642398199908131195&#x27;</span>,<span class="hljs-string">&#x27;陕西省渭南市污岕路1288号鯭蕄小区10单元1252室&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> userinfo(name,idno,address) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;尉迟妙己&#x27;</span>,<span class="hljs-string">&#x27;719031198308109317&#x27;</span>,<span class="hljs-string">&#x27;陕西省宝鸡市逳彄路1441号骘鼽小区11单元1128室&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> userinfo(name,idno,address) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;公孙昱晔&#x27;</span>,<span class="hljs-string">&#x27;372078200010227375&#x27;</span>,<span class="hljs-string">&#x27;福建省莆田市顪夹路4222号蝣宣小区2单元2046室&#x27;</span>);<br></code></pre></td></tr></table></figure><h3 id="3-3、备份方式"><a href="#3-3、备份方式" class="headerlink" title="3.3、备份方式"></a>3.3、备份方式</h3><p>前面已经说过, Binlog 恢复先决条件是有一份完整的备份, 本文中备份和恢复会使用 xtrabackup, 假定定时任务会每小时执行一次完整备份; xtrabackup 工具请自行安装(需要与 MySQL 大版本匹配), 同时 xtrabackup 工具会使用 <code>qpress</code> 进行压缩和解压备份, 需要单独安装. 备份和恢复脚本如下:</p><p><strong>backup.sh</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/usr/bin/env bash</span><br><br><span class="hljs-built_in">set</span> -e<br><br>MYSQL_BACKUP_USER=<span class="hljs-string">&#x27;root&#x27;</span><br>BACKUP_DIR=<span class="hljs-string">&quot;/data/mysql_backup&quot;</span><br>BACKUP_NAME=full_$(<span class="hljs-built_in">date</span> <span class="hljs-string">&quot;+%Y%m%d%H%M%S&quot;</span>)<br>MYSQL_CONFIG=<span class="hljs-string">&quot;/etc/mysql/mysql.conf.d/mysqld.cnf&quot;</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">cleanup</span></span>()&#123;<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Clean Backup Dir ---&gt; <span class="hljs-variable">$&#123;BACKUP_DIR&#125;</span>/<span class="hljs-variable">$&#123;BACKUP_NAME&#125;</span>&quot;</span><br>    <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$&#123;BACKUP_DIR&#125;</span>/<span class="hljs-variable">$&#123;BACKUP_NAME&#125;</span><br>&#125;<br><br><span class="hljs-built_in">trap</span> cleanup EXIT<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Running xtrabackup command to create backup files...&quot;</span><br>xtrabackup --backup \<br>    --dump-innodb-buffer-pool \<br>    --parallel=4 \<br>    --compress \<br>    --compress-threads=4 \<br>    --user=<span class="hljs-variable">$&#123;MYSQL_BACKUP_USER&#125;</span> \<br>    --target-dir=<span class="hljs-variable">$&#123;BACKUP_DIR&#125;</span>/<span class="hljs-variable">$&#123;BACKUP_NAME&#125;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Copy MySQL config [<span class="hljs-variable">$&#123;MYSQL_CONFIG&#125;</span>] to backup dir...&quot;</span><br><span class="hljs-built_in">cp</span> <span class="hljs-variable">$&#123;MYSQL_CONFIG&#125;</span> <span class="hljs-variable">$&#123;BACKUP_DIR&#125;</span>/<span class="hljs-variable">$&#123;BACKUP_NAME&#125;</span>/mysqld.cnf.xtra<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Generate backup information...&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$(mysql -V)</span>&quot;</span> &gt; <span class="hljs-variable">$&#123;BACKUP_DIR&#125;</span>/<span class="hljs-variable">$&#123;BACKUP_NAME&#125;</span>/mysql_backup.info<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span> &gt;&gt; <span class="hljs-variable">$&#123;BACKUP_DIR&#125;</span>/<span class="hljs-variable">$&#123;BACKUP_NAME&#125;</span>/mysql_backup.info<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$(xtrabackup -v)</span>&quot;</span> &gt;&gt; <span class="hljs-variable">$&#123;BACKUP_DIR&#125;</span>/<span class="hljs-variable">$&#123;BACKUP_NAME&#125;</span>/mysql_backup.info<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Pack backup files...&quot;</span><br>tar -C <span class="hljs-variable">$&#123;BACKUP_DIR&#125;</span> -cvf <span class="hljs-variable">$&#123;BACKUP_DIR&#125;</span>/<span class="hljs-variable">$&#123;BACKUP_NAME&#125;</span>.tar <span class="hljs-variable">$&#123;BACKUP_NAME&#125;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;New Backup File ---&gt; <span class="hljs-variable">$&#123;BACKUP_DIR&#125;</span>/<span class="hljs-variable">$&#123;BACKUP_NAME&#125;</span>.tar&quot;</span><br></code></pre></td></tr></table></figure><p><strong>restore.sh</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/usr/bin/env bash</span><br><br><span class="hljs-built_in">set</span> -ex<br><br>BACKUP_FILE=<span class="hljs-variable">$&#123;1:-&quot;&quot;&#125;</span><br><br><span class="hljs-keyword">if</span> [ ! <span class="hljs-variable">$&#123;BACKUP_FILE&#125;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;BACKUP_FILE is empty.&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br>tar -xvf <span class="hljs-variable">$&#123;BACKUP_FILE&#125;</span><br><br>BACKUP_FILE_DIR=<span class="hljs-variable">$&#123;BACKUP_FILE%\.tar&#125;</span><br><br>systemctl stop mysql<br><br><span class="hljs-comment"># clean old config and data file</span><br><span class="hljs-built_in">rm</span> -rf /etc/mysql/mysql.conf.d/mysqld.cnf /var/lib/mysql/ /var/lib/mysql-keyring/ /var/lib/mysql-files/ /var/log/mysql/ /data/mysql/<br><br><span class="hljs-comment"># create dir</span><br><span class="hljs-built_in">mkdir</span> -p /data/mysql/&#123;binlogs,mysql_data,mysql_tmp&#125; /var/lib/mysql/ /var/lib/mysql-keyring/ /var/lib/mysql-files/ /var/log/mysql/<br><br><span class="hljs-comment"># modify permissions</span><br><span class="hljs-built_in">chown</span> -R mysql:mysql /data/mysql /var/lib/mysql/ /var/lib/mysql-keyring/ /var/lib/mysql-files/ /var/log/mysql/<br><br><span class="hljs-comment"># copy config file</span><br><span class="hljs-built_in">cp</span> <span class="hljs-variable">$&#123;BACKUP_FILE_DIR&#125;</span>/mysqld.cnf.xtra /etc/mysql/mysql.conf.d/mysqld.cnf<br><br><span class="hljs-comment"># xtrabackup process</span><br>xtrabackup --decompress --parallel=4 --target-dir=<span class="hljs-variable">$&#123;BACKUP_FILE_DIR&#125;</span><br>xtrabackup --prepare --target-dir=<span class="hljs-variable">$&#123;BACKUP_FILE_DIR&#125;</span><br>xtrabackup --defaults-file=/etc/mysql/mysql.conf.d/mysqld.cnf --copy-back --target-dir=<span class="hljs-variable">$&#123;BACKUP_FILE_DIR&#125;</span><br><br><span class="hljs-comment"># modify permissions</span><br><span class="hljs-built_in">chown</span> -R mysql:mysql /data/mysql<br></code></pre></td></tr></table></figure><h3 id="3-4、SLAVE-创建"><a href="#3-4、SLAVE-创建" class="headerlink" title="3.4、SLAVE 创建"></a>3.4、SLAVE 创建</h3><p>由于真实环境会涉及到 SLAVE 备份, 故本文测试时会加入 SLAVE 节点; SLAVE 创建过程这里不再过多赘述, 具体可以参考 <a target="_blank" rel="noopener" href="https://docs.percona.com/percona-xtrabackup/8.0/set-up-replication.html">How to set up a replica for replication in 6 simple steps with Percona XtraBackup</a>.</p><h2 id="四、测试数据恢复"><a href="#四、测试数据恢复" class="headerlink" title="四、测试数据恢复"></a>四、测试数据恢复</h2><h3 id="4-1、基础恢复"><a href="#4-1、基础恢复" class="headerlink" title="4.1、基础恢复"></a>4.1、基础恢复</h3><p>基础数据恢复流程中将会模拟最理想化的环境: <strong>由于误操作在主库发生了删除, 同时主库临近时间点有完整备份, 且主库的 Binlog 未滚动(与备份时使用相同的 Binlog 文件).</strong> 整个场景的事件发生顺序如图所示:</p><p><img src="https://cdn.oss.link/markdown/vvFe6f.png" srcset="/img/loading.gif" lazyload></p><ul><li>1、在 T1 时刻定时任务执行了 <code>backup.sh</code> 对主库进行了备份</li><li>2、在 T2 时刻执行 <code>UPDATE userinfo SET idno=1111111 WHERE id = 8</code> 数据发生了更改</li><li>3、在 T3 时刻误操作删除了数据(<code>DELETE FROM userinfo WHERE id = 8</code>), 我们需要找回误删除的数据</li></ul><p>数据变化过程如下图所示:</p><p><img src="https://cdn.oss.link/markdown/6r8fH7.png" srcset="/img/loading.gif" lazyload alt="T1 时刻"></p><p><img src="https://cdn.oss.link/markdown/fs346k.png" srcset="/img/loading.gif" lazyload alt="T2 时刻"></p><p><img src="https://cdn.oss.link/markdown/TQFc8x.png" srcset="/img/loading.gif" lazyload alt="T3 时刻"></p><h4 id="4-1-1、恢复备份"><a href="#4-1-1、恢复备份" class="headerlink" title="4.1.1、恢复备份"></a>4.1.1、恢复备份</h4><p>在这种情况下首先要做的就是立即使用主库在 T1 时刻的完整备份在测试库进行还原, <strong>保证测试库与备份时刻的数据一致</strong>:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 复制备份文件</span><br>root@bintest1 ~ <span class="hljs-comment"># ❯❯❯ scp /data/mysql_backup/full_20240110182316.tar 172.16.11.253:~</span><br><br><span class="hljs-comment"># 恢复 MySQL 备份</span><br>root@bintest3 ~ <span class="hljs-comment"># ❯❯❯ ./restore.sh full_20240110182316.tar</span><br></code></pre></td></tr></table></figure><p>由于备份是在 T1 时刻创建的, 所以备份不包含 T2 时刻的修改; 也就是说备份数据还原后应该与初始化数据一致:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> userinfo;<br><span class="hljs-operator">+</span><span class="hljs-comment">----+--------------+--------------------+-----------------------------------------------------------------------------------+---------------------+</span><br><span class="hljs-operator">|</span> id <span class="hljs-operator">|</span> name         <span class="hljs-operator">|</span> idno               <span class="hljs-operator">|</span> address                                                                           <span class="hljs-operator">|</span> create_time         <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+--------------+--------------------+-----------------------------------------------------------------------------------+---------------------+</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">1</span> <span class="hljs-operator">|</span> 李瑞芳       <span class="hljs-operator">|</span> <span class="hljs-number">636920199802136451</span> <span class="hljs-operator">|</span> 山西省临汾市顺靯路<span class="hljs-number">5032</span>号疞嶥小区<span class="hljs-number">14</span>单元<span class="hljs-number">2141</span>室                                      <span class="hljs-operator">|</span> <span class="hljs-number">2024</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">13</span>:<span class="hljs-number">53</span>:<span class="hljs-number">07</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">2</span> <span class="hljs-operator">|</span> 方方竣       <span class="hljs-operator">|</span> <span class="hljs-number">146324198806075248</span> <span class="hljs-operator">|</span> 甘肃省天水市婄煄路<span class="hljs-number">3816</span>号没卾小区<span class="hljs-number">17</span>单元<span class="hljs-number">229</span>室                                       <span class="hljs-operator">|</span> <span class="hljs-number">2024</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">13</span>:<span class="hljs-number">53</span>:<span class="hljs-number">07</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">3</span> <span class="hljs-operator">|</span> 常明珠       <span class="hljs-operator">|</span> <span class="hljs-number">441439198304217281</span> <span class="hljs-operator">|</span> 湖南省湘西土家族苗族自治州僄籓路<span class="hljs-number">3511</span>号贪堕小区<span class="hljs-number">7</span>单元<span class="hljs-number">2074</span>室                         <span class="hljs-operator">|</span> <span class="hljs-number">2024</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">13</span>:<span class="hljs-number">53</span>:<span class="hljs-number">07</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">4</span> <span class="hljs-operator">|</span> 陆奕然       <span class="hljs-operator">|</span> <span class="hljs-number">629162201311010724</span> <span class="hljs-operator">|</span> 广西壮族自治区玉林市秈瑨路<span class="hljs-number">704</span>号鮗捤小区<span class="hljs-number">11</span>单元<span class="hljs-number">2409</span>室                               <span class="hljs-operator">|</span> <span class="hljs-number">2024</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">13</span>:<span class="hljs-number">53</span>:<span class="hljs-number">07</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">5</span> <span class="hljs-operator">|</span> 郝博雅       <span class="hljs-operator">|</span> <span class="hljs-number">138088201811117959</span> <span class="hljs-operator">|</span> 河南省驻马店市紎筦路<span class="hljs-number">1380</span>号攃摍小区<span class="hljs-number">13</span>单元<span class="hljs-number">2363</span>室                                    <span class="hljs-operator">|</span> <span class="hljs-number">2024</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">13</span>:<span class="hljs-number">53</span>:<span class="hljs-number">07</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">6</span> <span class="hljs-operator">|</span> 夏婉君       <span class="hljs-operator">|</span> <span class="hljs-number">122839198907076789</span> <span class="hljs-operator">|</span> 山西省忻州市聜鳁路<span class="hljs-number">24</span>号詿臜小区<span class="hljs-number">12</span>单元<span class="hljs-number">1961</span>室                                        <span class="hljs-operator">|</span> <span class="hljs-number">2024</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">13</span>:<span class="hljs-number">53</span>:<span class="hljs-number">07</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">7</span> <span class="hljs-operator">|</span> 邱新宜       <span class="hljs-operator">|</span> <span class="hljs-number">129192199311154795</span> <span class="hljs-operator">|</span> 辽宁省葫芦岛市攣盗路<span class="hljs-number">7356</span>号嚓檧小区<span class="hljs-number">14</span>单元<span class="hljs-number">1326</span>室                                    <span class="hljs-operator">|</span> <span class="hljs-number">2024</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">13</span>:<span class="hljs-number">53</span>:<span class="hljs-number">07</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">8</span> <span class="hljs-operator">|</span> 吴东         <span class="hljs-operator">|</span> <span class="hljs-number">642398199908131195</span> <span class="hljs-operator">|</span> 陕西省渭南市污岕路<span class="hljs-number">1288</span>号鯭蕄小区<span class="hljs-number">10</span>单元<span class="hljs-number">1252</span>室                                      <span class="hljs-operator">|</span> <span class="hljs-number">2024</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">13</span>:<span class="hljs-number">53</span>:<span class="hljs-number">07</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>  <span class="hljs-number">9</span> <span class="hljs-operator">|</span> 尉迟妙己     <span class="hljs-operator">|</span> <span class="hljs-number">719031198308109317</span> <span class="hljs-operator">|</span> 陕西省宝鸡市逳彄路<span class="hljs-number">1441</span>号骘鼽小区<span class="hljs-number">11</span>单元<span class="hljs-number">1128</span>室                                      <span class="hljs-operator">|</span> <span class="hljs-number">2024</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">13</span>:<span class="hljs-number">53</span>:<span class="hljs-number">07</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> <span class="hljs-number">10</span> <span class="hljs-operator">|</span> 公孙昱晔     <span class="hljs-operator">|</span> <span class="hljs-number">372078200010227375</span> <span class="hljs-operator">|</span> 福建省莆田市顪夹路<span class="hljs-number">4222</span>号蝣宣小区<span class="hljs-number">2</span>单元<span class="hljs-number">2046</span>室                                       <span class="hljs-operator">|</span> <span class="hljs-number">2024</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">13</span>:<span class="hljs-number">53</span>:<span class="hljs-number">07</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----+--------------+--------------------+-----------------------------------------------------------------------------------+---------------------+</span><br><span class="hljs-number">10</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br></code></pre></td></tr></table></figure><h4 id="4-1-2、找到起始-Pos-点"><a href="#4-1-2、找到起始-Pos-点" class="headerlink" title="4.1.2、找到起始 Pos 点"></a>4.1.2、找到起始 Pos 点</h4><p>由于 Binlog 恢复逻辑就是重复执行, 所以对于起始 Pos 点来说就是备份时间的 Pos 点; 这里可以直接从 xtrabackup 备份文件中找到:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@bintest3 ~ <span class="hljs-comment"># ❯❯❯ cat full_20240110182316/xtrabackup_binlog_info</span><br>mysql-bin.000007        157<br></code></pre></td></tr></table></figure><h4 id="4-1-3、找到结束-Pos-点"><a href="#4-1-3、找到结束-Pos-点" class="headerlink" title="4.1.3、找到结束 Pos 点"></a>4.1.3、找到结束 Pos 点</h4><p>对于结束 Pos 点来说, 它应当是执行数据误删除(<code>DELETE FROM userinfo WHERE id = 8</code>)之前的最后一个点, 这里就需要借助 mysqlbinlog 命令来进行查找和解析:</p><p><strong>首先在主库查看当前使用的 Binlog</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">mysql&gt; show master status;<br>+------------------+----------+--------------+------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |<br>+------------------+----------+--------------+------------------+-------------------+<br>| mysql-bin.000007 |     1048 |              |                  |                   |<br>+------------------+----------+--------------+------------------+-------------------+<br>1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><p><strong>接下来通过 mysqlbinlog 工具转换成 SQL 并进行搜索</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs sql">root<span class="hljs-variable">@bintest1</span> <span class="hljs-operator">~</span> # ❯❯❯ mysqlbinlog <span class="hljs-comment">--no-defaults /data/mysql/binlogs/mysql-bin.000007 -vv | grep -A 20 -B 20 &#x27;DELETE&#x27;</span><br><span class="hljs-comment">/*!80014 SET @@session.immediate_server_version=80035*/</span><span class="hljs-comment">/*!*/</span>;<br><span class="hljs-keyword">SET</span> @<span class="hljs-variable">@SESSION</span>.GTID_NEXT<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ANONYMOUS&#x27;</span><span class="hljs-comment">/*!*/</span>;<br># <span class="hljs-keyword">at</span> <span class="hljs-number">739</span><br>#<span class="hljs-number">240110</span> <span class="hljs-number">18</span>:<span class="hljs-number">38</span>:<span class="hljs-number">14</span> server id <span class="hljs-number">11251</span>  end_log_pos <span class="hljs-number">817</span> CRC32 <span class="hljs-number">0x747d3221</span>      Query   thread_id<span class="hljs-operator">=</span><span class="hljs-number">12</span>    exec_time<span class="hljs-operator">=</span><span class="hljs-number">0</span>     error_code<span class="hljs-operator">=</span><span class="hljs-number">0</span><br><span class="hljs-keyword">SET</span> <span class="hljs-type">TIMESTAMP</span><span class="hljs-operator">=</span><span class="hljs-number">1704883094</span><span class="hljs-comment">/*!*/</span>;<br><span class="hljs-keyword">BEGIN</span><br><span class="hljs-comment">/*!*/</span>;<br># <span class="hljs-keyword">at</span> <span class="hljs-number">817</span><br>#<span class="hljs-number">240110</span> <span class="hljs-number">18</span>:<span class="hljs-number">38</span>:<span class="hljs-number">14</span> server id <span class="hljs-number">11251</span>  end_log_pos <span class="hljs-number">888</span> CRC32 <span class="hljs-number">0xd733973c</span>      Table_map: `bintest`.`userinfo` mapped <span class="hljs-keyword">to</span> number <span class="hljs-number">89</span><br># has_generated_invisible_primary_key<span class="hljs-operator">=</span><span class="hljs-number">0</span><br># <span class="hljs-keyword">at</span> <span class="hljs-number">888</span>  <span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;</span> 删除前 Pos 点<br>#<span class="hljs-number">240110</span> <span class="hljs-number">18</span>:<span class="hljs-number">38</span>:<span class="hljs-number">14</span> server id <span class="hljs-number">11251</span>  end_log_pos <span class="hljs-number">1017</span> CRC32 <span class="hljs-number">0x9ea5d5b0</span>     Delete_rows: <span class="hljs-keyword">table</span> id <span class="hljs-number">89</span> flags: STMT_END_F<br><br>BINLOG <span class="hljs-string">&#x27;</span><br><span class="hljs-string">lnOeZRPzKwAARwAAAHgDAAAAAFkAAAAAAAEAB2JpbnRlc3QACHVzZXJpbmZvAAUIDw8PEgf8A/wD</span><br><span class="hljs-string">/AMAAAEBAAIB4DyXM9c=</span><br><span class="hljs-string">lnOeZSDzKwAAgQAAAPkDAAAAAFkAAAAAAAEAAgAF/wAIAAAAAAAAAAYA5ZC05LicBwAxMTExMTEx</span><br><span class="hljs-string">PQDpmZXopb/nnIHmuK3ljZfluILmsaHlspXot68xMjg45Y+36a+t6JWE5bCP5Yy6MTDljZXlhYMx</span><br><span class="hljs-string">MjUy5a6kmbJK3Uew1aWe</span><br><span class="hljs-string">&#x27;</span><span class="hljs-comment">/*!*/</span>;<br>### <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> `bintest`.`userinfo`<br>### <span class="hljs-keyword">WHERE</span><br>###   <span class="hljs-variable">@1</span><span class="hljs-operator">=</span><span class="hljs-number">8</span> <span class="hljs-comment">/* LONGINT meta=0 nullable=0 is_null=0 */</span><br>###   <span class="hljs-variable">@2</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;吴东&#x27;</span> <span class="hljs-comment">/* VARSTRING(1020) meta=1020 nullable=0 is_null=0 */</span><br>###   <span class="hljs-variable">@3</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;1111111&#x27;</span> <span class="hljs-comment">/* VARSTRING(1020) meta=1020 nullable=0 is_null=0 */</span><br>###   <span class="hljs-variable">@4</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;陕西省渭南市污岕路1288号鯭蕄小区10单元1252室&#x27;</span> <span class="hljs-comment">/* VARSTRING(1020) meta=1020 nullable=0 is_null=0 */</span><br>###   <span class="hljs-variable">@5</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;2024-01-05 13:53:07&#x27;</span> <span class="hljs-comment">/* DATETIME(0) meta=0 nullable=0 is_null=0 */</span><br># <span class="hljs-keyword">at</span> <span class="hljs-number">1017</span><br>#<span class="hljs-number">240110</span> <span class="hljs-number">18</span>:<span class="hljs-number">38</span>:<span class="hljs-number">14</span> server id <span class="hljs-number">11251</span>  end_log_pos <span class="hljs-number">1048</span> CRC32 <span class="hljs-number">0x60cc5630</span>     Xid <span class="hljs-operator">=</span> <span class="hljs-number">55</span><br><span class="hljs-keyword">COMMIT</span><span class="hljs-comment">/*!*/</span>;<br><span class="hljs-keyword">SET</span> @<span class="hljs-variable">@SESSION</span>.GTID_NEXT<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;AUTOMATIC&#x27;</span> <span class="hljs-comment">/* added by mysqlbinlog */</span> <span class="hljs-comment">/*!*/</span>;<br>DELIMITER ;<br># <span class="hljs-keyword">End</span> <span class="hljs-keyword">of</span> log file<br><span class="hljs-comment">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/</span>;<br><span class="hljs-comment">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/</span>;<br></code></pre></td></tr></table></figure><p>通过查看生成的 SQL 可以看到, 在删除之前的最后一个 Pos 点为 <code>888</code>.</p><h4 id="4-1-4、生成重做-SQL"><a href="#4-1-4、生成重做-SQL" class="headerlink" title="4.1.4、生成重做 SQL"></a>4.1.4、生成重做 SQL</h4><p>有了起始 Pos 点和结束 Pos 点, 我们就可以在主库上通过 Binlog 来生成 <strong>从备份到删除之前所有的执行 SQL</strong>:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@bintest1 ~ <span class="hljs-comment"># ❯❯❯ mysqlbinlog --no-defaults /data/mysql/binlogs/mysql-bin.000007 -vv --start-position=157 --stop-position=888 &gt; ~/redo.sql</span><br></code></pre></td></tr></table></figure><h4 id="4-1-5、恢复数据到删除前"><a href="#4-1-5、恢复数据到删除前" class="headerlink" title="4.1.5、恢复数据到删除前"></a>4.1.5、恢复数据到删除前</h4><p>有了重做 SQL 以后, 我们就可以直接在测试库上重新应用它, 让测试库 “回到” 被删除之前的状态:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 复制重做 SQL 到测试库</span><br>root@bintest1 ~ <span class="hljs-comment"># ❯❯❯ scp redo.sql 172.16.11.253:~</span><br><br><span class="hljs-comment"># 执行应用</span><br>root@bintest3 ~ <span class="hljs-comment"># ❯❯❯ mysql &lt; redo.sql</span><br></code></pre></td></tr></table></figure><p>接下来可以在测试库查看恢复结果, 测试库应该回到了 T2 时刻即删除前的最后一刻:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@bintest3 ~ <span class="hljs-comment"># ❯❯❯ mysql</span><br>mysql&gt; <span class="hljs-keyword">select</span> * from userinfo;<br>+----+--------------+--------------------+-----------------------------------------------------------------------------------+---------------------+<br>| <span class="hljs-built_in">id</span> | name         | idno               | address                                                                           | create_time         |<br>+----+--------------+--------------------+-----------------------------------------------------------------------------------+---------------------+<br>|  1 | 李瑞芳       | 636920199802136451 | 山西省临汾市顺靯路5032号疞嶥小区14单元2141室                                      | 2024-01-05 13:53:07 |<br>|  2 | 方方竣       | 146324198806075248 | 甘肃省天水市婄煄路3816号没卾小区17单元229室                                       | 2024-01-05 13:53:07 |<br>|  3 | 常明珠       | 441439198304217281 | 湖南省湘西土家族苗族自治州僄籓路3511号贪堕小区7单元2074室                         | 2024-01-05 13:53:07 |<br>|  4 | 陆奕然       | 629162201311010724 | 广西壮族自治区玉林市秈瑨路704号鮗捤小区11单元2409室                               | 2024-01-05 13:53:07 |<br>|  5 | 郝博雅       | 138088201811117959 | 河南省驻马店市紎筦路1380号攃摍小区13单元2363室                                    | 2024-01-05 13:53:07 |<br>|  6 | 夏婉君       | 122839198907076789 | 山西省忻州市聜鳁路24号詿臜小区12单元1961室                                        | 2024-01-05 13:53:07 |<br>|  7 | 邱新宜       | 129192199311154795 | 辽宁省葫芦岛市攣盗路7356号嚓檧小区14单元1326室                                    | 2024-01-05 13:53:07 |<br>|  8 | 吴东         | 1111111            | 陕西省渭南市污岕路1288号鯭蕄小区10单元1252室                                      | 2024-01-05 13:53:07 |<br>|  9 | 尉迟妙己     | 719031198308109317 | 陕西省宝鸡市逳彄路1441号骘鼽小区11单元1128室                                      | 2024-01-05 13:53:07 |<br>| 10 | 公孙昱晔     | 372078200010227375 | 福建省莆田市顪夹路4222号蝣宣小区2单元2046室                                       | 2024-01-05 13:53:07 |<br>+----+--------------+--------------------+-----------------------------------------------------------------------------------+---------------------+<br>10 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><p><strong>最后提取数据重新还原到主库即可.</strong></p><h4 id="4-1-6、时间点恢复"><a href="#4-1-6、时间点恢复" class="headerlink" title="4.1.6、时间点恢复"></a>4.1.6、时间点恢复</h4><p>起始除了使用 Pos 点恢复以外, 还可以根据时间来进行恢复, 前提你能精准的把控删除发生的时间以及备份的时间:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 按时间点生成重做 SQL</span><br>root@bintest1 ~ <span class="hljs-comment"># ❯❯❯ mysqlbinlog --no-defaults /data/mysql/binlogs/mysql-bin.000007 -vv --start-datetime=&quot;2024-01-10 18:23:16&quot; --stop-datetime=&quot;2024-01-10 18:38:00&quot; &gt; ~/redo.sql</span><br></code></pre></td></tr></table></figure><p>总体来说按照时间点恢复可能会有一些误差, 比如同一时刻发生很多修改; 但是如果你能完全确定<strong>删除发生时间</strong>也不失为一个简单方法.</p><h3 id="4-2、多-Binlog-恢复"><a href="#4-2、多-Binlog-恢复" class="headerlink" title="4.2、多 Binlog 恢复"></a>4.2、多 Binlog 恢复</h3><p>多 Binlog 恢复流程中假设在非理想情况下, T1 时刻进行备份, T2 时刻更改数据后主库 Binlog 发生了滚动, 然后在 T3 时刻数据被删除; 整个流程中复杂的点为 <strong>在备份时间(T1)到数据删除时间(T3)之间可能发生多次 Binlog 滚动, 这时我们必须联合多个 Binlog 文件来生成重做 SQL.</strong></p><p><img src="https://cdn.oss.link/markdown/nwep51.png" srcset="/img/loading.gif" lazyload></p><h4 id="4-2-1、找到起始-Pos-点"><a href="#4-2-1、找到起始-Pos-点" class="headerlink" title="4.2.1、找到起始 Pos 点"></a>4.2.1、找到起始 Pos 点</h4><p>备份恢复步骤与 4.1 部分相同, 这里暂且省略; 查找起始 Pos 点采用同样的方法, 直接查看备份文件:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@bintest3 ~ <span class="hljs-comment"># ❯❯❯ cat full_20240111152100/xtrabackup_binlog_info</span><br>mysql-bin.000007        157<br></code></pre></td></tr></table></figure><h4 id="4-2-2、找到结束-Pos-点"><a href="#4-2-2、找到结束-Pos-点" class="headerlink" title="4.2.2、找到结束 Pos 点"></a>4.2.2、找到结束 Pos 点</h4><p>查找结束 Pos 点大致方法相同, 但是需要注意的是 Binlog 已经发生过滚动, 所以我们在过滤时需要联合多个 Binlog 进行查找:</p><p><strong>首先查看当前主库的 Binlog 与备份 Binlog, 通过对比确定中间还有哪些 Binlog</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> master status;<br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+----------+--------------+------------------+-------------------+</span><br><span class="hljs-operator">|</span> File             <span class="hljs-operator">|</span> Position <span class="hljs-operator">|</span> Binlog_Do_DB <span class="hljs-operator">|</span> Binlog_Ignore_DB <span class="hljs-operator">|</span> Executed_Gtid_Set <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+----------+--------------+------------------+-------------------+</span><br><span class="hljs-operator">|</span> mysql<span class="hljs-operator">-</span>bin<span class="hljs-number">.000010</span> <span class="hljs-operator">|</span>     <span class="hljs-number">1263</span> <span class="hljs-operator">|</span>              <span class="hljs-operator">|</span>                  <span class="hljs-operator">|</span>                   <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+----------+--------------+------------------+-------------------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br></code></pre></td></tr></table></figure><p><strong>可以看到, 主库 Binlog 已经滚动到 <code>mysql-bin.000010</code>, 而备份时的 Binlog 为 <code>mysql-bin.000007</code>, 这意味着我们需要搜索 7、8、9、10 四个 Binlog 来确定删除到底发生在哪里, 从而得到结束 Pos 点:</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs sql">root<span class="hljs-variable">@bintest1</span> <span class="hljs-operator">~</span> # ❯❯❯ mysqlbinlog <span class="hljs-comment">--no-defaults /data/mysql/binlogs/mysql-bin.0000&#123;07,08,09,10&#125; -vv | grep -A 20 -B 20 &#x27;DELETE FROM `bintest`.`userinfo`&#x27;</span><br># <span class="hljs-keyword">at</span> <span class="hljs-number">954</span><br>#<span class="hljs-number">240111</span> <span class="hljs-number">15</span>:<span class="hljs-number">25</span>:<span class="hljs-number">54</span> server id <span class="hljs-number">11251</span>  end_log_pos <span class="hljs-number">1032</span> CRC32 <span class="hljs-number">0x85eabcc8</span>     Query   thread_id<span class="hljs-operator">=</span><span class="hljs-number">12</span>    exec_time<span class="hljs-operator">=</span><span class="hljs-number">0</span>     error_code<span class="hljs-operator">=</span><span class="hljs-number">0</span><br><span class="hljs-keyword">SET</span> <span class="hljs-type">TIMESTAMP</span><span class="hljs-operator">=</span><span class="hljs-number">1704957954</span><span class="hljs-comment">/*!*/</span>;<br><span class="hljs-comment">/*!\C utf8mb4 */</span><span class="hljs-comment">/*!*/</span>;<br><span class="hljs-keyword">SET</span> @<span class="hljs-variable">@session</span>.character_set_client<span class="hljs-operator">=</span><span class="hljs-number">45</span>,@<span class="hljs-variable">@session</span>.collation_connection<span class="hljs-operator">=</span><span class="hljs-number">45</span>,@<span class="hljs-variable">@session</span>.collation_server<span class="hljs-operator">=</span><span class="hljs-number">45</span><span class="hljs-comment">/*!*/</span>;<br><span class="hljs-keyword">BEGIN</span><br><span class="hljs-comment">/*!*/</span>;<br># <span class="hljs-keyword">at</span> <span class="hljs-number">1032</span><br>#<span class="hljs-number">240111</span> <span class="hljs-number">15</span>:<span class="hljs-number">25</span>:<span class="hljs-number">54</span> server id <span class="hljs-number">11251</span>  end_log_pos <span class="hljs-number">1103</span> CRC32 <span class="hljs-number">0x08a5a623</span>     Table_map: `bintest`.`userinfo` mapped <span class="hljs-keyword">to</span> number <span class="hljs-number">89</span><br># has_generated_invisible_primary_key<span class="hljs-operator">=</span><span class="hljs-number">0</span><br># <span class="hljs-keyword">at</span> <span class="hljs-number">1103</span>  <span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;</span> 删除前 Pos 点<br>#<span class="hljs-number">240111</span> <span class="hljs-number">15</span>:<span class="hljs-number">25</span>:<span class="hljs-number">54</span> server id <span class="hljs-number">11251</span>  end_log_pos <span class="hljs-number">1232</span> CRC32 <span class="hljs-number">0x95e1f664</span>     Delete_rows: <span class="hljs-keyword">table</span> id <span class="hljs-number">89</span> flags: STMT_END_F<br><br>BINLOG <span class="hljs-string">&#x27;</span><br><span class="hljs-string">ApifZRPzKwAARwAAAE8EAAAAAFkAAAAAAAEAB2JpbnRlc3QACHVzZXJpbmZvAAUIDw8PEgf8A/wD</span><br><span class="hljs-string">/AMAAAEBAAIB4COmpQg=</span><br><span class="hljs-string">ApifZSDzKwAAgQAAANAEAAAAAFkAAAAAAAEAAgAF/wAIAAAAAAAAAAYA5ZC05LicBwAxMTExMTEx</span><br><span class="hljs-string">PQDpmZXopb/nnIHmuK3ljZfluILmsaHlspXot68xMjg45Y+36a+t6JWE5bCP5Yy6MTDljZXlhYMx</span><br><span class="hljs-string">MjUy5a6kmbJK3Udk9uGV</span><br><span class="hljs-string">&#x27;</span><span class="hljs-comment">/*!*/</span>;<br>### <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> `bintest`.`userinfo`<br>### <span class="hljs-keyword">WHERE</span><br>###   <span class="hljs-variable">@1</span><span class="hljs-operator">=</span><span class="hljs-number">8</span> <span class="hljs-comment">/* LONGINT meta=0 nullable=0 is_null=0 */</span><br>###   <span class="hljs-variable">@2</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;吴东&#x27;</span> <span class="hljs-comment">/* VARSTRING(1020) meta=1020 nullable=0 is_null=0 */</span><br>###   <span class="hljs-variable">@3</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;1111111&#x27;</span> <span class="hljs-comment">/* VARSTRING(1020) meta=1020 nullable=0 is_null=0 */</span><br>###   <span class="hljs-variable">@4</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;陕西省渭南市污岕路1288号鯭蕄小区10单元1252室&#x27;</span> <span class="hljs-comment">/* VARSTRING(1020) meta=1020 nullable=0 is_null=0 */</span><br>###   <span class="hljs-variable">@5</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;2024-01-05 13:53:07&#x27;</span> <span class="hljs-comment">/* DATETIME(0) meta=0 nullable=0 is_null=0 */</span><br># <span class="hljs-keyword">at</span> <span class="hljs-number">1232</span><br>#<span class="hljs-number">240111</span> <span class="hljs-number">15</span>:<span class="hljs-number">25</span>:<span class="hljs-number">54</span> server id <span class="hljs-number">11251</span>  end_log_pos <span class="hljs-number">1263</span> CRC32 <span class="hljs-number">0x25708781</span>     Xid <span class="hljs-operator">=</span> <span class="hljs-number">359</span><br><span class="hljs-keyword">COMMIT</span><span class="hljs-comment">/*!*/</span>;<br><span class="hljs-keyword">SET</span> @<span class="hljs-variable">@SESSION</span>.GTID_NEXT<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;AUTOMATIC&#x27;</span> <span class="hljs-comment">/* added by mysqlbinlog */</span> <span class="hljs-comment">/*!*/</span>;<br>DELIMITER ;<br># <span class="hljs-keyword">End</span> <span class="hljs-keyword">of</span> log file<br><span class="hljs-comment">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/</span>;<br><span class="hljs-comment">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/</span>;<br></code></pre></td></tr></table></figure><p>从生成的 SQL 中可以看到, 结束的 Pos 点为 <code>1103</code>.</p><h4 id="4-2-3、生成重做-SQL"><a href="#4-2-3、生成重做-SQL" class="headerlink" title="4.2.3、生成重做 SQL"></a>4.2.3、生成重做 SQL</h4><p>在涉及到多个 Binlog 文件, 通过起始 Pos 点生成重做 SQL 时需要注意一点: <strong>Pos 点不是一直自增的, 它是在每个 Binlog 中自增, 所以如果直接联合所有 Binlog 使用起始 Pos 点(157~1103) 来生成重做 SQL 是有问题的:</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 错误示例</span><br>root@bintest1 ~ <span class="hljs-comment"># ❯❯❯ mysqlbinlog --no-defaults /data/mysql/binlogs/mysql-bin.0000&#123;07,08,09,10&#125; -vv --start-position=157 --stop-position=1103 &gt; ~/redo.sql</span><br></code></pre></td></tr></table></figure><p><strong>因为在 <code>mysql-bin.000009</code> 中 Pos 点可能增长到 1500, 然后在 <code>mysql-bin.000010</code> 中重新从 <code>157</code> 开始;</strong> 直接这样生成的重做 SQL 会丢失一部分数据, 正确做法是<strong>为每个中间 Binlog 生成完整重做 SQL, 然后再以起始 Pos 点为边界为两端 Binlog 生成重做 SQL:</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 起始 Binlog + 起始 Pos 点</span><br>root@bintest1 ~ <span class="hljs-comment"># ❯❯❯ mysqlbinlog --no-defaults /data/mysql/binlogs/mysql-bin.000007 -vv --start-position=157 &gt; ~/redo.sql</span><br><br><span class="hljs-comment"># 中间 Binlog 全量</span><br>root@bintest1 ~ <span class="hljs-comment"># ❯❯❯ mysqlbinlog --no-defaults /data/mysql/binlogs/mysql-bin.000008 -vv &gt;&gt; ~/redo.sql</span><br>root@bintest1 ~ <span class="hljs-comment"># ❯❯❯ mysqlbinlog --no-defaults /data/mysql/binlogs/mysql-bin.000009 -vv &gt;&gt; ~/redo.sql</span><br><br><span class="hljs-comment"># 结束 Binlog + 结束 Pos 点</span><br>root@bintest1 ~ <span class="hljs-comment"># ❯❯❯ mysqlbinlog --no-defaults /data/mysql/binlogs/mysql-bin.000010 -vv --stop-position=1103 &gt;&gt; ~/redo.sql</span><br></code></pre></td></tr></table></figure><h4 id="4-2-4、恢复数据到删除前"><a href="#4-2-4、恢复数据到删除前" class="headerlink" title="4.2.4、恢复数据到删除前"></a>4.2.4、恢复数据到删除前</h4><p>恢复数据这一步跟上面的操作相同, 直接导入备份数据库然后查看被删除数据, 最后导出恢复到主库即可:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@bintest1 ~ <span class="hljs-comment"># ❯❯❯ scp redo.sql 172.16.11.253:~</span><br>root@bintest3 ~ <span class="hljs-comment"># ❯❯❯ mysql &lt; redo.sql</span><br><br>mysql&gt; <span class="hljs-keyword">select</span> * from userinfo;<br>+----+--------------+--------------------+-----------------------------------------------------------------------------------+---------------------+<br>| <span class="hljs-built_in">id</span> | name         | idno               | address                                                                           | create_time         |<br>+----+--------------+--------------------+-----------------------------------------------------------------------------------+---------------------+<br>|  1 | 李瑞芳       | 636920199802136451 | 山西省临汾市顺靯路5032号疞嶥小区14单元2141室                                      | 2024-01-05 13:53:07 |<br>|  2 | 方方竣       | 146324198806075248 | 甘肃省天水市婄煄路3816号没卾小区17单元229室                                       | 2024-01-05 13:53:07 |<br>|  3 | 常明珠       | 441439198304217281 | 湖南省湘西土家族苗族自治州僄籓路3511号贪堕小区7单元2074室                         | 2024-01-05 13:53:07 |<br>|  4 | 陆奕然       | 629162201311010724 | 广西壮族自治区玉林市秈瑨路704号鮗捤小区11单元2409室                               | 2024-01-05 13:53:07 |<br>|  5 | 郝博雅       | 138088201811117959 | 河南省驻马店市紎筦路1380号攃摍小区13单元2363室                                    | 2024-01-05 13:53:07 |<br>|  6 | 夏婉君       | 122839198907076789 | 山西省忻州市聜鳁路24号詿臜小区12单元1961室                                        | 2024-01-05 13:53:07 |<br>|  7 | 邱新宜       | 129192199311154795 | 辽宁省葫芦岛市攣盗路7356号嚓檧小区14单元1326室                                    | 2024-01-05 13:53:07 |<br>|  8 | 吴东         | 1111111            | 陕西省渭南市污岕路1288号鯭蕄小区10单元1252室                                      | 2024-01-05 13:53:07 |<br>|  9 | 尉迟妙己     | 719031198308109317 | 陕西省宝鸡市逳彄路1441号骘鼽小区11单元1128室                                      | 2024-01-05 13:53:07 |<br>| 10 | 公孙昱晔     | 372078200010227375 | 福建省莆田市顪夹路4222号蝣宣小区2单元2046室                                       | 2024-01-05 13:53:07 |<br>+----+--------------+--------------------+-----------------------------------------------------------------------------------+---------------------+<br>10 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="4-3、从库恢复"><a href="#4-3、从库恢复" class="headerlink" title="4.3、从库恢复"></a>4.3、从库恢复</h3><p>在大多数生产环境, 我们都不会选择直接从主库生成备份, 因为直接从主库生成备份时会产生较大磁盘 IO, 备份文件传输时又会造成网络占用; 大多数情况下我们都会在从库备份, 所以在本流程中假设:</p><ul><li>1、T1 时刻在从库产生了备份</li><li>2、T2 时刻主库产生了数据修改, 且同步到了从库</li><li>3、T3 时刻主库发生了误删除, 我们只有从库的备份</li></ul><p><img src="https://cdn.oss.link/markdown/yMDFHq.png" srcset="/img/loading.gif" lazyload></p><p><strong>在这种复杂环境中, 需要明确一点: 备份只有从库的, 所以一切要以从库为基准, 包括 Binlog Pos 点查找还原等.</strong></p><h4 id="4-3-1、找到起始-Pos-点"><a href="#4-3-1、找到起始-Pos-点" class="headerlink" title="4.3.1、找到起始 Pos 点"></a>4.3.1、找到起始 Pos 点</h4><p>在这种带有从库的环境中, 如果备份是从从库备份的, 那么 Binlog 恢复时仍然应该选择以从库为主进行操作; 对于起始 Pos 点, 仍然<strong>需要查看从库的备份文件</strong>:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 这里略从库备份复制到测试库, 以及测试库恢复过程</span><br>root@bintest3 ~ <span class="hljs-comment"># ❯❯❯ cat full_20240111162313/xtrabackup_binlog_info</span><br>mysql-bin.000009        157<br></code></pre></td></tr></table></figure><h4 id="4-3-2、找到结束-Pos-点"><a href="#4-3-2、找到结束-Pos-点" class="headerlink" title="4.3.2、找到结束 Pos 点"></a>4.3.2、找到结束 Pos 点</h4><p>对于结束 Pos 点来说, <strong>首先要确认数据删除时主库的删除动作成功同步到从库, 然后在从库上根据 Binlog 查询删除动作, 获取结束 Pos 点:</strong></p><p><strong>查询删除后从库的 Pos 点</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 从库 <span class="hljs-number">252</span> 执行<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> master status;<br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+----------+--------------+------------------+-------------------+</span><br><span class="hljs-operator">|</span> File             <span class="hljs-operator">|</span> Position <span class="hljs-operator">|</span> Binlog_Do_DB <span class="hljs-operator">|</span> Binlog_Ignore_DB <span class="hljs-operator">|</span> Executed_Gtid_Set <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+----------+--------------+------------------+-------------------+</span><br><span class="hljs-operator">|</span> mysql<span class="hljs-operator">-</span>bin<span class="hljs-number">.000009</span> <span class="hljs-operator">|</span>     <span class="hljs-number">1043</span> <span class="hljs-operator">|</span>              <span class="hljs-operator">|</span>                  <span class="hljs-operator">|</span>                   <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+----------+--------------+------------------+-------------------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br></code></pre></td></tr></table></figure><p><strong>对比从库备份可得知 Binlog 未发生滚动(如果发生滚动参考 4.2 部分), 接下来查询结束 Pos 点:</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs sql">root<span class="hljs-variable">@bintest2</span> <span class="hljs-operator">~</span> # ❯❯❯ mysqlbinlog <span class="hljs-comment">--no-defaults /data/mysql/binlogs/mysql-bin.000009 -vv | grep -A 20 -B 20 &#x27;DELETE FROM `bintest`.`userinfo`&#x27;</span><br><span class="hljs-comment">/*!80014 SET @@session.immediate_server_version=80035*/</span><span class="hljs-comment">/*!*/</span>;<br><span class="hljs-keyword">SET</span> @<span class="hljs-variable">@SESSION</span>.GTID_NEXT<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ANONYMOUS&#x27;</span><span class="hljs-comment">/*!*/</span>;<br># <span class="hljs-keyword">at</span> <span class="hljs-number">739</span><br>#<span class="hljs-number">240111</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">40</span> server id <span class="hljs-number">11251</span>  end_log_pos <span class="hljs-number">812</span> CRC32 <span class="hljs-number">0x35941d40</span>      Query   thread_id<span class="hljs-operator">=</span><span class="hljs-number">11</span>    exec_time<span class="hljs-operator">=</span><span class="hljs-number">0</span>     error_code<span class="hljs-operator">=</span><span class="hljs-number">0</span><br><span class="hljs-keyword">SET</span> <span class="hljs-type">TIMESTAMP</span><span class="hljs-operator">=</span><span class="hljs-number">1704962020</span><span class="hljs-comment">/*!*/</span>;<br><span class="hljs-keyword">BEGIN</span><br><span class="hljs-comment">/*!*/</span>;<br># <span class="hljs-keyword">at</span> <span class="hljs-number">812</span><br>#<span class="hljs-number">240111</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">40</span> server id <span class="hljs-number">11251</span>  end_log_pos <span class="hljs-number">883</span> CRC32 <span class="hljs-number">0xcfe618de</span>      Table_map: `bintest`.`userinfo` mapped <span class="hljs-keyword">to</span> number <span class="hljs-number">99</span><br># has_generated_invisible_primary_key<span class="hljs-operator">=</span><span class="hljs-number">0</span><br># <span class="hljs-keyword">at</span> <span class="hljs-number">883</span>  <span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;&lt;</span><span class="hljs-operator">&lt;</span> 删除前 Pos 点<br>#<span class="hljs-number">240111</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">40</span> server id <span class="hljs-number">11251</span>  end_log_pos <span class="hljs-number">1012</span> CRC32 <span class="hljs-number">0xd03d3ff0</span>     Delete_rows: <span class="hljs-keyword">table</span> id <span class="hljs-number">99</span> flags: STMT_END_F<br><br>BINLOG <span class="hljs-string">&#x27;</span><br><span class="hljs-string">5KefZRPzKwAARwAAAHMDAAAAAGMAAAAAAAEAB2JpbnRlc3QACHVzZXJpbmZvAAUIDw8PEgf8A/wD</span><br><span class="hljs-string">/AMAAAEBAAIB4N4Y5s8=</span><br><span class="hljs-string">5KefZSDzKwAAgQAAAPQDAAAAAGMAAAAAAAEAAgAF/wAIAAAAAAAAAAYA5ZC05LicBwAxMTExMTEx</span><br><span class="hljs-string">PQDpmZXopb/nnIHmuK3ljZfluILmsaHlspXot68xMjg45Y+36a+t6JWE5bCP5Yy6MTDljZXlhYMx</span><br><span class="hljs-string">MjUy5a6kmbJK3UfwPz3Q</span><br><span class="hljs-string">&#x27;</span><span class="hljs-comment">/*!*/</span>;<br>### <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> `bintest`.`userinfo`<br>### <span class="hljs-keyword">WHERE</span><br>###   <span class="hljs-variable">@1</span><span class="hljs-operator">=</span><span class="hljs-number">8</span> <span class="hljs-comment">/* LONGINT meta=0 nullable=0 is_null=0 */</span><br>###   <span class="hljs-variable">@2</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;吴东&#x27;</span> <span class="hljs-comment">/* VARSTRING(1020) meta=1020 nullable=0 is_null=0 */</span><br>###   <span class="hljs-variable">@3</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;1111111&#x27;</span> <span class="hljs-comment">/* VARSTRING(1020) meta=1020 nullable=0 is_null=0 */</span><br>###   <span class="hljs-variable">@4</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;陕西省渭南市污岕路1288号鯭蕄小区10单元1252室&#x27;</span> <span class="hljs-comment">/* VARSTRING(1020) meta=1020 nullable=0 is_null=0 */</span><br>###   <span class="hljs-variable">@5</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;2024-01-05 13:53:07&#x27;</span> <span class="hljs-comment">/* DATETIME(0) meta=0 nullable=0 is_null=0 */</span><br># <span class="hljs-keyword">at</span> <span class="hljs-number">1012</span><br>#<span class="hljs-number">240111</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">40</span> server id <span class="hljs-number">11251</span>  end_log_pos <span class="hljs-number">1043</span> CRC32 <span class="hljs-number">0x084b4d2e</span>     Xid <span class="hljs-operator">=</span> <span class="hljs-number">88</span><br><span class="hljs-keyword">COMMIT</span><span class="hljs-comment">/*!*/</span>;<br><span class="hljs-keyword">SET</span> @<span class="hljs-variable">@SESSION</span>.GTID_NEXT<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;AUTOMATIC&#x27;</span> <span class="hljs-comment">/* added by mysqlbinlog */</span> <span class="hljs-comment">/*!*/</span>;<br>DELIMITER ;<br># <span class="hljs-keyword">End</span> <span class="hljs-keyword">of</span> log file<br><span class="hljs-comment">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/</span>;<br><span class="hljs-comment">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/</span>;<br></code></pre></td></tr></table></figure><p>从查询结果中可以看到, 删除发生前的结束 Pos 点为 <code>883</code>.</p><h4 id="4-3-3、生成重做-SQL"><a href="#4-3-3、生成重做-SQL" class="headerlink" title="4.3.3、生成重做 SQL"></a>4.3.3、生成重做 SQL</h4><p>有了两个 Pos 点以后, 同样老办法<strong>在从库生成重做 SQL:</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@bintest2 ~ <span class="hljs-comment"># ❯❯❯ mysqlbinlog --no-defaults /data/mysql/binlogs/mysql-bin.000009 -vv --start-position=157 --stop-position=883 &gt; ~/redo.sql</span><br></code></pre></td></tr></table></figure><h4 id="4-3-4、恢复数据到删除前"><a href="#4-3-4、恢复数据到删除前" class="headerlink" title="4.3.4、恢复数据到删除前"></a>4.3.4、恢复数据到删除前</h4><p>同样有了重做 SQL, 只需要<strong>在测试库还原从库备份, 然后在从库备份上应用重做 SQL</strong>, 将数据还原到被删除前, 最后导出恢复到主库即可:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 复制重做 SQL 文件</span><br>root@bintest2 ~ <span class="hljs-comment"># ❯❯❯ scp ~/redo.sql 172.16.11.253:~</span><br><br><span class="hljs-comment"># 应用重做 SQL</span><br>root@bintest3 ~ <span class="hljs-comment"># ❯❯❯ mysql &lt; redo.sql</span><br><br><span class="hljs-comment"># 确认数据状态</span><br>root@bintest3 ~ <span class="hljs-comment"># ❯❯❯ mysql</span><br>mysql&gt; <span class="hljs-keyword">select</span> * from userinfo;<br>+----+--------------+--------------------+-----------------------------------------------------------------------------------+---------------------+<br>| <span class="hljs-built_in">id</span> | name         | idno               | address                                                                           | create_time         |<br>+----+--------------+--------------------+-----------------------------------------------------------------------------------+---------------------+<br>|  1 | 李瑞芳       | 636920199802136451 | 山西省临汾市顺靯路5032号疞嶥小区14单元2141室                                      | 2024-01-05 13:53:07 |<br>|  2 | 方方竣       | 146324198806075248 | 甘肃省天水市婄煄路3816号没卾小区17单元229室                                       | 2024-01-05 13:53:07 |<br>|  3 | 常明珠       | 441439198304217281 | 湖南省湘西土家族苗族自治州僄籓路3511号贪堕小区7单元2074室                         | 2024-01-05 13:53:07 |<br>|  4 | 陆奕然       | 629162201311010724 | 广西壮族自治区玉林市秈瑨路704号鮗捤小区11单元2409室                               | 2024-01-05 13:53:07 |<br>|  5 | 郝博雅       | 138088201811117959 | 河南省驻马店市紎筦路1380号攃摍小区13单元2363室                                    | 2024-01-05 13:53:07 |<br>|  6 | 夏婉君       | 122839198907076789 | 山西省忻州市聜鳁路24号詿臜小区12单元1961室                                        | 2024-01-05 13:53:07 |<br>|  7 | 邱新宜       | 129192199311154795 | 辽宁省葫芦岛市攣盗路7356号嚓檧小区14单元1326室                                    | 2024-01-05 13:53:07 |<br>|  8 | 吴东         | 1111111            | 陕西省渭南市污岕路1288号鯭蕄小区10单元1252室                                      | 2024-01-05 13:53:07 |<br>|  9 | 尉迟妙己     | 719031198308109317 | 陕西省宝鸡市逳彄路1441号骘鼽小区11单元1128室                                      | 2024-01-05 13:53:07 |<br>| 10 | 公孙昱晔     | 372078200010227375 | 福建省莆田市顪夹路4222号蝣宣小区2单元2046室                                       | 2024-01-05 13:53:07 |<br>+----+--------------+--------------------+-----------------------------------------------------------------------------------+---------------------+<br>10 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br></code></pre></td></tr></table></figure><h2 id="五、其他工具"><a href="#五、其他工具" class="headerlink" title="五、其他工具"></a>五、其他工具</h2><h3 id="5-1、bytebase"><a href="#5-1、bytebase" class="headerlink" title="5.1、bytebase"></a>5.1、bytebase</h3><p>强烈推荐有能力的在内网部署 <a target="_blank" rel="noopener" href="https://www.bytebase.com/">Bytebase</a> 工具, 这个工具应该是腾讯出的, 基础特性开源同时也有商用版本; 简单的说<strong>可以把你的数据库修改变为标准的代码协作模式</strong>; 比如提交 PR、Review 合并等, <strong>同时可以针对修改的 SQL 直接生成回滚 SQL,</strong> 出问题可以立即回滚:</p><p><img src="https://cdn.oss.link/markdown/Lp5EhS.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/raYrS8.png" srcset="/img/loading.gif" lazyload></p><h3 id="5-2、canal2sql"><a href="#5-2、canal2sql" class="headerlink" title="5.2、canal2sql"></a>5.2、canal2sql</h3><p>这是一个 Java 编写的工具, 支持在线解析 Binlog, 同时直接生成回滚 SQL, 我这里没有实际尝试, 具体请参考项目 <a target="_blank" rel="noopener" href="https://github.com/zhuchao941/canal2sql">GitHub</a> 页面.</p><h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><p><strong>备份永远说数据恢复的首选! 不管是 Slave 还是 Binlog, 多留点备份.</strong></p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/database/" class="category-chain-item">Database</a> <span>></span> <a href="/categories/database/mysql/" class="category-chain-item">MySQL</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/mysql/" class="print-no-link">#MySQL</a> <a href="/tags/database/" class="print-no-link">#Database</a> <a href="/tags/binlog/" class="print-no-link">#Binlog</a></div></div><div class="license-box my-3"><div class="license-title"><div>MySQL Binlog 数据恢复</div><div>https://mritd.com/2024/01/11/mysql-binlog-restore/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Kovacs</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2024年1月11日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/01/16/openwrt-netease-uu-setup/" title="网易 UU + OpenWrt 单臂路由(旁路由)配置"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">网易 UU + OpenWrt 单臂路由(旁路由)配置</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/07/20/containerized-system-test/" title="容器化系统折腾"><span class="hidden-mobile">容器化系统折腾</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://mritd.com/2024/01/11/mysql-binlog-restore/",this.page.identifier="/2024/01/11/mysql-binlog-restore/"};Fluid.utils.loadComments("#disqus_thread",(function(){var e=document,t=e.createElement("script");t.src="//bleem.disqus.com/embed.js",t.setAttribute("data-timestamp",new Date),(e.head||e.body).appendChild(t)}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-docker"></i> <a href="https://bandwagonhost.com/aff.php?aff=61367" target="_blank" rel="nofollow noopener"><span>BandwagonHost</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!0,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>