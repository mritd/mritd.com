<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Kovacs"><meta name="keywords" content="Docker,CoreOS,FlatCar"><meta name="description" content="最近折腾透明代理, 以前一直 Ubuntu 打天下, 闲来无事试试容器化系统."><meta property="og:type" content="article"><meta property="og:title" content="容器化系统折腾"><meta property="og:url" content="https://mritd.com/2023/07/20/containerized-system-test/index.html"><meta property="og:site_name" content="Kovacs"><meta property="og:description" content="最近折腾透明代理, 以前一直 Ubuntu 打天下, 闲来无事试试容器化系统."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mritd.com/img/flatcar.jpg"><meta property="article:published_time" content="2023-07-20T10:06:00.000Z"><meta property="article:modified_time" content="2023-07-20T10:06:00.000Z"><meta property="article:author" content="Kovacs"><meta property="article:tag" content="Docker"><meta property="article:tag" content="CoreOS"><meta property="article:tag" content="FlatCar"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://mritd.com/img/flatcar.jpg"><meta name="twitter:creator" content="@kovacs_orz"><meta name="twitter:site" content="https://twitter.com/kovacs_orz"><title>容器化系统折腾 - Kovacs</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"mritd.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!0,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:"G-H06NPECR0Z"},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-H06NPECR0Z",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-H06NPECR0Z")}))</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Kovacs" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="Kovacs" type="application/rss+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Kovacs</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/friends/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="容器化系统折腾"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Kovacs </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-07-20 18:06" pubdate>2023年7月20日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 5.2k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 44 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">容器化系统折腾</h1><div class="markdown-body"><h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p>相较于传统的 Linux 发行版来说, 纯容器化系统一般有以下优点:</p><ul><li>系统直接内置容器化工具, 例如 Docker、Podman 等</li><li>自定义服务大部分可直接通过容器化运行, 简化部署和依赖</li><li>系统特定区域具有不可变性, 即无法自行修改和写入, 保证系统完整性</li><li>系统会自动滚动更新以保持最新状态</li><li>系统一般为精简系统, 资源占用低, 攻击面较小</li></ul><p>从上面这些优点来看, 纯容器化系统一般适合运行一些固定服务, 且可以容忍一定的服务中断(系统需要滚动更新). 当然纯容器化系统也有一些缺点:</p><ul><li>系统内可能没有内置任何包管理器, 不方便自行扩展系统级组件</li><li>某些分区无法写入, 跟现有的一些配置规范等冲突, 需要大量调整</li><li>系统默认集成的一些组件可能比较固定且无法替换</li><li>需要重新学习配置文件等, 有一定时间成本(yaml 工程师)</li></ul><h2 id="二、容器化系统简史"><a href="#二、容器化系统简史" class="headerlink" title="二、容器化系统简史"></a>二、容器化系统简史</h2><p>最开始做容器化系统的应该是大名鼎鼎的 CoreOS, 当时 CoreOS 开源了很多工具, 比如大名鼎鼎的 etcd 等; 后来 CoreOS 被红帽收购, 原来的版本也停止更新, 新版本 CoreOS 由红帽重构, 此后便出现了两个版本:</p><ul><li>Fedora CoreOS(fcos): 红帽收购后重新基于 Fedora 系统创建的 CoreOS</li><li>FlatCar: CoreOS 的直接替代品, 现在由 “巨硬” 收购了</li></ul><p>从 “名义” 上来说 Fedora CoreOS 算是 CoreOS 的继承者, 但实际上内部已经重构; 所以从 “血统” 上来讲还是 FlatCar 更加像以前的 CoreOS.</p><h2 id="三、Fedora-CoreOS-VS-FlatCar"><a href="#三、Fedora-CoreOS-VS-FlatCar" class="headerlink" title="三、Fedora CoreOS VS FlatCar"></a>三、Fedora CoreOS VS FlatCar</h2><p>Fedora CoreOS 是红帽基于 Fedora 重新创建的 CoreOS, 该系统的特点是使用 <a target="_blank" rel="noopener" href="https://coreos.github.io/rpm-ostree/">rpm-ostree</a> 工具来跟踪系统变化; <strong>rps-ostree 工具有点类似于 Git 一样跟踪系统变化, 同时也允许安装第三方 rpm 包; 相较于 FlatCar 来说其扩展性更强, 且并不是按照分区来保证系统的不可变性, 这样灵活度更高.</strong></p><p>与 Fedora CoreOS 不同的是 FlatCar 采用与现在很多安卓手机的类似机制, <strong>采用 A&#x2F;B 分区的模式进行系统更新, 即系统启动时运行在 A 分区, 更新时只更新 B 分区, 下次重启自动切换到 B 分区启动; 这种方法的好处是简单直接可靠, 坏处就是没有 Fedora CoreOS 那样灵活.</strong></p><p>还有一些区别就是 <strong>Fedora CoreOS 同时内置了 Podman 和 Docker 工具</strong>, 而 FlatCar 只内置了 Docker; 同时 Fedora CoreOS 网络工具采用的 NetworkManager, 而 FlatCar 采用的是 systemd-networkd.</p><p>综合来说两者各有优缺点, 我个人比较不喜欢 NetworkManager, 但 Podman 与 systemd 深度集成这点我还是挺喜欢的; 最后测试完纠结好久还是选择了 FlatCar, 因为 Podman 与 Docker 还是有些差异, 既然用不上又不喜欢 NetworkManager 同时 rpm-ostree 有一定学习成本, 那就干脆 FlatCar 好了; <strong>不过值得说明的是两个系统配置文件大部分通用, 所以只是个人喜好问题.</strong></p><h2 id="四、FlatCar-安装"><a href="#四、FlatCar-安装" class="headerlink" title="四、FlatCar 安装"></a>四、FlatCar 安装</h2><p>FlatCar 官方默认提供了各种软硬件环境的集成安装, 对于纯物理机提供 iso、iPEX 等安装方式, 针对于 VM 部署也提供了预构建的磁盘镜像; 由于安装方式过多, 这里只以 VMWare 平台 VCSA&#x2F;ESXi 为例, 其他平台请参考 <a target="_blank" rel="noopener" href="https://www.flatcar.org/docs/latest/installing/">官方文档</a>.</p><p>针对于 VMWare 平台, 需要先下载官方提供的 ova 虚拟机模版文件:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl -LO https://stable.release.flatcar-linux.net/amd64-usr/current/flatcar_production_vmware_ova.ova<br></code></pre></td></tr></table></figure><h3 id="4-1、ESXi-部署"><a href="#4-1、ESXi-部署" class="headerlink" title="4.1、ESXi 部署"></a>4.1、ESXi 部署</h3><p>对于 ESXi 平台可以直接部署, 但每次部署都需要上传 ova 虚拟机模版:</p><ul><li><p>首先新建虚拟机, 并选择 “从 OVA 文件部署”<br><img src="https://cdn.oss.link/markdown/QsmH5u.png" srcset="/img/loading.gif" lazyload alt="QsmH5u"></p></li><li><p>然后输入虚拟机名称, 并上传 ova 文件<br><img src="https://cdn.oss.link/markdown/Fi4FTS.png" srcset="/img/loading.gif" lazyload alt="Fi4FTS"></p></li><li><p>其中启动打开电源选项请根据实际需求调整, <strong>如果稍后要调整磁盘、网卡等则可以先取消勾选, 防止直接启动</strong><br><img src="https://cdn.oss.link/markdown/d7PNQO.png" srcset="/img/loading.gif" lazyload alt="d7PNQO"></p></li><li><p><strong>其他设置中的 Options 配置暂时可以不写, 下一章节将会详细介绍配置</strong><br><img src="https://cdn.oss.link/markdown/cMAZaL.png" srcset="/img/loading.gif" lazyload alt="cMAZaL"></p></li><li><p>完成后可调整虚拟机硬件配置(比如磁盘大小、CPU等), 然后启动即可<br><img src="https://cdn.oss.link/markdown/Yh5ZA3.png" srcset="/img/loading.gif" lazyload alt="Yh5ZA3"></p></li></ul><h3 id="4-2、VCenter-部署"><a href="#4-2、VCenter-部署" class="headerlink" title="4.2、VCenter 部署"></a>4.2、VCenter 部署</h3><p>对于 VCenter 来说与 ESXi 大体相同, 不同的是 VCenter 需要新创建一个 “内容库”, 然后上传 ova 虚拟机模版, 安装时需要从内容库来选择 ova, 免去了每次都要上传 ova 的问题.</p><ul><li><p>首先创建存储 ova 的内容库<br><img src="https://cdn.oss.link/markdown/qhfHbC.png" srcset="/img/loading.gif" lazyload alt="qhfHbC"></p></li><li><p>名称可随意填写<br><img src="https://cdn.oss.link/markdown/oNZLBN.png" srcset="/img/loading.gif" lazyload alt="oNZLBN"></p></li><li><p>选择本地内容库<br><img src="https://cdn.oss.link/markdown/XhA4mV.png" srcset="/img/loading.gif" lazyload alt="XhA4mV"></p></li><li><p>然后不启用安全策略, 选择存储即可创建完成<br><img src="https://cdn.oss.link/markdown/ALIuPv.png" srcset="/img/loading.gif" lazyload alt="ALIuPv"></p></li><li><p>接下来点击 “操作” - “导入项目”<br><img src="https://cdn.oss.link/markdown/BAXQ3m.png" srcset="/img/loading.gif" lazyload alt="BAXQ3m"></p></li><li><p>然后选择本地文件导入即可<br><img src="https://cdn.oss.link/markdown/dCzUiM.png" srcset="/img/loading.gif" lazyload alt="dCzUiM"></p></li></ul><p>后续步骤与 ESXi 基本一致, 都是新建虚拟机然后选择 ova 部署, 最后启动就可.</p><h2 id="五、FlatCar-配置"><a href="#五、FlatCar-配置" class="headerlink" title="五、FlatCar 配置"></a>五、FlatCar 配置</h2><p>上面水了一堆, 其实并没有体现出容器化核心配置以及优势; 本部分将着重介绍容器化系统的配置方式和相关的配置样例.</p><h3 id="5-1、配置格式"><a href="#5-1、配置格式" class="headerlink" title="5.1、配置格式"></a>5.1、配置格式</h3><p>由于历史原因容器化系统从最初的 CoreOS 发展到现在 Fedora CoreOS 和 FlatCar 经历了一系列变更, 其中配置文件最初以 Ignition File 变为现在的好几种格式; 下面说一下这几种格式的区别和应该用哪个:</p><ul><li>Ignition File: 采用 JSON 格式描述, 是 Fedora CoreOS 和 FlatCar 最终使用的配置文件; 但是大量配置造成了 Ignition File 基本可读性很差, 所以一般都是通过其他配置转换成 Ignition File.</li><li>Butane Config: 采用 YAML 格式描述, 比较贴近系统原理, 配置清晰且可读性强; Fedora CoreOS 和 FlatCar 都支持此配置, 一般通过工具将其转换成 Ignition File 再使用.</li><li>Container Linux Config: 采用 YAML 格式描述, 该配置格式最初为 CoreOS 创建, 有一定上层抽象且目前似乎只支持 FlatCar, 同样通过工具转换为 Ignition File 使用, 所以不太推荐.</li></ul><p>所以综上所述, 对于配置文件只需要看 Butane Config 就行了; 而 Butane Config 我个人认为 Fedora CoreOS 的文档样例描述的相对清晰, 两者都支持 Butane Config 所以区别不大, 所以即使最终选择使用 FlatCar 系统, 在学习配置时也可以参考 <a target="_blank" rel="noopener" href="https://docs.fedoraproject.org/en-US/fedora-coreos/storage/">Fedora CoreOS 的文档</a>.</p><h3 id="5-2、Butane-安装"><a href="#5-2、Butane-安装" class="headerlink" title="5.2、Butane 安装"></a>5.2、Butane 安装</h3><p>由于 Butane Config 需要转换成 Ignition File 才能被系统使用, 所以这里会用到一个转换工具, 即 <code>butane</code> 命令; 该命令可执行文件可以直接从 <a target="_blank" rel="noopener" href="https://github.com/coreos/butane/releases">GitHub</a> 下载, 也可以采用 Docker 镜像 <code>quay.io/coreos/butane:release</code>; 具体的安装方式和细节请参考 <a target="_blank" rel="noopener" href="https://coreos.github.io/butane/getting-started/">官方文档</a>.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run --<span class="hljs-built_in">rm</span> -i \<br>    quay.io/coreos/butane:latest \<br>    --pretty --strict &lt; butane_config.yaml \<br>    | <span class="hljs-built_in">base64</span> -w0<br></code></pre></td></tr></table></figure><h3 id="5-3、配置使用"><a href="#5-3、配置使用" class="headerlink" title="5.3、配置使用"></a>5.3、配置使用</h3><blockquote><p>详细配置说明放在下面, 这里讲一下怎么简单使用这个配置.</p></blockquote><p>假设有以下 Butane Config, 且文件名为 <code>test.yaml</code>:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">variant:</span> <span class="hljs-string">flatcar</span><br><span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span><br><span class="hljs-attr">kernel_arguments:</span><br>  <span class="hljs-attr">should_not_exist:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">flatcar.autologin</span><br><span class="hljs-attr">passwd:</span><br>  <span class="hljs-attr">users:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">root</span><br>      <span class="hljs-attr">ssh_authorized_keys:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">ssh-ed25519</span> <span class="hljs-string">AAAAC3NzaC1lZDI1NTE5AAAAIMskC9phaoO1WJkQOvXcUxH+DlG8u/2u1ReMXOO9vkbW</span> <span class="hljs-string">mritd@linux.com</span><br></code></pre></td></tr></table></figure><p>我们需要先使用以下命令将其转换为 Ignition 配置:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">butane --pretty --strict test.yaml | <span class="hljs-built_in">base64</span> -w0<br></code></pre></td></tr></table></figure><p>转换完成后将会输出一长串 <code>base64</code> 编码的文本, <strong>在创建虚拟机时将此内容添加到 <code>Ignition/coreos-cloudinit data</code> 字段中, 同时在 <code>Ignition/coreos-cloudinit data encoding</code> 中指定编码为 <code>base64</code>, 虚拟机启动后将会自动应用配置.</strong></p><p><img src="https://cdn.oss.link/markdown/UHHlUX.png" srcset="/img/loading.gif" lazyload alt="UHHlUX"></p><h3 id="5-4、用户配置"><a href="#5-4、用户配置" class="headerlink" title="5.4、用户配置"></a>5.4、用户配置</h3><p>Butane Config 中可以通过 <code>passwd</code> 属性配置容器化系统的内置用户和用户组, <strong>需要注意的是默认情况下 root 用户是禁止 SSH 登陆的.</strong> 简单的配置样例如下:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">passwd:</span><br>  <span class="hljs-attr">users:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">root</span><br>      <span class="hljs-attr">ssh_authorized_keys:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">ssh-ed25519</span> <span class="hljs-string">AAAAC3NzaC1lZDI1NTE5AAAAIMskC9phaoO1WJkQOvXcUxH+DlG8u/2u1ReMXOO9vkbW</span> <span class="hljs-string">mritd@linux.com</span><br></code></pre></td></tr></table></figure><p>以上配置在系统首次启动时会对 root 用户设置 ssh 登陆密钥, 后续就可以通过 ssh 使用 root 用户登陆; 除了 <code>ssh_authorized_keys</code> 字段以外还有一些常用的配置如下:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">passwd:</span><br>  <span class="hljs-comment"># 用户配置</span><br>  <span class="hljs-attr">users:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test</span><br>      <span class="hljs-comment"># 设置特定用户的密码, 密码可通过以下命令生成</span><br>      <span class="hljs-comment">#   openssl passwd -6 -salt SLAT PASSWD</span><br>      <span class="hljs-attr">password_hash:</span> <span class="hljs-string">$6$slat$OKqcnY96krXmy7rRCdpIgN90jMQ5kqJkgJxIc1sEE21SBIyW7kd4hYa91pfCy.lo1qiN4NM7B9R8NTrdGLWq81</span><br>      <span class="hljs-attr">ssh_authorized_keys:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">ssh-ed25519</span> <span class="hljs-string">AAAAC3NzaC1lZDI1NTE5AAAAIMskC9phaoO1WJkQOvXcUxH+DlG8u/2u1ReMXOO9vkbW</span> <span class="hljs-string">mritd@linux.com</span><br>      <span class="hljs-comment"># 定义用户的 UID(一般用于新增用户使用)</span><br>      <span class="hljs-attr">uid:</span> <span class="hljs-number">1023</span><br>      <span class="hljs-comment"># 定义用户的家目录</span><br>      <span class="hljs-attr">home_dir:</span> <span class="hljs-string">/home/test</span><br>      <span class="hljs-comment"># 是否自动创建家目录</span><br>      <span class="hljs-attr">no_create_home:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-comment"># 用户的主用户组</span><br>      <span class="hljs-attr">primary_group:</span> <span class="hljs-string">test</span><br>      <span class="hljs-comment"># 用户的其他用户组</span><br>      <span class="hljs-attr">groups:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">admin</span><br>      <span class="hljs-comment"># 用户登陆的 shell</span><br>      <span class="hljs-attr">shell:</span> <span class="hljs-string">/bin/bash</span><br>      <span class="hljs-comment"># 如果对一个已有用户设置为 false, 则启动后会删除此用户</span><br>      <span class="hljs-attr">should_exist:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-comment"># 设置用户是否为系统级用户</span><br>      <span class="hljs-attr">system:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-comment"># 组配置    </span><br>  <span class="hljs-attr">groups:</span><br>    <span class="hljs-comment"># 用户组名称</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test1</span><br>      <span class="hljs-comment"># 组 ID</span><br>      <span class="hljs-attr">gid:</span> <span class="hljs-number">9977</span><br>      <span class="hljs-comment"># 组密码</span><br>      <span class="hljs-attr">password_hash:</span> <span class="hljs-string">...</span><br>      <span class="hljs-comment"># 是否应该存在(false 则删除已存在的组)</span><br>      <span class="hljs-attr">should_exist:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-comment"># 是否为系统组</span><br>      <span class="hljs-attr">system:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><h3 id="5-5、磁盘配置"><a href="#5-5、磁盘配置" class="headerlink" title="5.5、磁盘配置"></a>5.5、磁盘配置</h3><p>在某些情况下我们可能需要采用独立磁盘作为数据存储, 例如挂载独立的 SSD 磁盘等; 磁盘相关的处理可以通过 <code>storage.disks</code> 字段进行配置, 配置完成后系统首次启动将会按照配置中的定义自动进行磁盘分区. 下面是磁盘配置的详细样例:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">storage:</span><br>  <span class="hljs-comment"># 磁盘配置</span><br>  <span class="hljs-attr">disks:</span><br>    <span class="hljs-comment"># 设备文件位置, 推荐直接使用 PCI 位置进行匹配, 因为 /dev/sda 这种配置多磁盘可能会</span><br>    <span class="hljs-comment"># 出现磁盘盘符漂移问题</span><br>    <span class="hljs-attr">device:</span> <span class="hljs-string">/dev/disk/by-path/pci-0000:02:00.0-scsi-0:0:0:0</span><br>    <span class="hljs-comment"># 是否强制清除分区表</span><br>    <span class="hljs-attr">wipe_table:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-comment"># 定义分区结构</span><br>    <span class="hljs-attr">partitions:</span><br>      <span class="hljs-comment"># 定义分区 Label</span><br>      <span class="hljs-attr">label:</span> <span class="hljs-string">data</span><br>      <span class="hljs-comment"># 分区编号, 如果为 0 则自动选择下一个可用的分区编号</span><br>      <span class="hljs-attr">number:</span> <span class="hljs-number">1</span><br>      <span class="hljs-comment"># 分区大小, 如果为 0 则默认占据最大空间</span><br>      <span class="hljs-attr">size_mib:</span> <span class="hljs-number">0</span><br>      <span class="hljs-comment"># 分区开头位置, 同样如果为 0 则采用最大可用的开头位置</span><br>      <span class="hljs-attr">start_mib:</span> <span class="hljs-number">0</span><br>      <span class="hljs-comment"># 如果分区表已存在是否重置, 为 true 时如果分区表已存在且与配置不符则会自动重建</span><br>      <span class="hljs-comment"># 为 false 时如果分区表已存在且不匹配则启动失败</span><br>      <span class="hljs-attr">wipe_partition_entry:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-comment"># 如果为 true, 当分区表存在且除大小以外都与当前配置相同时, 会自动扩容分区</span><br>      <span class="hljs-attr">resize:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><h3 id="5-6、文件系统配置"><a href="#5-6、文件系统配置" class="headerlink" title="5.6、文件系统配置"></a>5.6、文件系统配置</h3><p>上面使用完 <code>storage.disks</code> 对磁盘进行分区后, 还需要通过 <code>storage.filesystems</code> 对磁盘分区进行格式化创建文件系统和挂载; 文件系统创建及挂载的配置样例如下:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">storage:</span><br>  <span class="hljs-comment"># 文件系统配置</span><br>  <span class="hljs-attr">filesystems:</span><br>    <span class="hljs-comment"># 通过 Label 选中目标分区</span><br>    <span class="hljs-attr">label:</span> <span class="hljs-string">data</span><br>    <span class="hljs-comment"># 配置格式化的格式</span><br>    <span class="hljs-attr">format:</span> <span class="hljs-string">xfs</span><br>    <span class="hljs-comment"># mkfs 的额外参数</span><br>    <span class="hljs-attr">options:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;-f&quot;</span><br>    <span class="hljs-comment"># 是否在创建之前清除数据</span><br>    <span class="hljs-attr">wipe_filesystem:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-comment"># 文件系统挂载点</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">/data</span><br>    <span class="hljs-comment"># 挂载的额外参数</span><br>    <span class="hljs-attr">mount_options:</span><br></code></pre></td></tr></table></figure><p><strong>值得一提的是 FlatCar 默认采用 ext4 作为根文件系统格式, 你可以通过以下配置改变根文件系统格式为 xfs:</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">filesystems:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">device:</span> <span class="hljs-string">/dev/disk/by-partlabel/ROOT</span><br>    <span class="hljs-attr">wipe_filesystem:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">format:</span> <span class="hljs-string">xfs</span><br>    <span class="hljs-attr">label:</span> <span class="hljs-string">ROOT</span><br></code></pre></td></tr></table></figure><h3 id="5-7、文件配置"><a href="#5-7、文件配置" class="headerlink" title="5.7、文件配置"></a>5.7、文件配置</h3><p>在 FlatCar 和 Fedora CoreOS 这类系统中, 其实大部分配置都是基于文件配置, 通过在 yaml 中定义配置文件内容和属性来达到自动配置的目的. 大部分常用的文件配置参数如下:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">storage:</span><br>  <span class="hljs-comment"># 文件配置</span><br>  <span class="hljs-attr">files:</span><br>    <span class="hljs-comment"># 文件的存储路径</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/data/testfile</span><br>      <span class="hljs-comment"># 是否覆盖文件</span><br>      <span class="hljs-attr">overwrite:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-comment"># 文件权限</span><br>      <span class="hljs-attr">mode:</span> <span class="hljs-number">0644</span><br>      <span class="hljs-comment"># 文件属主</span><br>      <span class="hljs-attr">user:</span><br>        <span class="hljs-attr">id:</span> <span class="hljs-number">0</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">root</span><br>      <span class="hljs-comment"># 文件属组</span><br>      <span class="hljs-attr">group:</span><br>        <span class="hljs-attr">id:</span> <span class="hljs-number">0</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">root</span><br>      <span class="hljs-comment"># 文件内容</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-comment"># 直接在 yaml 中定义文件内容</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          asdsngjsdngda</span><br><span class="hljs-string"></span>        <span class="hljs-comment"># 与 inline 互斥, 可以通过此字段定义远程文件, 系统启动后会自动下载</span><br>        <span class="hljs-comment"># 支持协议 http, https, tftp, s3, gs</span><br>        <span class="hljs-attr">source:</span> <span class="hljs-string">http://exmaple.com/testfile</span><br>        <span class="hljs-comment"># http 请求头, 当使用远程文件时可设置</span><br>        <span class="hljs-attr">http_headers:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">X-AUTH</span><br>            <span class="hljs-attr">value:</span> <span class="hljs-string">xxxxxxxxx</span><br>      <span class="hljs-comment"># 与 contents 结构类似, 但是此部分定义的文件内容将会附加到目标文件之后</span><br>      <span class="hljs-attr">append:</span><br>        <span class="hljs-attr">contents:</span><br>          <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">            asnfbshdgbds</span><br><span class="hljs-string"></span>  <span class="hljs-comment"># 目录配置</span><br>  <span class="hljs-comment"># 一般用于创建特定目录使用, 比如 Fedora CoreOS 在使用 Podman 挂载时不会自动</span><br>  <span class="hljs-comment"># 创建宿主机目录, 此时可以通过此配置预先创建目录          </span><br>  <span class="hljs-attr">directories:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/data/mysql</span><br>      <span class="hljs-attr">mode:</span> <span class="hljs-number">0755</span><br>      <span class="hljs-attr">user:</span><br>        <span class="hljs-attr">id:</span> <span class="hljs-number">3306</span><br>      <span class="hljs-attr">group:</span><br>        <span class="hljs-attr">id:</span> <span class="hljs-number">3306</span><br>  <br>  <span class="hljs-comment"># 链接文件配置</span><br>  <span class="hljs-attr">links:</span><br>    <span class="hljs-comment"># 目标文件位置</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/localtime</span><br>      <span class="hljs-comment"># 原始文件位置</span><br>      <span class="hljs-attr">target:</span> <span class="hljs-string">../usr/share/zoneinfo/Asia/Shanghai</span><br>      <span class="hljs-comment"># 是否创建硬链接</span><br>      <span class="hljs-attr">hard:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">user:</span><br>        <span class="hljs-attr">id:</span> <span class="hljs-number">0</span><br>      <span class="hljs-attr">group:</span><br>        <span class="hljs-attr">id:</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h4 id="5-7-1、配置-Hostname"><a href="#5-7-1、配置-Hostname" class="headerlink" title="5.7.1、配置 Hostname"></a>5.7.1、配置 Hostname</h4><p>以下配置样例用于配置当前主机的 Hostname:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">storage:</span><br>  <span class="hljs-attr">files:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/hostname</span><br>      <span class="hljs-attr">mode:</span> <span class="hljs-number">0644</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">test</span><br></code></pre></td></tr></table></figure><h4 id="5-7-2、配置-sysctl"><a href="#5-7-2、配置-sysctl" class="headerlink" title="5.7.2、配置 sysctl"></a>5.7.2、配置 sysctl</h4><p>以下配置样例用于配置特定的 sysctl 参数</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">storage:</span><br>  <span class="hljs-attr">files:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/sysctl.d/55-custom.conf</span><br>      <span class="hljs-attr">mode:</span> <span class="hljs-number">0644</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br>          <span class="hljs-string">net.core.rmem_max=2500000</span><br></code></pre></td></tr></table></figure><h4 id="5-7-3、配置静态-IP"><a href="#5-7-3、配置静态-IP" class="headerlink" title="5.7.3、配置静态 IP"></a>5.7.3、配置静态 IP</h4><blockquote><p>注意: 静态 IP 配置和 DNS 配置仅适用于 FlatCar, Fedora CoreOS 采用的是 NetworkManager, 所以配置有所不同, 请参考 <a target="_blank" rel="noopener" href="https://docs.fedoraproject.org/en-US/fedora-coreos/sysconfig-network-configuration/">Host Network Configuration</a> 文档.</p></blockquote><p>以下配置样例用于为第一个有线网卡配置静态 IP(默认情况下为 DHCP):</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">storage:</span><br>  <span class="hljs-attr">files:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/systemd/network/25-xnet.network</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          [Match]</span><br><span class="hljs-string">          Name=en*</span><br><span class="hljs-string"></span><br>          [<span class="hljs-string">Network</span>]<br>          <span class="hljs-string">DHCP=no</span><br>          <span class="hljs-string">NTP=time.windows.com</span> <span class="hljs-string">time.apple.com</span><br><br>          [<span class="hljs-string">Address</span>]<br>          <span class="hljs-string">Address=172.16.4.24/24</span><br><br>          [<span class="hljs-string">Route</span>]<br>          <span class="hljs-string">Destination=0.0.0.0/0</span><br>          <span class="hljs-string">Gateway=172.16.4.253</span><br></code></pre></td></tr></table></figure><h4 id="5-7-4、配置-DNS"><a href="#5-7-4、配置-DNS" class="headerlink" title="5.7.4、配置 DNS"></a>5.7.4、配置 DNS</h4><p>以下配置样例用于配置系统 DNS:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">storage:</span><br>  <span class="hljs-attr">files:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/systemd/resolved.conf.d/25-xnet.conf</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          [Resolve]</span><br><span class="hljs-string">          DNS=223.5.5.5</span><br><span class="hljs-string">          DNS=119.29.29.29</span><br><span class="hljs-string">          #Domains=~.</span><br><span class="hljs-string">          #DNSStubListener=no</span><br></code></pre></td></tr></table></figure><h4 id="5-7-5、配置系统更新策略"><a href="#5-7-5、配置系统更新策略" class="headerlink" title="5.7.5、配置系统更新策略"></a>5.7.5、配置系统更新策略</h4><p>由于 FlatCar 是自动滚动更新的, 滚动更新时需要进行重启保证 A&#x2F;B 分区切换, 所以为了可控性一般我们需要配置一下可以重启的时间(更新策略):</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">storage:</span><br>  <span class="hljs-attr">files:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/flatcar/update.conf</span><br>      <span class="hljs-attr">mode:</span> <span class="hljs-number">0420</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-comment"># 如果有更新的话, 默认在每天 10:30 进行重启更新, 最长的更新窗口期为 1 小时</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          REBOOT_STRATEGY=reboot</span><br><span class="hljs-string">          LOCKSMITHD_REBOOT_WINDOW_START=10:30</span><br><span class="hljs-string">          LOCKSMITHD_REBOOT_WINDOW_LENGTH=1h</span><br></code></pre></td></tr></table></figure><h4 id="5-7-6、其他配置"><a href="#5-7-6、其他配置" class="headerlink" title="5.7.6、其他配置"></a>5.7.6、其他配置</h4><p>文件配置是一个灵活的配置选项, 除了做一些系统配置外我们还可以利用它放入一些我们自己的东西, 比如自定义脚本之类的:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">storage:</span><br>  <span class="hljs-attr">files:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/opt/scripts/pre-update.sh</span><br>      <span class="hljs-attr">mode:</span> <span class="hljs-number">0755</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          #!/usr/bin/env bash</span><br><span class="hljs-string"></span><br>          <span class="hljs-string">curl</span> <span class="hljs-string">-fsSL</span> <span class="hljs-string">-XPOST</span> <span class="hljs-string">-H</span> <span class="hljs-string">&#x27;Authorization: Bearer xxxxxxxxxxxxxxxxxxxxx&#x27;</span> <span class="hljs-string">https://noti.example.com/message</span> <span class="hljs-string">-d</span> <span class="hljs-string">&#x27;markdown=false&#x27;</span> <span class="hljs-string">-d</span> <span class="hljs-string">&#x27;message=应用正在更新...&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="5-8、Systemd-配置"><a href="#5-8、Systemd-配置" class="headerlink" title="5.8、Systemd 配置"></a>5.8、Systemd 配置</h3><p>当需要运行特定服务时, 一般我们需要创建一个 Systemd Service 配置文件, 这时就需要使用 Systemd 配置; Systemd 配置与文件配置类似, 不同之处在于 Systemd 配置虽然也只是定义 Systemd 文件, 但是提供了自启动等针对于 Systemd 的高级配置. 以下为运行 watchtower 容器的样例:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">systemd:</span><br>  <span class="hljs-attr">units:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">watchtower.service</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">contents:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        [Unit]</span><br><span class="hljs-string">        Description=A container-based solution for automating Docker container base image updates.</span><br><span class="hljs-string">        After=network-online.target</span><br><span class="hljs-string">        Wants=network-online.target</span><br><span class="hljs-string"></span><br>        [<span class="hljs-string">Service</span>]<br>        <span class="hljs-string">ExecStartPre=-/usr/bin/docker</span> <span class="hljs-string">rm</span> <span class="hljs-string">-f</span> <span class="hljs-string">watchtower</span><br>        <span class="hljs-string">ExecStartPre=/usr/bin/docker</span> <span class="hljs-string">pull</span> <span class="hljs-string">containrrr/watchtower</span><br>        <span class="hljs-string">ExecStart=/usr/bin/docker</span> <span class="hljs-string">run</span> <span class="hljs-string">--tty</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">--name</span> <span class="hljs-string">watchtower</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-v</span> <span class="hljs-string">/var/run/docker.sock:/var/run/docker.sock</span> <span class="hljs-string">\</span><br>                                    <span class="hljs-string">containrrr/watchtower</span> <span class="hljs-string">--cleanup</span> <span class="hljs-string">--interval</span> <span class="hljs-number">3600</span><br><br>        [<span class="hljs-string">Install</span>]<br>        <span class="hljs-string">WantedBy=multi-user.target</span><br></code></pre></td></tr></table></figure><p><strong>需要注意的是, <code>name</code> 属性需要以完整的 systemd units 名称结尾, 即可以通过文件名指定 units 类型, 例如 <code>test.timer</code> 代表创建一个定时器.</strong></p><h3 id="5-9、内核参数配置"><a href="#5-9、内核参数配置" class="headerlink" title="5.9、内核参数配置"></a>5.9、内核参数配置</h3><p>除了一些常规配置以外, 特殊情况下可能需要配置一些内核参数来控制系统行为; 比如默认情况下 FlatCar 会自动登录, 想关闭此行为可以通过一下配置调整内核参数:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kernel_arguments:</span><br>  <span class="hljs-comment"># 确保将特定参数从内核参数中移除</span><br>  <span class="hljs-attr">should_not_exist:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">flatcar.autologin</span><br></code></pre></td></tr></table></figure><p>同样也可以使用 <code>should_exist</code> 添加一些内核参数:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kernel_arguments:</span><br>  <span class="hljs-comment"># 确保特定参数被添加到内核参数列表</span><br>  <span class="hljs-attr">should_exist:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">systemd.unified_cgroup_hierarchy=0</span><br></code></pre></td></tr></table></figure><h2 id="六、完整样例"><a href="#六、完整样例" class="headerlink" title="六、完整样例"></a>六、完整样例</h2><p>以下是一个 FlatCar 部署 GitLab 的完整样例, 仅供参考:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">variant:</span> <span class="hljs-string">flatcar</span><br><span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span><br><span class="hljs-attr">kernel_arguments:</span><br>  <span class="hljs-attr">should_not_exist:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">flatcar.autologin</span><br><span class="hljs-attr">passwd:</span><br>  <span class="hljs-attr">users:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">root</span><br>      <span class="hljs-comment"># openssl passwd -6 -salt SALT PASSWORD</span><br>      <span class="hljs-attr">password_hash:</span> <span class="hljs-string">$6$kovacs$7svc/7vosETJvIXF3G1SIV9NGdu.j6FRPHPR9DAp0nAQ1CnLuc766hHJQWZlJjlCRj9Nlx4KJjSMGcdtvH4dJ/</span><br>      <span class="hljs-attr">ssh_authorized_keys:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">ssh-ed25519</span> <span class="hljs-string">AAAAC3NzaC1lZDI1NTE5AAAAIMskC9phaoO1WJkQOvXcUxH+DlG8u/2u1ReMXOO9vkbW</span> <span class="hljs-string">mritd@linux.com</span><br><span class="hljs-attr">storage:</span><br>  <span class="hljs-attr">filesystems:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">device:</span> <span class="hljs-string">/dev/disk/by-partlabel/ROOT</span><br>      <span class="hljs-attr">wipe_filesystem:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">format:</span> <span class="hljs-string">xfs</span><br>      <span class="hljs-attr">label:</span> <span class="hljs-string">ROOT</span><br>  <span class="hljs-comment"># TimeZone</span><br>  <span class="hljs-attr">links:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/localtime</span><br>      <span class="hljs-attr">target:</span> <span class="hljs-string">../usr/share/zoneinfo/Asia/Shanghai</span><br><br>  <span class="hljs-attr">files:</span><br>    <span class="hljs-comment"># Update policy</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/flatcar/update.conf</span><br>      <span class="hljs-attr">mode:</span> <span class="hljs-number">0420</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          REBOOT_STRATEGY=reboot</span><br><span class="hljs-string">          LOCKSMITHD_REBOOT_WINDOW_START=10:30</span><br><span class="hljs-string">          LOCKSMITHD_REBOOT_WINDOW_LENGTH=1h</span><br><span class="hljs-string"></span>    <span class="hljs-comment"># Sysctl Config</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/sysctl.d/55-custom.conf</span><br>      <span class="hljs-attr">mode:</span> <span class="hljs-number">0644</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          net.core.rmem_max=2500000</span><br><span class="hljs-string"></span>    <span class="hljs-comment"># Set hostname</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/hostname</span><br>      <span class="hljs-attr">mode:</span> <span class="hljs-number">0644</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">gitlab</span><br>    <span class="hljs-comment"># Set static ip</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/systemd/network/25-xnet.network</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          [Match]</span><br><span class="hljs-string">          Name=en*</span><br><span class="hljs-string"></span><br>          [<span class="hljs-string">Network</span>]<br>          <span class="hljs-string">DHCP=no</span><br>          <span class="hljs-string">NTP=time.windows.com</span> <span class="hljs-string">time.apple.com</span><br><br>          [<span class="hljs-string">Address</span>]<br>          <span class="hljs-string">Address=172.16.1.6/24</span><br><br>          [<span class="hljs-string">Route</span>]<br>          <span class="hljs-string">Destination=0.0.0.0/0</span><br>          <span class="hljs-string">Gateway=172.16.1.1</span><br>    <span class="hljs-comment"># DNS Config</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/systemd/resolved.conf.d/25-xnet.conf</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          [Resolve]</span><br><span class="hljs-string">          DNS=223.5.5.5</span><br><span class="hljs-string">          DNS=119.29.29.29</span><br><span class="hljs-string">          #Domains=~.</span><br><span class="hljs-string">          #DNSStubListener=no</span><br><span class="hljs-string"></span><br>    <span class="hljs-comment"># GitLab Config</span><br>    <span class="hljs-comment"># ref: https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/gitlab/gitlab.rb</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          external_url &#x27;https://git.example.com&#x27;</span><br><span class="hljs-string"></span><br>          <span class="hljs-string">gitlab_rails[&#x27;time_zone&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&#x27;Asia/Shanghai&#x27;</span><br><br>          <span class="hljs-comment">### GitLab email server settings</span><br>          <span class="hljs-comment">###! Docs: https://docs.gitlab.com/omnibus/settings/smtp.html</span><br>          <span class="hljs-comment">###! **Use smtp instead of sendmail/postfix.**</span><br>          <span class="hljs-string">gitlab_rails[&#x27;smtp_enable&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-literal">true</span><br>          <span class="hljs-string">gitlab_rails[&#x27;smtp_address&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&quot;smtp.example.com&quot;</span><br>          <span class="hljs-string">gitlab_rails[&#x27;smtp_port&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-number">465</span><br>          <span class="hljs-string">gitlab_rails[&#x27;smtp_user_name&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&quot;gitlab@example.com&quot;</span><br>          <span class="hljs-string">gitlab_rails[&#x27;smtp_password&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&quot;asdassgdfgd&quot;</span><br>          <span class="hljs-string">gitlab_rails[&#x27;smtp_domain&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&quot;example.com&quot;</span><br>          <span class="hljs-string">gitlab_rails[&#x27;smtp_authentication&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&quot;login&quot;</span><br>          <span class="hljs-string">gitlab_rails[&#x27;smtp_enable_starttls_auto&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-literal">false</span><br>          <span class="hljs-string">gitlab_rails[&#x27;smtp_tls&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-literal">true</span><br>          <span class="hljs-string">gitlab_rails[&#x27;gitlab_email_from&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&#x27;gitlab@example.com&#x27;</span><br>          <span class="hljs-string">gitlab_rails[&#x27;gitlab_email_reply_to&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&#x27;gitlab@example.com&#x27;</span><br><br>          <span class="hljs-comment">### Default Theme</span><br>          <span class="hljs-comment">### Available values:</span><br>          <span class="hljs-comment">##! `1`  for Indigo</span><br>          <span class="hljs-comment">##! `2`  for Dark</span><br>          <span class="hljs-comment">##! `3`  for Light</span><br>          <span class="hljs-comment">##! `4`  for Blue</span><br>          <span class="hljs-comment">##! `5`  for Green</span><br>          <span class="hljs-comment">##! `6`  for Light Indigo</span><br>          <span class="hljs-comment">##! `7`  for Light Blue</span><br>          <span class="hljs-comment">##! `8`  for Light Green</span><br>          <span class="hljs-comment">##! `9`  for Red</span><br>          <span class="hljs-comment">##! `10` for Light Red</span><br>          <span class="hljs-string">gitlab_rails[&#x27;gitlab_default_theme&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-number">2</span><br><br>          <span class="hljs-comment">### Reply by email</span><br>          <span class="hljs-comment">###! Allow users to comment on issues and merge requests by replying to</span><br>          <span class="hljs-comment">###! notification emails.</span><br>          <span class="hljs-comment">###! Docs: https://docs.gitlab.com/ee/administration/reply_by_email.html</span><br>          <span class="hljs-string">gitlab_rails[&#x27;incoming_email_enabled&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-literal">false</span><br><br>          <span class="hljs-comment">### GitLab Shell settings for GitLab</span><br>          <span class="hljs-string">gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-number">2222</span><br><br>          <span class="hljs-comment">#### Change the initial default admin password and shared runner registration tokens.</span><br>          <span class="hljs-comment">####! **Only applicable on initial setup, changing these settings after database</span><br>          <span class="hljs-comment">####!   is created and seeded won&#x27;t yield any change.**</span><br>          <span class="hljs-string">gitlab_rails[&#x27;initial_root_password&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&quot;hgfghwerwefwfw&quot;</span><br>          <span class="hljs-string">gitlab_rails[&#x27;initial_shared_runners_registration_token&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&quot;asfdfhfghfgsfsdfs&quot;</span><br><br>          <span class="hljs-comment">### Settings used by GitLab application</span><br>          <span class="hljs-string">gitlab_rails[&#x27;registry_enabled&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-literal">false</span><br><br>          <span class="hljs-comment">### Settings used by Registry application</span><br>          <span class="hljs-string">registry[&#x27;enable&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-literal">false</span><br><br>          <span class="hljs-comment">## GitLab NGINX</span><br>          <span class="hljs-string">nginx[&#x27;listen_port&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&#x27;2080&#x27;</span><br>          <span class="hljs-string">nginx[&#x27;listen_https&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-literal">false</span><br>          <span class="hljs-string">nginx[&#x27;redirect_http_to_https&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-literal">false</span><br>          <span class="hljs-string">nginx[&#x27;real_ip_trusted_addresses&#x27;]</span> <span class="hljs-string">=</span> [<span class="hljs-string">&#x27;127.0.0.0/8&#x27;</span>, <span class="hljs-string">&#x27;10.0.0.0/8&#x27;</span>, <span class="hljs-string">&#x27;172.16.0.0/12&#x27;</span>, <span class="hljs-string">&#x27;192.168.0.0/16&#x27;</span>]<br>          <span class="hljs-string">nginx[&#x27;real_ip_header&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&#x27;X-Forwarded-For&#x27;</span><br>          <span class="hljs-string">nginx[&#x27;real_ip_recursive&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&#x27;on&#x27;</span><br><br>          <span class="hljs-comment">## GitLab Logging</span><br>          <span class="hljs-string">logging[&#x27;logrotate_frequency&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&quot;daily&quot;</span> <span class="hljs-comment"># rotate logs daily</span><br>          <span class="hljs-string">logging[&#x27;logrotate_size&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">nil</span> <span class="hljs-comment"># do not rotate by size by default</span><br>          <span class="hljs-string">logging[&#x27;logrotate_rotate&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-number">30</span> <span class="hljs-comment"># keep 30 rotated logs</span><br>          <span class="hljs-string">logging[&#x27;logrotate_compress&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&quot;compress&quot;</span> <span class="hljs-comment"># see &#x27;man logrotate&#x27;</span><br>          <span class="hljs-string">logging[&#x27;logrotate_method&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">&quot;copytruncate&quot;</span> <span class="hljs-comment"># see &#x27;man logrotate&#x27;</span><br>          <span class="hljs-string">logging[&#x27;logrotate_postrotate&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">nil</span> <span class="hljs-comment"># no postrotate command by default</span><br>          <span class="hljs-string">logging[&#x27;logrotate_dateformat&#x27;]</span> <span class="hljs-string">=</span> <span class="hljs-string">nil</span> <span class="hljs-comment"># use date extensions for rotated files rather than numbers e.g. a value of &quot;-%Y-%m-%d&quot; would give rotated files like p</span><br><br>    <span class="hljs-comment"># Caddy config</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/caddy/Caddyfile</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          (LOG_FILE) &#123;</span><br><span class="hljs-string">              log &#123;</span><br><span class="hljs-string">                  format transform &quot;[&#123;ts&#125;] &#123;request&gt;remote_ip&#125; [&#123;status&#125;] &#123;request&gt;proto&#125; &#123;request&gt;method&#125; &#123;request&gt;host&#125; &#123;request&gt;uri&#125; &#123;request&gt;headers&gt;User-Agent&gt;[0]&#125;&quot; &#123;</span><br><span class="hljs-string">                      time_format &quot;iso8601&quot;</span><br><span class="hljs-string">                  &#125;</span><br><span class="hljs-string">                  output file &quot;&#123;args.0&#125;&quot; &#123;</span><br><span class="hljs-string">                      roll_size 100mb</span><br><span class="hljs-string">                      roll_keep 3</span><br><span class="hljs-string">                      roll_keep_for 7d</span><br><span class="hljs-string">                  &#125;</span><br><span class="hljs-string">              &#125;</span><br><span class="hljs-string">          &#125;</span><br><span class="hljs-string"></span>          <br>          <span class="hljs-string">(TLS_MODERN)</span> &#123;<br>              <span class="hljs-string">protocols</span> <span class="hljs-string">tls1.3</span><br>          &#125;<br>          <br>          <span class="hljs-string">(TLS_INTERMEDIATE)</span> &#123;<br>              <span class="hljs-string">protocols</span> <span class="hljs-string">tls1.2</span> <span class="hljs-string">tls1.3</span><br>              <span class="hljs-string">ciphers</span> <span class="hljs-string">TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256</span> <span class="hljs-string">TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</span> <span class="hljs-string">TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384</span> <span class="hljs-string">TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</span> <span class="hljs-string">TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256</span> <span class="hljs-string">TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256</span><br>          &#125;<br>          <br>          <span class="hljs-string">(TLS_OLD)</span> &#123;<br>              <span class="hljs-string">protocols</span> <span class="hljs-string">tls1.0</span> <span class="hljs-string">tls1.3</span><br>              <span class="hljs-string">ciphers</span> <span class="hljs-string">TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256</span> <span class="hljs-string">TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</span> <span class="hljs-string">TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384</span> <span class="hljs-string">TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256</span> <span class="hljs-string">TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256</span> <span class="hljs-string">TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA</span> <span class="hljs-string">TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA</span> <span class="hljs-string">TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA</span> <span class="hljs-string">TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA</span> <span class="hljs-string">TLS_RSA_WITH_AES_128_GCM_SHA256</span> <span class="hljs-string">TLS_RSA_WITH_AES_256_GCM_SHA384</span> <span class="hljs-string">TLS_RSA_WITH_AES_128_CBC_SHA</span> <span class="hljs-string">TLS_RSA_WITH_AES_256_CBC_SHA</span> <span class="hljs-string">TLS_RSA_WITH_3DES_EDE_CBC_SHA</span><br>          &#125;<br>          <br>          <span class="hljs-string">(HSTS)</span> &#123;<br>              <span class="hljs-comment"># HSTS (63072000 seconds)</span><br>              <span class="hljs-string">header</span> <span class="hljs-string">/</span> <span class="hljs-string">Strict-Transport-Security</span> <span class="hljs-string">&quot;max-age=63072000&quot;</span><br>          &#125;<br>          <br>          <span class="hljs-string">(SECURITY)</span> &#123;<br>              <span class="hljs-comment"># hidden server name</span><br>              <span class="hljs-string">header</span> <span class="hljs-string">-Server</span><br>          &#125;<br>          <br>          <span class="hljs-string">(ACME_PROVIDER_CLOUDFLARE)</span> &#123;<br>              <span class="hljs-string">dns</span> <span class="hljs-string">cloudflare</span> &#123;<span class="hljs-string">$CLOUDFLARE_API_TOKEN</span>&#125;<br>          &#125;<br>          <br>          <span class="hljs-string">(ACME_PROVIDER_DNSPOD)</span> &#123;<br>              <span class="hljs-string">dns</span> <span class="hljs-string">dnspod</span> &#123;<span class="hljs-string">$DNSPOD_TOKEN</span>&#125;<br>          &#125;<br>          <br>          <span class="hljs-string">(ACME_PROVIDER_DUCKDNS)</span> &#123;<br>              <span class="hljs-string">dns</span> <span class="hljs-string">duckdns</span> &#123;<span class="hljs-string">$DUCKDNS_API_TOKEN</span>&#125;<br>          &#125;<br>          <br>          <span class="hljs-string">(ACME_PROVIDER_GANDI)</span> &#123;<br>              <span class="hljs-string">dns</span> <span class="hljs-string">gandi</span> &#123;<span class="hljs-string">$GANDI_API_TOKEN</span>&#125;<br>          &#125;<br>          <br>          <span class="hljs-string">(ACME_PROVIDER_ALIYUN)</span> &#123;<br>              <span class="hljs-string">dns</span> <span class="hljs-string">alidns</span> &#123;<br>                  <span class="hljs-string">access_key_id</span> &#123;<span class="hljs-string">$ALIYUN_ACCESS_KEY_ID</span>&#125;<br>                  <span class="hljs-string">access_key_secret</span> &#123;<span class="hljs-string">$ALIYUN_ACCESS_KEY_SECRET</span>&#125;<br>              &#125;<br>          &#125;<br>          <br>          <span class="hljs-string">(ACME_DNS)</span> &#123;<br>              <span class="hljs-comment"># 压缩支持</span><br>              <span class="hljs-string">encode</span> <span class="hljs-string">zstd</span> <span class="hljs-string">gzip</span><br>          <br>              <span class="hljs-comment"># TLS 配置</span><br>              <span class="hljs-string">tls</span> &#123;<br>                  <span class="hljs-string">import</span> <span class="hljs-string">TLS_</span>&#123;<span class="hljs-string">args.0</span>&#125;<br>                  <span class="hljs-string">import</span> <span class="hljs-string">ACME_PROVIDER_</span>&#123;<span class="hljs-string">args.1</span>&#125;<br>                  <span class="hljs-string">resolvers</span> <span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span><br>              &#125;<br>          <br>              <span class="hljs-comment"># HSTS</span><br>              <span class="hljs-string">import</span> <span class="hljs-string">HSTS</span><br>          <br>              <span class="hljs-comment"># security config</span><br>              <span class="hljs-string">import</span> <span class="hljs-string">SECURITY</span><br>          &#125;<br>          <br>          <br>          <span class="hljs-comment"># sysctl -w net.core.rmem_max=2500000</span><br>          <span class="hljs-comment"># ref https://github.com/lucas-clemente/quic-go/wiki/UDP-Receive-Buffer-Size</span><br>          &#123;<br>              <span class="hljs-comment"># ZeroSSL</span><br>              <span class="hljs-string">acme_ca</span> <span class="hljs-string">https://acme.zerossl.com/v2/DV90</span><br>              <span class="hljs-comment">#email &#123;$ACME_EMAIL:&#125;</span><br>              <span class="hljs-comment">#cert_issuer &#123;$ACME_ISSUER:&#125; &#123;$ACME_ISSUER_PARAMS:&#125;</span><br>          <br>              <span class="hljs-comment"># ECC cert</span><br>              <span class="hljs-string">key_type</span> <span class="hljs-string">p384</span><br>          <br>              <span class="hljs-string">servers</span> <span class="hljs-string">:443</span> &#123;<br>                  <span class="hljs-string">protocols</span> <span class="hljs-string">h1</span> <span class="hljs-string">h2</span> <span class="hljs-string">h3</span><br>              &#125;<br>          <br>          &#125;<br><br>          <span class="hljs-string">git.example.com</span> &#123;<br>              <span class="hljs-string">reverse_proxy</span> <span class="hljs-string">gitlab:2080</span><br>          <br>              <span class="hljs-string">import</span> <span class="hljs-string">ACME_DNS</span> <span class="hljs-string">MODERN</span> <span class="hljs-string">ALIYUN</span><br>              <span class="hljs-string">import</span> <span class="hljs-string">LOG_FILE</span> <span class="hljs-string">/data/git.example.com.log</span><br>          &#125;<br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/caddy/env</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          ALIYUN_ACCESS_KEY_ID=xxxxxxxxxxxxxxxxxxxx</span><br><span class="hljs-string">          ALIYUN_ACCESS_KEY_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><br><span class="hljs-string"></span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/mc/config.json</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          &#123;</span><br><span class="hljs-string">            &quot;version&quot;: &quot;10&quot;,</span><br><span class="hljs-string">            &quot;aliases&quot;: &#123;</span><br><span class="hljs-string">              &quot;nas&quot;: &#123;</span><br><span class="hljs-string">                &quot;url&quot;: &quot;https://s3.example.com&quot;,</span><br><span class="hljs-string">                &quot;accessKey&quot;: &quot;admin&quot;,</span><br><span class="hljs-string">                &quot;secretKey&quot;: &quot;xxxxxxxxxxxxxxxxxxxxxx&quot;,</span><br><span class="hljs-string">                &quot;api&quot;: &quot;s3v4&quot;,</span><br><span class="hljs-string">                &quot;path&quot;: &quot;auto&quot;</span><br><span class="hljs-string">              &#125;</span><br><span class="hljs-string">            &#125;</span><br><span class="hljs-string">          &#125;</span><br><span class="hljs-string"></span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/opt/scripts/gitlab-backup.sh</span><br>      <span class="hljs-attr">mode:</span> <span class="hljs-number">0755</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          #!/usr/bin/env bash</span><br><span class="hljs-string"></span>          <br>          <span class="hljs-string">set</span> <span class="hljs-string">-e</span><br>          <br>          <span class="hljs-string">TMPDIR=$(mktemp</span> <span class="hljs-string">-d)</span><br>          <span class="hljs-string">BACKUP_DIR=$&#123;TMPDIR&#125;/gitlab</span><br>          <span class="hljs-string">BACKUP_DATE=$(date</span> <span class="hljs-string">&#x27;+%Y-%m-%d-%H-%M-%S&#x27;</span><span class="hljs-string">)</span><br>          <span class="hljs-string">BACKUP_FILE=$&#123;BACKUP_DATE&#125;_gitlab_backup.tar</span><br>          <span class="hljs-string">GITLAB_VERSION=$(docker</span> <span class="hljs-string">exec</span> <span class="hljs-string">gitlab</span> <span class="hljs-string">gitlab-rails</span> <span class="hljs-string">runner</span> <span class="hljs-string">&#x27;puts Gitlab::VERSION&#x27;</span><span class="hljs-string">)</span><br>          <span class="hljs-string">PACKAGE_NAME=gitlab_$&#123;GITLAB_VERSION&#125;_$&#123;BACKUP_DATE&#125;.tar</span><br>          <br>          <span class="hljs-string">function</span> <span class="hljs-string">cleanup()&#123;</span><br>              <span class="hljs-string">rm</span> <span class="hljs-string">-rf</span> <span class="hljs-string">$&#123;TMPDIR&#125;</span><br>          <span class="hljs-string">&#125;</span><br>          <br>          <span class="hljs-string">trap</span> <span class="hljs-string">cleanup</span> <span class="hljs-string">EXIT</span><br>          <br>          <span class="hljs-string">echo</span> <span class="hljs-string">&quot;GitLab Backup Running...&quot;</span><br>          <span class="hljs-string">echo</span> <span class="hljs-string">&quot;Backup Filename =&gt; $&#123;PACKAGE_NAME&#125;&quot;</span><br>          <span class="hljs-string">mkdir</span> <span class="hljs-string">-p</span> <span class="hljs-string">$&#123;BACKUP_DIR&#125;</span><br>          <br>          <span class="hljs-string">echo</span> <span class="hljs-string">&quot;Creating GitLab Backup Tarball...&quot;</span><br>          <span class="hljs-string">docker</span> <span class="hljs-string">exec</span> <span class="hljs-string">-i</span> <span class="hljs-string">gitlab</span> <span class="hljs-string">gitlab-backup</span> <span class="hljs-string">create</span> <span class="hljs-string">BACKUP=$&#123;BACKUP_DATE&#125;</span> <span class="hljs-string">STRATEGY=copy</span><br>          <br>          <span class="hljs-string">echo</span> <span class="hljs-string">&quot;Moving GitLab Tarball...&quot;</span><br>          <span class="hljs-string">mv</span> <span class="hljs-string">/data/gitlab/data/backups/$&#123;BACKUP_FILE&#125;</span> <span class="hljs-string">$&#123;BACKUP_DIR&#125;</span><br>          <br>          <span class="hljs-string">echo</span> <span class="hljs-string">&quot;Copying GitLab Config...&quot;</span><br>          <span class="hljs-string">docker</span> <span class="hljs-string">cp</span> <span class="hljs-string">gitlab:/etc/gitlab/gitlab.rb</span> <span class="hljs-string">$&#123;BACKUP_DIR&#125;</span><br>          <span class="hljs-string">docker</span> <span class="hljs-string">cp</span> <span class="hljs-string">gitlab:/etc/gitlab/gitlab-secrets.json</span> <span class="hljs-string">$&#123;BACKUP_DIR&#125;</span><br>          <br>          <span class="hljs-string">echo</span> <span class="hljs-string">&quot;Packaging All Backup Files...&quot;</span><br>          <span class="hljs-string">(cd</span> <span class="hljs-string">$&#123;TMPDIR&#125;</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">tar</span> <span class="hljs-string">-cvf</span> <span class="hljs-string">$&#123;PACKAGE_NAME&#125;</span> <span class="hljs-string">gitlab)</span><br>          <br>          <span class="hljs-string">echo</span> <span class="hljs-string">&quot;Sync Backup File To Remote Storage...&quot;</span><br>          <span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-string">--rm</span> <span class="hljs-string">-v</span> <span class="hljs-string">/etc/mc:/root/.mc</span> <span class="hljs-string">-v</span> <span class="hljs-string">/tmp:/host/tmp</span> <span class="hljs-string">hub.mi.os.sb/minio/mc</span> <span class="hljs-string">cp</span> <span class="hljs-string">/host/$&#123;TMPDIR&#125;/$&#123;PACKAGE_NAME&#125;</span> <span class="hljs-string">nas/gitlab/$&#123;PACKAGE_NAME&#125;</span><br>          <br>          <span class="hljs-string">echo</span> <span class="hljs-string">&quot;Backup Success!&quot;</span><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/opt/scripts/gitlab-restore.sh</span><br>      <span class="hljs-attr">mode:</span> <span class="hljs-number">0755</span><br>      <span class="hljs-attr">contents:</span><br>        <span class="hljs-attr">inline:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          #!/usr/bin/env bash</span><br><span class="hljs-string"></span>          <br>          <span class="hljs-string">set</span> <span class="hljs-string">-e</span><br>          <br>          <span class="hljs-string">tar</span> <span class="hljs-string">-xvf</span> <span class="hljs-string">$1</span><br>          <br>          <span class="hljs-string">TARBALL=$(basename</span> <span class="hljs-string">$(find</span> <span class="hljs-string">gitlab/</span> <span class="hljs-string">-type</span> <span class="hljs-string">f</span> <span class="hljs-string">-name</span> <span class="hljs-string">&#x27;*.tar&#x27;</span> <span class="hljs-string">|</span> <span class="hljs-string">head</span> <span class="hljs-string">-n</span> <span class="hljs-number">1</span><span class="hljs-string">))</span><br>          <span class="hljs-string">BACKUP_NAME=$(echo</span> <span class="hljs-string">$&#123;TARBALL&#125;</span> <span class="hljs-string">|</span> <span class="hljs-string">sed</span> <span class="hljs-string">&#x27;s@_gitlab_backup.tar$@@&#x27;</span><span class="hljs-string">)</span><br>          <br>          <span class="hljs-string">mv</span> <span class="hljs-string">gitlab/$&#123;TARBALL&#125;</span> <span class="hljs-string">/data/gitlab/data/backups</span><br>          <span class="hljs-string">chmod</span> <span class="hljs-number">777</span> <span class="hljs-string">/data/gitlab/data/backups/$&#123;TARBALL&#125;</span><br>          <br>          <span class="hljs-string">docker</span> <span class="hljs-string">exec</span> <span class="hljs-string">-it</span> <span class="hljs-string">gitlab</span> <span class="hljs-string">gitlab-ctl</span> <span class="hljs-string">stop</span> <span class="hljs-string">puma</span><br>          <span class="hljs-string">docker</span> <span class="hljs-string">exec</span> <span class="hljs-string">-it</span> <span class="hljs-string">gitlab</span> <span class="hljs-string">gitlab-ctl</span> <span class="hljs-string">stop</span> <span class="hljs-string">sidekiq</span><br>          <span class="hljs-string">docker</span> <span class="hljs-string">exec</span> <span class="hljs-string">-it</span> <span class="hljs-string">gitlab</span> <span class="hljs-string">gitlab-backup</span> <span class="hljs-string">restore</span> <span class="hljs-string">BACKUP=$&#123;BACKUP_NAME&#125;</span> <span class="hljs-string">force=yes</span><br>          <span class="hljs-string">docker</span> <span class="hljs-string">exec</span> <span class="hljs-string">-it</span> <span class="hljs-string">gitlab</span> <span class="hljs-string">gitlab-rake</span> <span class="hljs-string">gitlab:check</span> <span class="hljs-string">SANITIZE=true</span><br>          <br>          <span class="hljs-string">docker</span> <span class="hljs-string">cp</span> <span class="hljs-string">gitlab/gitlab.rb</span> <span class="hljs-string">gitlab:/etc/gitlab</span><br>          <span class="hljs-string">docker</span> <span class="hljs-string">cp</span> <span class="hljs-string">gitlab/gitlab-secrets.json</span> <span class="hljs-string">gitlab:/etc/gitlab</span><br>          <br>          <span class="hljs-string">systemctl</span> <span class="hljs-string">restart</span> <span class="hljs-string">gitlab</span><br>          <span class="hljs-string">journalctl</span> <span class="hljs-string">-fu</span> <span class="hljs-string">gitlab</span><br><br><span class="hljs-attr">systemd:</span><br>  <span class="hljs-attr">units:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab.service</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">contents:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        [Unit]</span><br><span class="hljs-string">        Description=The DevSecOps Platform</span><br><span class="hljs-string">        After=network-online.target</span><br><span class="hljs-string">        Wants=network-online.target</span><br><span class="hljs-string"></span><br>        [<span class="hljs-string">Service</span>]<br>        <span class="hljs-string">TimeoutStartSec=0</span><br>        <span class="hljs-string">ExecStartPre=-/usr/bin/docker</span> <span class="hljs-string">pull</span> <span class="hljs-string">gitlab/gitlab-ce</span> <br>        <span class="hljs-string">ExecStart=/usr/bin/docker</span> <span class="hljs-string">run</span> <span class="hljs-string">--rm</span> <span class="hljs-string">--tty</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">--name</span> <span class="hljs-string">gitlab</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">--hostname</span> <span class="hljs-string">gitlab</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-p</span> <span class="hljs-number">2222</span><span class="hljs-string">:22</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-p</span> <span class="hljs-number">2080</span><span class="hljs-string">:2080</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-e</span> <span class="hljs-string">GITLAB_OMNIBUS_CONFIG=&quot;from_file(&#x27;/host/etc/gitlab/gitlab.rb&#x27;)&quot;</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-v</span> <span class="hljs-string">/etc/gitlab:/host/etc/gitlab</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-v</span> <span class="hljs-string">/opt/scripts:/host/opt/scripts</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-v</span> <span class="hljs-string">/data/gitlab/data:/var/opt/gitlab</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-v</span> <span class="hljs-string">/data/gitlab/logs:/var/log/gitlab</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-v</span> <span class="hljs-string">/data/gitlab/config:/etc/gitlab</span> <span class="hljs-string">\</span><br>                                    <span class="hljs-string">gitlab/gitlab-ce</span><br><br>        [<span class="hljs-string">Install</span>]<br>        <span class="hljs-string">WantedBy=multi-user.target</span><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-backup.service</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">contents:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        [Unit]</span><br><span class="hljs-string">        Description=GitLab Backup Service</span><br><span class="hljs-string">        After=network-online.target gitlab.service</span><br><span class="hljs-string">        Wants=network-online.target</span><br><span class="hljs-string"></span>        <br>        [<span class="hljs-string">Service</span>]<br>        <span class="hljs-string">Type=simple</span><br>        <span class="hljs-string">Restart=on-failure</span><br>        <span class="hljs-string">ExecStart=/opt/scripts/gitlab-backup.sh</span><br>        <br>        [<span class="hljs-string">Install</span>]<br>        <span class="hljs-string">WantedBy=multi-user.target</span><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-backup.timer</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">contents:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        [Unit]</span><br><span class="hljs-string">        Description=GitLab Auto Backup Timer</span><br><span class="hljs-string">        After=network-online.target gitlab.service</span><br><span class="hljs-string">        Wants=network-online.target</span><br><span class="hljs-string"></span>        <br>        [<span class="hljs-string">Timer</span>]<br>        <span class="hljs-comment"># Run at 3am, 11am, 5pm and 8pm every day in UTC+8</span><br>        <span class="hljs-string">OnCalendar=*-*-*</span> <span class="hljs-number">3</span><span class="hljs-string">,11,17,20:00:00</span> <span class="hljs-string">Asia/Shanghai</span><br>        <br>        [<span class="hljs-string">Install</span>]<br>        <span class="hljs-string">WantedBy=timers.target</span><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">caddy.service</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">contents:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        [Unit]</span><br><span class="hljs-string">        Description=The Ultimate Server</span><br><span class="hljs-string">        After=network-online.target gitlab.service</span><br><span class="hljs-string">        Wants=network-online.target</span><br><span class="hljs-string"></span><br>        [<span class="hljs-string">Service</span>]<br>        <span class="hljs-string">TimeoutStartSec=0</span><br>        <span class="hljs-string">ExecStartPre=-/usr/bin/docker</span> <span class="hljs-string">pull</span> <span class="hljs-string">mritd/caddy</span><br>        <span class="hljs-string">ExecStart=/usr/bin/docker</span> <span class="hljs-string">run</span> <span class="hljs-string">--rm</span> <span class="hljs-string">--tty</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">--name</span> <span class="hljs-string">caddy</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">--env-file</span> <span class="hljs-string">/etc/caddy/env</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">--link</span> <span class="hljs-string">gitlab</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-p</span> <span class="hljs-number">80</span><span class="hljs-string">:80</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-p</span> <span class="hljs-number">443</span><span class="hljs-string">:443/tcp</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-p</span> <span class="hljs-number">443</span><span class="hljs-string">:443/udp</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-v</span> <span class="hljs-string">/etc/caddy:/etc/caddy</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-v</span> <span class="hljs-string">/data/caddy/data:/data</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-v</span> <span class="hljs-string">/data/caddy/config:/config</span> <span class="hljs-string">\</span><br>                                    <span class="hljs-string">mritd/caddy</span><br><br>        [<span class="hljs-string">Install</span>]<br>        <span class="hljs-string">WantedBy=multi-user.target</span><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">watchtower.service</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">contents:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        [Unit]</span><br><span class="hljs-string">        Description=A container-based solution for automating Docker container base image updates.</span><br><span class="hljs-string">        After=network-online.target</span><br><span class="hljs-string">        Wants=network-online.target</span><br><span class="hljs-string"></span><br>        [<span class="hljs-string">Service</span>]<br>        <span class="hljs-string">ExecStartPre=/usr/bin/docker</span> <span class="hljs-string">pull</span> <span class="hljs-string">containrrr/watchtower</span><br>        <span class="hljs-string">ExecStart=/usr/bin/docker</span> <span class="hljs-string">run</span> <span class="hljs-string">--rm</span> <span class="hljs-string">--tty</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">--name</span> <span class="hljs-string">watchtower</span> <span class="hljs-string">\</span><br>                                  <span class="hljs-string">-v</span> <span class="hljs-string">/var/run/docker.sock:/var/run/docker.sock</span> <span class="hljs-string">\</span><br>                                    <span class="hljs-string">containrrr/watchtower</span> <span class="hljs-string">--cleanup</span> <span class="hljs-string">--schedule</span> <span class="hljs-string">&quot;0 30 17 * * *&quot;</span><br><br>        [<span class="hljs-string">Install</span>]<br>        <span class="hljs-string">WantedBy=multi-user.target</span><br><br></code></pre></td></tr></table></figure><h2 id="七、其他说明"><a href="#七、其他说明" class="headerlink" title="七、其他说明"></a>七、其他说明</h2><p>默认情况下 FlatCar 的 <code>/usr</code> 分区是不可写入的, 所以不要尝试向此目录中写入文件这会导致启动失败; 除此之外类似 <code>/opt</code> 之类的目录都可以持久化存放数据; 不过 Fedora CoreOS 似乎并不相同, 具体需要查阅官方文档.</p><p>FlatCar 如果想要扩展一些系统级的目录需要使用 Systemd-sysext, 具体请查看 <a target="_blank" rel="noopener" href="https://www.flatcar.org/docs/latest/provisioning/sysext/">官方文档</a>; Fedora CoreOS 可以通过 rpm-ostree 直接安装软件包, 但有些服务可能需要重启才能生效(例如 open-vm-tools).</p><p>本篇文章仅描述了基本使用, 复杂情况例如批量更新控制等限于篇幅还请阅读官方文档.</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/linux/" class="category-chain-item">Linux</a> <span>></span> <a href="/categories/linux/docker/" class="category-chain-item">Docker</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/docker/" class="print-no-link">#Docker</a> <a href="/tags/coreos/" class="print-no-link">#CoreOS</a> <a href="/tags/flatcar/" class="print-no-link">#FlatCar</a></div></div><div class="license-box my-3"><div class="license-title"><div>容器化系统折腾</div><div>https://mritd.com/2023/07/20/containerized-system-test/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Kovacs</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年7月20日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/01/11/mysql-binlog-restore/" title="MySQL Binlog 数据恢复"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">MySQL Binlog 数据恢复</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/05/23/write-mysql-udf-in-golang/" title="Golang 编写 MySQL UDF"><span class="hidden-mobile">Golang 编写 MySQL UDF</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://mritd.com/2023/07/20/containerized-system-test/",this.page.identifier="/2023/07/20/containerized-system-test/"};Fluid.utils.loadComments("#disqus_thread",(function(){var t=document,e=t.createElement("script");e.src="//bleem.disqus.com/embed.js",e.setAttribute("data-timestamp",new Date),(t.head||t.body).appendChild(e)}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-docker"></i> <a href="https://bandwagonhost.com/aff.php?aff=61367" target="_blank" rel="nofollow noopener"><span>BandwagonHost</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!0,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>