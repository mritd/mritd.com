<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Kovacs"><meta name="keywords" content="UPS,Nut"><meta name="description" content="头年租的房子楼里一直在装修, 然后老是停电, 没办法搞了一个 UPS; 以前一直把 UPS 直接接到黑群晖 NAS 里, 最近重装决定单独在 Ubuntu 里装 Nut 来统一处理供电出现问题时各种服务优雅关闭问题."><meta property="og:type" content="article"><meta property="og:title" content="UPS Nut 配置教程"><meta property="og:url" content="https://mritd.com/2023/03/18/ups-nut-configuration-tutorial/index.html"><meta property="og:site_name" content="Kovacs"><meta property="og:description" content="头年租的房子楼里一直在装修, 然后老是停电, 没办法搞了一个 UPS; 以前一直把 UPS 直接接到黑群晖 NAS 里, 最近重装决定单独在 Ubuntu 里装 Nut 来统一处理供电出现问题时各种服务优雅关闭问题."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mritd.com/img/ups.jpg"><meta property="article:published_time" content="2023-03-18T11:16:00.000Z"><meta property="article:modified_time" content="2023-03-18T11:16:00.000Z"><meta property="article:author" content="Kovacs"><meta property="article:tag" content="UPS"><meta property="article:tag" content="Nut"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://mritd.com/img/ups.jpg"><meta name="twitter:creator" content="@kovacs_orz"><meta name="twitter:site" content="https://twitter.com/kovacs_orz"><title>UPS Nut 配置教程 - Kovacs</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"mritd.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!0,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:"G-H06NPECR0Z"},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-H06NPECR0Z",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-H06NPECR0Z")}))</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Kovacs" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="Kovacs" type="application/rss+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Kovacs</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/friends/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="UPS Nut 配置教程"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Kovacs </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-03-18 19:16" pubdate>2023年3月18日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.3k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 28 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">UPS Nut 配置教程</h1><div class="markdown-body"><h2 id="一、Nut-安装"><a href="#一、Nut-安装" class="headerlink" title="一、Nut 安装"></a>一、Nut 安装</h2><p>这里我采用的是 Ubuntu Server 22.04 系统, 安装直接一条 apt 命令即可:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">apt install -y nut<br></code></pre></td></tr></table></figure><h2 id="二、Nut-服务组成"><a href="#二、Nut-服务组成" class="headerlink" title="二、Nut 服务组成"></a>二、Nut 服务组成</h2><p>在配置 Nut 之前需要先了解下一 Nut 的各个组件及其作用, Nut 主要包含三个核心服务:</p><ul><li>nut-driver: 这个服务负责通过特定放驱动来与 UPS 进行通信</li><li>nut-server: 该服务利用 nut-dirver 沟通 UPS, 并将 UPS 状态通过网络服务发布</li><li>nut-monitor(nut-client): 该服务连接 nut-server, 根据 UPS 状态做出特定响应</li></ul><p>注意: nut-client 实际上是一个 systemd 软连接文件, 本质上还是 nut-monitor.</p><p>为了更容易理解这里画了一个简单的图:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh">             ┌─────────────┐                  ┌────────────┐<br>       ┌──── │ nut-monitor │ ───────────────► │ nut-server │<br>       │     └─────────────┘                  └────────────┘<br>       │<br>       │                                            │<br>       │                                            │<br>       ▼                                            ▼<br> ┌─────────────┐                              ┌────────────┐<br> │  upssched   │                              │ nut-driver │<br> └─────────────┘                              └────────────┘<br><br>        │                                           │<br>        │                                           │<br>        │                                           │<br>        ▼                                           ▼<br>┌────────────────┐                            ┌─────────────┐<br>│  user scripts  │                            │     UPS     │<br>└────────────────┘                            └─────────────┘<br></code></pre></td></tr></table></figure><h2 id="三、Nut-基本配置"><a href="#三、Nut-基本配置" class="headerlink" title="三、Nut 基本配置"></a>三、Nut 基本配置</h2><p>在 Nut 安装完成后会自动在 <code>/etc/nut</code> 目录生成配置文件, 接下来的配置工作主要是调整该目录下的各种配置文件.</p><h3 id="3-1、nut-conf"><a href="#3-1、nut-conf" class="headerlink" title="3.1、nut.conf"></a>3.1、nut.conf</h3><p>该配置主要定义 nut 的运行模式, 只有一个配置字段 <code>MODE=xxxx</code>, 该配置可选值及含义如下:</p><ul><li><code>none</code>: Nut 未配置或使用外部系统启动 Nut 服务, 可以理解为 “啥也不干”.</li><li><code>standalone</code>: 独立模式, 一般在只有一个 UPS 且只负责本地系统(不提供网络服务)的情况下使用.</li><li><code>netserver</code>: 跟独立模式类似, 会启动 driver、upsd 和 upsmon 服务, 不同之处是可以提供网络服务, 其他机器上的 nut-monitor 可以通过网络来连接 Nut Server.</li><li><code>netclient</code>: 仅客户端模式, 只启动 nut-monitor, 用于连接远程的 Nut 服务.</li></ul><p>我这是为了方便后续扩展, 所以使用了最全的 <code>netserver</code> 模式:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">MODE=netserver<br></code></pre></td></tr></table></figure><h3 id="3-2、ups-conf"><a href="#3-2、ups-conf" class="headerlink" title="3.2、ups.conf"></a>3.2、ups.conf</h3><p>该配置用于定义 nut-driver 如何连接到物理 UPS, 该配置文件的饿配置格式如下:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[nutdev1]</span><br>    <span class="hljs-attr">driver</span> = <span class="hljs-string">&quot;usbhid-ups&quot;</span><br>    <span class="hljs-attr">port</span> = <span class="hljs-string">&quot;auto&quot;</span><br></code></pre></td></tr></table></figure><p>其中 <code>nutdev1</code> 表示该 UPS 名称, 可以随意定义; <strong><code>driver</code> 用于定义连接到该 UPS 需要使用的驱动, 一般情况下如果使用 USB 连接像我这样写都是可以识别到的.</strong> 如果同样都是用 USB 连接但识别不到, 可以使用 <code>nut-scanner</code> 命令进行扫描, 扫描成功后会在控制台打印出 UPS 相关配置样例.</p><p><strong>需要注意的是, 如果想要群晖或者 QNAP 能通过网络连接 UPS, 那么 UPS 的名称是有特殊要求的(群晖必须起名叫 <code>ups</code>, QNAP 没有测试过可能叫 <code>qnapups</code>);</strong> 因为这两个系统都写死了, 包括后面的用户名和密码也是, 具体在下文会有说明.</p><p>除了 USB 连接 UPS 之外 Nut 还支持多种驱动连接 UPS, 例如 APC 专用的驱动程序, 有关于 Nut 具体连接方式请查看官方文档:</p><ul><li><a target="_blank" rel="noopener" href="https://networkupstools.org/docs/man/genericups.html">genericups</a></li><li><a target="_blank" rel="noopener" href="https://networkupstools.org/docs/man/usbhid-ups.html">usbhid-ups</a></li><li><a target="_blank" rel="noopener" href="https://networkupstools.org/docs/man/blazer.html">blazer_ser&#x2F;blazer_usb</a></li><li><a target="_blank" rel="noopener" href="https://networkupstools.org/docs/man/snmp-ups.html">snmp-ups</a></li><li><a target="_blank" rel="noopener" href="https://networkupstools.org/docs/man/powerman-pdu.html">powerman-pdu</a></li><li><a target="_blank" rel="noopener" href="https://networkupstools.org/docs/man/apcupsd-ups.html">apcupsd-ups</a></li></ul><h3 id="3-3、upsd-conf"><a href="#3-3、upsd-conf" class="headerlink" title="3.3、upsd.conf"></a>3.3、upsd.conf</h3><p>该配置文件用于控制 nut-server 的网络服务, 例如监听端口、最大连接数、证书配置等; 由于我是在内网使用, 所以只需要配置网络监听, 其他参数保持默认即可:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">LISTEN 0.0.0.0 3493<br></code></pre></td></tr></table></figure><p>如果想要完整查看支持哪些配置, 请参考官方文档: <a target="_blank" rel="noopener" href="https://networkupstools.org/docs/man/upsd.conf.html">UPSD.CONF(5)</a></p><h3 id="3-4、upsd-users"><a href="#3-4、upsd-users" class="headerlink" title="3.4、upsd.users"></a>3.4、upsd.users</h3><p>upsd.users 配置文件用于定义通过网络连接到 <code>nut-server</code> 的用户名和密码, 该配置样例如下:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[monuser]</span><br>    <span class="hljs-attr">password</span> = secret<br>    <span class="hljs-attr">upsmon</span> = master<br><span class="hljs-section">[admin]</span><br>    <span class="hljs-attr">password</span> = <span class="hljs-number">123456</span><br>    <span class="hljs-attr">upsmon</span> = master<br></code></pre></td></tr></table></figure><p>上面的 <code>[xxxx]</code> 代表用户名, 密码由 <code>password</code> 字段指定; 除此之外还有一些特殊参数:</p><ul><li><code>actions</code>: 指定该用户具有哪些操作权限, 可选值 <code>SET</code>(更改 UPS 变量)、<code>FSD</code>(设置 UPS 强制关机标志); 如果需要两个都指定, 则需要写两次 <code>actions</code>.</li><li><code>instcmds</code>: 让用户启动的即时命令, 值 <code>ALL</code> 代表所有, 其他的可通过 <code>upscmd -l</code> 查看; 同样如果要指定多个需要写多次 <code>instcmds</code>.</li><li><code>upsmon</code>: 为 upsmon 进程添加必要的操作, 可选值 <code>primary</code>、<code>secondary</code>(一般用不到)</li></ul><p><strong>注意: Ubuntu Server 22.04 上的版本可能没有那么新, upsmon 实际上支持的是 <code>master</code>、<code>slave</code> 两个参数(怀疑与某场运动有关).</strong></p><hr><p><strong>关于 群晖 和 QNAP 用户: 如果期望这两个 NAS 可以直接连接到 Nut Server, 可以确认的是群晖需要保证存在用户名为 <code>monuser</code> 密码为 <code>secret</code> 的用户; QNAP 我没有验证过, 网上查询到的结果是需要保证存在用户名为 <code>admin</code> 密码为 <code>123456</code> 的用户.</strong></p><h2 id="四、Nut-监控配置"><a href="#四、Nut-监控配置" class="headerlink" title="四、Nut 监控配置"></a>四、Nut 监控配置</h2><p>相较于基本配置来说, Nut 核心处理在于如何做好监控配置; Nut 对于监控策略支持大致有两种:</p><ul><li>1、直接由 <code>upsmon.conf</code> 配置, 任何事件直接由用户指定的脚本负责处理, 没有定时器等高级特性</li><li>2、在 <code>upsmon.conf</code> 中配置执行脚本为 <code>upssched</code>, 任何事件先由 <code>upssched</code> 处理, 借助于 upssched 可以实现一些高级功能, 比如选择性触发关机等</li></ul><h3 id="4-1、upsmon-conf"><a href="#4-1、upsmon-conf" class="headerlink" title="4.1、upsmon.conf"></a>4.1、upsmon.conf</h3><p>该配置主要用于配置 nut-monitor 如何监控 UPS, 同时定义 UPS 出现哪些事件要进行怎样的处理动作, 下面详细解释一下核心配置.</p><h4 id="4-1-1、MONITOR-指令"><a href="#4-1-1、MONITOR-指令" class="headerlink" title="4.1.1、MONITOR 指令"></a>4.1.1、MONITOR 指令</h4><p><strong><code>MONITOR</code> 指令用于定义要监控 UPS 的连接地址,</strong> 其格式如下:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">MONITOR &lt;system&gt; &lt;powervalue&gt; &lt;username&gt; &lt;password&gt; (&quot;master&quot;|&quot;slave&quot;)<br></code></pre></td></tr></table></figure><ul><li><code>&lt;system&gt;</code>: nut-server 链接地址, 格式为 “UPS 名称” + “@” + “nut-server 地址”, 例如 <code>myups@192.168.1.2</code></li><li><code>&lt;powervalue&gt;</code>: UPS 数量, 大多数情况你只有一个 UPS 电源, 所以写 1 就行</li><li><code>&lt;username&gt;/&lt;password&gt;</code>: 在 <code>upsd.users</code> 中定义的用户名和密码</li><li><code>master/slave</code>: <code>master</code> 表示该系统将最后关闭, 让从属系统先关闭; <code>slave</code> 表示该系统立即关闭</li></ul><p>以下为我的配置样例:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">MONITOR ups@localhost 1 monuser secret master<br></code></pre></td></tr></table></figure><h4 id="4-1-2、SHUTDOWNCMD"><a href="#4-1-2、SHUTDOWNCMD" class="headerlink" title="4.1.2、SHUTDOWNCMD"></a>4.1.2、SHUTDOWNCMD</h4><p><code>SHUTDOWNCMD</code> 指令用于定义在 UPS 电量不足或者需要主动关机时的关机命令, 建议填写完整路径</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">SHUTDOWNCMD &quot;/usr/sbin/poweroff&quot;<br></code></pre></td></tr></table></figure><h4 id="4-1-3、NOTIFYCMD"><a href="#4-1-3、NOTIFYCMD" class="headerlink" title="4.1.3、NOTIFYCMD"></a>4.1.3、NOTIFYCMD</h4><p><code>NOTIFYCMD</code> 指令是一个非常重要的指令, <strong>该指令用于配置在发生特定事件(如市电中断、UPS 处于低电量等)时, <code>nut-monitor</code> 所执行的命令.</strong> 简单的说就是 <code>NOTIFYCMD</code> 定义了具体执行命令, 可以直接在此处配置一个自己编写的脚本, 当 UPS 有事件发生时此脚本都会被调用.</p><p><code>NOTIFYCMD</code> 指令大致有两种配置方式, 一种是配置成自己的脚本, <strong>脚本需要有可执行权限, 脚本内可以通过 <code>NOTIFY</code> 环境变量获取事件类型, 然后自己进行处理.</strong> 这种方式有点 “简单粗暴” 的意思, 可定制化程度完全依赖于你的脚本怎么写. 具体可以使用哪些变量请自行测试, 因为版本不同可能环境变量名称也不同.</p><p>还有一种方式是将 <code>NOTIFYCMD</code> 配置为执行内置的 <code>upssched</code> 命令; <code>upssched</code> 是 Nut 提供的一个带有特定策略的调度程序; 简而言之就是基于常用的功能进行了抽象, <code>upssched</code> 有自己单独配置, 可以实现 “如果市电在 180s 内恢复则不进行关机” 的这种高级调度策略.</p><p>这里我选择使用第二种方式, 因为自己搓脚本能力实在不怎么样:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">NOTIFYCMD /usr/sbin/upssched<br></code></pre></td></tr></table></figure><h4 id="4-1-4、NOTIFYFLAG"><a href="#4-1-4、NOTIFYFLAG" class="headerlink" title="4.1.4、NOTIFYFLAG"></a>4.1.4、NOTIFYFLAG</h4><p><code>NOTIFYFLAG</code> 同样是关键配置, 需要与 <code>NOTIFYCMD</code> 配合使用; <code>NOTIFYFLAG</code> 指令负责指定一系列的 UPS 事件应该触发何种操作, 该指令格式如下:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">NOTIFYFLAG &lt;notify type&gt; &lt;flag&gt;<span class="hljs-section">[+&lt;flag&gt;]</span><span class="hljs-section">[+&lt;flag&gt;]</span> ...<br></code></pre></td></tr></table></figure><p>其中 <code>&lt;notify type&gt;</code> 表示事件类型, 可选类型如下:</p><ul><li><code>ONLINE</code>: UPS 在线, 即市电恢复时会触发</li><li><code>ONBATT</code>: UPS 使用电池供电, 即市电中断时会触发</li><li><code>LOWBATT</code>: UPS 低电量时会触发</li><li><code>FSD</code>: UPS 正在被关闭(Forced Shutdown)</li><li><code>COMMOK</code>: 与 nut-server 成功建立连接时触发</li><li><code>COMMBAD</code>: 与 nut-server 建立连接失败(连接丢失)时触发</li><li><code>SHUTDOWN</code>: UPS 发出关机指令触发</li><li><code>REPLBATT</code>: UPS 需要更换电池时触发</li><li><code>NOCOMM</code>: 无法与 UPS 建立连接(UPS未就绪)时触发</li></ul><p>对于 <code>flag</code> 标志通常有四种, 多种组合时用加号(+)连接:</p><ul><li><code>SYSLOG</code>: 只打印 syslog</li><li><code>WALL</code>: 在终端上弹出消息(&#x2F;bin&#x2F;wall)</li><li><code>EXEC</code>: <strong>调用 <code>NOTIFYCMD</code> 指定的命令, 并传递相关事件</strong></li><li><code>IGNORE</code>: 啥也不干, 忽略该事件</li></ul><p><strong>如果 <code>NOTIFYCMD</code> 使用了自定义脚本, 则此处请根据实际需要来配置需要脚本处理的事件; 如果 <code>NOTIFYCMD</code> 配置为使用 <code>upssched</code>, 可以将所有事件配置为 <code>EXEC</code>, 然后具体过滤在 <code>upssched</code> 处理.</strong></p><p>例如如果只想让 <code>NOTIFYCMD</code> 配置的脚本只处理市电中断和恢复事件, 同时打印 syslog, 可以这样配置:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini">NOTIFYFLAG ONLINE SYSLOG+EXEC<br>NOTIFYFLAG ONBATT SYSLOG+EXEC<br></code></pre></td></tr></table></figure><p>由于我 <code>NOTIFYCMD</code> 配置的是 <code>upssched</code>, 所以我这里将所有事件全部传递给 <code>upssched</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs init">NOTIFYFLAG ONLINE SYSLOG+EXEC<br>NOTIFYFLAG ONBATT SYSLOG+EXEC<br>NOTIFYFLAG LOWBATT SYSLOG+EXEC<br>NOTIFYFLAG FSD SYSLOG+EXEC<br>NOTIFYFLAG COMMOK SYSLOG+EXEC<br>NOTIFYFLAG COMMBAD SYSLOG+EXEC<br>NOTIFYFLAG SHUTDOWN SYSLOG+EXEC<br>NOTIFYFLAG REPLBATT SYSLOG+EXEC<br>NOTIFYFLAG NOPARENT SYSLOG+EXEC<br></code></pre></td></tr></table></figure><h4 id="4-1-5、其他配置"><a href="#4-1-5、其他配置" class="headerlink" title="4.1.5、其他配置"></a>4.1.5、其他配置</h4><p>除了以上的核心配置, 其他配置如果没特殊情况一般保持默认即可; 具体的配置可以参考官方文档: <a target="_blank" rel="noopener" href="https://networkupstools.org/docs/man/upsmon.conf.html">UPSMON.CONF(5)</a>.</p><h3 id="4-2、upssched-conf"><a href="#4-2、upssched-conf" class="headerlink" title="4.2、upssched.conf"></a>4.2、upssched.conf</h3><p><strong>使用该配置的前提是 <code>upsmon.conf</code> 配置中的 <code>NOTIFYCMD</code> 指向了 <code>upssched</code>, 并且 <code>NOTIFYFLAG</code> 为相关事件配置了 <code>EXEC</code>;</strong> 该配置主要的作用是使用一些 <code>upssched</code> 内置的高级语法来控制特定事件的处理方式. <code>upssched.conf</code> 配置主要包含两部分: 头部的选项配置和尾部的规则配置.</p><h4 id="4-2-1、选项配置"><a href="#4-2-1、选项配置" class="headerlink" title="4.2.1、选项配置"></a>4.2.1、选项配置</h4><p>头部选项配置只包含三个配置:</p><ul><li><code>CMDSCRIPT</code>: <strong>该配置应该位于首行(推荐这样, 实际上是 AT 指令之前就行), 该指令用于定义事件的处理脚本; 脚本一般由用户自行编写, <code>upssched</code> 会根据规则将指定参数传递到此脚本并执行.</strong></li><li><code>PIPEFN</code>: 用于进程间通信的管道文件, 需要位于 AT 指令之前</li><li><code>LOCKFN</code>: 互斥锁文件, 用于防止 upsmon 同时调度多个文件, 需要位于 AT 指令之前</li></ul><p>关于 <code>CMDSCRIPT</code> 配置的脚本, 下面是一个样例:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/usr/bin/env bash</span><br><br><span class="hljs-built_in">set</span> -ex<br><br><span class="hljs-built_in">exec</span> &gt;&gt; /var/log/upssched-cmd.log 2&gt;&amp;1<br><br><span class="hljs-comment"># 主要负责关闭系统的函数</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">xpoweroff</span></span>()&#123;<br>    logger -t upssched-cmd <span class="hljs-string">&#x27;准备关闭 XPEnology...&#x27;</span><br>    logger -t upssched-cmd <span class="hljs-string">&#x27;准备关闭 TProxy Gateway...&#x27;</span><br>    logger -t upssched-cmd <span class="hljs-string">&#x27;所有必要系统已成功关闭...&#x27;</span><br>&#125;<br><br><span class="hljs-comment"># 判断 upssched 触发的事件</span><br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>    onbattwarn)<br>        logger -t upssched-cmd <span class="hljs-string">&#x27;UPS 已经切换到电池供电, 准备安全关闭系统...&#x27;</span><br>        xpoweroff<br>        ;;<br>    ups-back-on-line)<br>        logger -t upssched-cmd <span class="hljs-string">&#x27;市电已恢复...&#x27;</span><br>        ;;<br>    lowbatt)<br>        logger -t upssched-cmd <span class="hljs-string">&#x27;UPS 电量不足, 立即关闭系统...&#x27;</span><br>        xpoweroff<br>        ;;<br>    *)<br>        logger -t upssched-cmd <span class="hljs-string">&quot;Unrecognized command: <span class="hljs-variable">$1</span>&quot;</span><br>        ;;<br><span class="hljs-keyword">esac</span><br></code></pre></td></tr></table></figure><p><strong>有一点需要注意, <code>CMDSCRIPT</code> 配置的脚本默认是以 <code>nut</code> 用户运行的, 所以要处理好 <code>nut</code> 用户权限问题.</strong></p><p>对于 <code>PIPEFN</code> 和 <code>LOCKFN</code> 官方推荐单独创建叫 <code>upssched</code> 目录, 然后文件放在这个目录里; <strong>但是有些系统例如 Ubuntu Server 22.04, <code>/run/nut/</code> 是 tmpfs, 重启会丢失目录导致出现权限问题; 所以推荐直接不创建独立目录直接配置:</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini">CMDSCRIPT /opt/scripts/upssched-cmd.sh<br>PIPEFN /run/nut/upssched.pipe<br>LOCKFN /run/nut/upssched.lock<br></code></pre></td></tr></table></figure><h4 id="4-2-2、规则配置"><a href="#4-2-2、规则配置" class="headerlink" title="4.2.2、规则配置"></a>4.2.2、规则配置</h4><p>使用 <code>upssched</code> 的好处就是内置了一个规则引擎, 我们可以通过一些简单的语法来配置复杂规则; <code>upssched</code> 的规则语法如下:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">AT notifytype upsname command <br></code></pre></td></tr></table></figure><p>规则以 <code>AT</code> 开头, <code>notifytype</code> 用于指定需要关注的事件类型; <code>upsname</code> 指定 UPS 名称, 只有一个的情况下或者不想区分时可以无脑写 <code>*</code>; <code>command</code> 部分用于指定需要执行的动作, <code>command</code> 大致有三种类型:</p><ul><li><code>START-TIMER</code>: 启动一个定时器</li><li><code>CANCEL-TIMER</code>: 取消一个定时器</li><li><code>EXECUTE</code>: 立即执行</li></ul><p>这部分看起来复杂实际很简单, 例如以下规则实现了: <strong>当市电断开(UPS 使用电池供电时)启动一个名字叫 <code>onbattwarn</code> 的定时器, 这个定时器在 180s 后会执行 <code>CMDSCRIPT</code> 定义的脚本并将 <code>onbattwarn</code> 作为第一个参数传递给脚本; 同时如果市电在计时器的 180s 之内恢复(临时闪断), 则取消执行脚本.</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini">AT ONBATT * START-TIMER onbattwarn 180<br>AT ONLINE * CANCEL-TIMER onbattwarn<br></code></pre></td></tr></table></figure><p>当然也有些事件是需要立即执行的, 例如: <strong>市电中断立即发送通知</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 立即执行 `CMDSCRIPT` 指定的脚本, 并将 `onbattnoti` 作为参数传递给脚本</span><br>AT ONBATT * EXECUTE onbattnoti<br></code></pre></td></tr></table></figure><h2 id="五、配置参考"><a href="#五、配置参考" class="headerlink" title="五、配置参考"></a>五、配置参考</h2><p>上面说了那么多, 下面给一个完整的我个人的配置参考:</p><p><strong>nut.conf</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">MODE</span>=netserver<br></code></pre></td></tr></table></figure><hr><p><strong>ups.conf</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 名称是为了一开始兼容群晖, 所以就叫 UPS</span><br><span class="hljs-section">[ups]</span><br>    <span class="hljs-attr">driver</span> = <span class="hljs-string">&quot;usbhid-ups&quot;</span><br>    <span class="hljs-attr">port</span> = <span class="hljs-string">&quot;auto&quot;</span><br></code></pre></td></tr></table></figure><hr><p><strong>upsd.conf</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">LISTEN 0.0.0.0 3493<br></code></pre></td></tr></table></figure><hr><p><strong>upsd.users</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[monuser]</span><br>    <span class="hljs-attr">password</span> = secret<br>    <span class="hljs-attr">upsmon</span> = master<br><span class="hljs-section">[qnapups]</span><br>    <span class="hljs-attr">password</span> = <span class="hljs-number">123456</span><br>    <span class="hljs-attr">upsmon</span> = primary<br></code></pre></td></tr></table></figure><hr><p><strong>upsmon.conf</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs ini">MONITOR ups@localhost 1 monuser secret master<br>MINSUPPLIES 1<br>SHUTDOWNCMD &quot;/usr/sbin/poweroff&quot;<br>NOTIFYCMD /usr/sbin/upssched<br>POLLFREQ 5<br>POLLFREQALERT 5<br>HOSTSYNC 30<br>DEADTIME 15<br>POWERDOWNFLAG /etc/killpower<br>NOTIFYFLAG ONLINE SYSLOG+EXEC<br>NOTIFYFLAG ONBATT SYSLOG+EXEC<br>NOTIFYFLAG LOWBATT SYSLOG+EXEC<br>NOTIFYFLAG FSD SYSLOG+EXEC<br>NOTIFYFLAG COMMOK SYSLOG+EXEC<br>NOTIFYFLAG COMMBAD SYSLOG+EXEC<br>NOTIFYFLAG SHUTDOWN SYSLOG+EXEC<br>NOTIFYFLAG REPLBATT SYSLOG+EXEC<br>NOTIFYFLAG NOPARENT SYSLOG+EXEC<br>RBWARNTIME 43200<br>NOCOMMWARNTIME 300<br>FINALDELAY 5<br></code></pre></td></tr></table></figure><hr><p><strong>upssched.conf</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ini">CMDSCRIPT /opt/scripts/upssched-cmd.sh<br>PIPEFN /run/nut/upssched.pipe<br>LOCKFN /run/nut/upssched.lock<br>AT ONBATT * START-TIMER onbattwarn 180<br>AT ONLINE * CANCEL-TIMER onbattwarn<br>AT ONLINE * EXECUTE ups-back-on-line<br>AT LOWBATT * EXECUTE lowbatt<br></code></pre></td></tr></table></figure><hr><p><strong>upssched-cmd.sh</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/usr/bin/env bash</span><br><br><span class="hljs-built_in">set</span> -ex<br><br><span class="hljs-built_in">exec</span> &gt;&gt; /var/log/upssched-cmd.log 2&gt;&amp;1<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;执行 ID: <span class="hljs-subst">$(id)</span>&quot;</span><br><br>SSH_CMD=<span class="hljs-string">&#x27;ssh -o StrictHostKeyChecking=no&#x27;</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">xpoweroff</span></span>()&#123;<br>    logger -t upssched-cmd <span class="hljs-string">&#x27;准备关闭 XPEnology...&#x27;</span><br>    <span class="hljs-variable">$&#123;SSH_CMD&#125;</span> root@192.168.1.2 poweroff || <span class="hljs-literal">true</span><br>    logger -t upssched-cmd <span class="hljs-string">&#x27;准备关闭 TProxy Gateway...&#x27;</span><br>    <span class="hljs-variable">$&#123;SSH_CMD&#125;</span> root@192.168.1.3 poweroff || <span class="hljs-literal">true</span><br>    logger -t upssched-cmd <span class="hljs-string">&#x27;所有必要系统已成功关闭...&#x27;</span><br>&#125;<br><br><span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>    onbattwarn)<br>        logger -t upssched-cmd <span class="hljs-string">&#x27;UPS 已经切换到电池供电, 准备安全关闭系统...&#x27;</span><br>        xpoweroff<br>        ;;<br>    ups-back-on-line)<br>        logger -t upssched-cmd <span class="hljs-string">&#x27;市电已恢复...&#x27;</span><br>        ;;<br>    lowbatt)<br>        logger -t upssched-cmd <span class="hljs-string">&#x27;UPS 电量不足, 立即关闭系统...&#x27;</span><br>        xpoweroff<br>        ;;<br>    *)<br>        logger -t upssched-cmd <span class="hljs-string">&quot;Unrecognized command: <span class="hljs-variable">$1</span>&quot;</span><br>        ;;<br><span class="hljs-keyword">esac</span><br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/linux/" class="category-chain-item">Linux</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/ups/" class="print-no-link">#UPS</a> <a href="/tags/nut/" class="print-no-link">#Nut</a></div></div><div class="license-box my-3"><div class="license-title"><div>UPS Nut 配置教程</div><div>https://mritd.com/2023/03/18/ups-nut-configuration-tutorial/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Kovacs</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年3月18日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/03/21/install-xpenology-on-esxi-using-arpl/" title="ESXi ARPL 安装黑群晖"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">ESXi ARPL 安装黑群晖</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2022/12/30/vcenter-server-uses-acme-cert/" title="vCenter Server 使用 ACME 证书"><span class="hidden-mobile">vCenter Server 使用 ACME 证书</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://mritd.com/2023/03/18/ups-nut-configuration-tutorial/",this.page.identifier="/2023/03/18/ups-nut-configuration-tutorial/"};Fluid.utils.loadComments("#disqus_thread",(function(){var t=document,i=t.createElement("script");i.src="//bleem.disqus.com/embed.js",i.setAttribute("data-timestamp",new Date),(t.head||t.body).appendChild(i)}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-docker"></i> <a href="https://bandwagonhost.com/aff.php?aff=61367" target="_blank" rel="nofollow noopener"><span>BandwagonHost</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!0,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>