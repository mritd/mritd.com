<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Kovacs"><meta name="keywords" content="Synology,ESXi,ARPL"><meta name="description" content="以前一直使用 HPE Gen8 在宿主机上插淘宝买的 U 盘做黑群晖, 最近有入手了 HPE Gen10, 也想搞一个黑群晖; 不过迫于对虚拟化有一定要求, 所以最终选定使用 ESXi 做底层, 然后虚拟机安装黑群晖; 安装过程参考了很多方案最终选定 ARPL, 这里记录一下安装过程."><meta property="og:type" content="article"><meta property="og:title" content="ESXi ARPL 安装黑群晖"><meta property="og:url" content="https://mritd.com/2023/03/21/install-xpenology-on-esxi-using-arpl/index.html"><meta property="og:site_name" content="Kovacs"><meta property="og:description" content="以前一直使用 HPE Gen8 在宿主机上插淘宝买的 U 盘做黑群晖, 最近有入手了 HPE Gen10, 也想搞一个黑群晖; 不过迫于对虚拟化有一定要求, 所以最终选定使用 ESXi 做底层, 然后虚拟机安装黑群晖; 安装过程参考了很多方案最终选定 ARPL, 这里记录一下安装过程."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mritd.com/img/synology.png"><meta property="article:published_time" content="2023-03-21T06:20:00.000Z"><meta property="article:modified_time" content="2023-03-21T06:20:00.000Z"><meta property="article:author" content="Kovacs"><meta property="article:tag" content="Synology"><meta property="article:tag" content="ESXi"><meta property="article:tag" content="ARPL"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://mritd.com/img/synology.png"><meta name="twitter:creator" content="@kovacs_orz"><meta name="twitter:site" content="https://twitter.com/kovacs_orz"><title>ESXi ARPL 安装黑群晖 - Kovacs</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"mritd.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!0,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:"G-H06NPECR0Z"},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-H06NPECR0Z",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-H06NPECR0Z")}))</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Kovacs" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="Kovacs" type="application/rss+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Kovacs</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/friends/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="ESXi ARPL 安装黑群晖"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Kovacs </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-03-21 14:20" pubdate>2023年3月21日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.5k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 30 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">ESXi ARPL 安装黑群晖</h1><div class="markdown-body"><h2 id="一、ARPL-介绍"><a href="#一、ARPL-介绍" class="headerlink" title="一、ARPL 介绍"></a>一、ARPL 介绍</h2><p>ARPL 全称 <code>Automated Redpill Loader</code>, 从名字可以看出其基于 Redpill 项目; 使用 ARPL 的优势在于:</p><ul><li>直接提供 ESXi 引导盘</li><li>基本全自动完成修复</li><li>提供友好地交互 UI</li><li>支持常用插件集成</li><li>基本一致保持在最新版本</li></ul><h2 id="二、初始化虚拟机"><a href="#二、初始化虚拟机" class="headerlink" title="二、初始化虚拟机"></a>二、初始化虚拟机</h2><h3 id="2-1、下载-ARPL"><a href="#2-1、下载-ARPL" class="headerlink" title="2.1、下载 ARPL"></a>2.1、下载 ARPL</h3><p>由于 ARPL 直接提供 ESXi 的磁盘镜像, 所以我们直接从 <a target="_blank" rel="noopener" href="https://github.com/fbelavenuto/arpl/releases">Release</a> 页面下载最新的磁盘镜像即可:</p><p><img src="https://cdn.oss.link/markdown/UOxxvV.png" srcset="/img/loading.gif" lazyload></p><h3 id="2-2、创建虚拟机"><a href="#2-2、创建虚拟机" class="headerlink" title="2.2、创建虚拟机"></a>2.2、创建虚拟机</h3><p>因为黑群晖需要安装在虚拟机中, 所以我们就需要先创建一下用于运行黑群晖的虚拟机, 不过在创建时有些选项需要调整:</p><ul><li>1、虚拟机名称随意, 客户机操作系统选择 Linux, <strong>内核选择 “其他 4.x Linux(64 位)”</strong></li><li>2、内存需要至少 4G, 且最好选择锁定内存(勾选预留所有客户机内存), 如后续采用 PCIE 直通则此步骤是必须的</li><li>3、不要额外创建其他硬盘, 默认创建的 <strong>“硬盘1” 磁盘控制器切换到 SATA 0:0</strong></li><li>4、删除默认的 SCSI 控制器还有 CD&#x2F;DVD 驱动器</li><li>5、<strong>引导选项必须设置为 BIOS 引导</strong></li><li>6、如果有购买的洗白码的话, 最好再添加一个网卡(新增网络适配器)</li></ul><p>具体请看下面的截图:</p><p><img src="https://cdn.oss.link/markdown/eRYhqP.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/PPVDj3.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/Uv81vJ.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/uj7rVp.png" srcset="/img/loading.gif" lazyload></p><h3 id="2-3、上传磁盘"><a href="#2-3、上传磁盘" class="headerlink" title="2.3、上传磁盘"></a>2.3、上传磁盘</h3><p>创建好虚拟机后, 需要使用下载的 ARPL 磁盘替换默认的启动磁盘, 在替换之前需要将我们下载的磁盘上传到 ESXi 虚拟机目录(先自行解压 ARPL zip 文件):</p><ul><li>1、首先在存储选项中找到虚拟机目录</li><li>2、在虚拟机目录中点击上载</li><li>3、上传两个 arpl 磁盘文件, <strong>上传成功后将只显示一个</strong></li></ul><p><img src="https://cdn.oss.link/markdown/Ewb5Me.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/zSWqxd.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/UiLiNG.png" srcset="/img/loading.gif" lazyload></p><h3 id="2-4、调整启动盘"><a href="#2-4、调整启动盘" class="headerlink" title="2.4、调整启动盘"></a>2.4、调整启动盘</h3><p>我们需要使用 ARPL 的磁盘作为引导盘, 所以需要将默认的 “硬盘1” 替换为上传的 ARPL 磁盘; 这个替换操作一般两种方式:</p><ul><li>UI 添加: 直接在 UI 界面编辑虚拟机, 删除掉 “硬盘1”, 然后使用 “添加现有硬盘功能” 选择上传的 ARPL 硬盘</li><li>命令该配置: 先取消注册虚拟机, 然后 SSH 到 ESXi 宿主机通过直接编辑 <code>vmx</code> 文件更改 “硬盘1” 配置</li></ul><p>说下两者优缺点, 无疑第一种方式是最简单且好用的, 但是测试在 ESXi7+ 版本似乎没法识别 ARPL 的硬盘, 保存时会报错(测试是 UI BUG, 自己创建的硬盘重新导入也不行); 而第二种方式经过测试直接修改是完全没问题, 且在 ESXi8 上也没问题(第一种 ESXi8 一样不能用).</p><p><img src="https://cdn.oss.link/markdown/a5a7cF.png" srcset="/img/loading.gif" lazyload></p><p>所以这里采用更通用的第二种方式, 直接修改 vmx 文件:</p><ul><li>1、首选在虚拟机列表中找到虚拟机, 右键 “取消注册”</li><li>2、ESXi 主机管理中启动 SSH 服务</li><li>3、通过 SSH 连接到 ESXi 主机, 进入到虚拟机目录</li><li>4、使用 <code>vi</code> 命令编辑 <code>[虚拟机名称].vmx</code> 文件</li><li>5、替换 <code>sata0:0.fileName = &quot;XPEnology.vmdk&quot;</code> 为 <code>sata0:0.fileName = &quot;arpl.vmdk&quot;</code> 并保存</li><li>6、重新注册虚拟机, 选择刚刚修改过的 <code>vmx</code> 文件</li></ul><p><img src="https://cdn.oss.link/markdown/ZzpGlE.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/RjIku8.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/g943Y1.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/eBUToc.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/nocDXT.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/RXUpUa.png" srcset="/img/loading.gif" lazyload></p><h3 id="2-5、调整必要参数"><a href="#2-5、调整必要参数" class="headerlink" title="2.5、调整必要参数"></a>2.5、调整必要参数</h3><p>经过上面的调整以后, 就可以直接启动黑群晖虚拟机并进行调整了; 虚拟机启动后会直接进入控制台, 并打印 VNC 访问地址, 我们需要使用 VNC 调整参数来安装黑群晖:</p><p><img src="https://cdn.oss.link/markdown/XmZdFG.png" srcset="/img/loading.gif" lazyload></p><p>访问该地之后会看到一个菜单列表, 根据需要一步一步填写信息即可:</p><ul><li>1、Choose a model: 选择一个型号, 请根据需要自行填写</li><li>2、Choose a Build Number: 选择 build 版本, 一般直接最新的即可(选择型号后才会出现)</li><li>3、Choose a serial number: 选择序列号, 默认自动生成的, 无法登陆群晖账号等; 可以选择填写自己淘宝买的</li><li>4、Addons: 添加插件驱动等, <strong>如果没有必要请不要添加, 除非你知道你在干什么</strong></li><li>5、Cmdline menu: 启动参数, 核心配置, 可以在此调整网卡数量和添加自己的 mac 地址</li><li>6、Build the loader: 编译引导, 这一步会自动化下载文件并编译引导</li></ul><p>下面是一系列的操作截图和说明, <strong>推荐完全看完后再操作, 关于特殊的网卡和磁盘参数下一部分会有详细说明</strong>:</p><p><img src="https://cdn.oss.link/markdown/8xIb9W.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/CA9ehO.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/wvZJnX.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/PB9BCB.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/VhVOQL.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/AmWZOi.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/PlCcnx.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/hO6uCt.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/URWiXY.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/fn9V82.png" srcset="/img/loading.gif" lazyload></p><h3 id="2-6、必要参数说明"><a href="#2-6、必要参数说明" class="headerlink" title="2.6、必要参数说明"></a>2.6、必要参数说明</h3><p>在调整参数时首次使用的用户可能比较懵逼, 下面详细说一下一些要点:</p><ul><li>1、菜单列表中只要选择了 “Yes” 或者 “Ok” 只要不重启就已经保存了, 保存完成后的 “Exit” 和 “Cancel” 都可以回退到上一层菜单, 不用担心没保存上.</li><li>2、像 “Cmdline menu” 之类的参数菜单一般都提供一个预览选项, 可以完整的看到自己设置的参数</li></ul><p><img src="https://cdn.oss.link/markdown/HyqKww.png" srcset="/img/loading.gif" lazyload></p><h4 id="2-6-1、网卡参数配置"><a href="#2-6-1、网卡参数配置" class="headerlink" title="2.6.1、网卡参数配置"></a>2.6.1、网卡参数配置</h4><p><code>netif_num</code> 这个参数用于告诉群晖系统现在系统有几个网卡, 一般自己生成或者购买的洗白码都会给你两个 mac 地址; 所以通常 <code>netif_num</code> 会设置成 <code>2</code>, 当然如果你直接使用 arpl 随机生成的大概率不能登录群晖账号, 所以默认一个能联网就行.</p><p><code>mac[N]</code> 这个参数用于定义具体网卡的 mac 地址, 众所周知群晖账户登录校验是要判断网卡 mac 的; 所以一般买来的洗白码出了序列号意外也会给两个 mac 地址, 依次填写 <code>mac1</code>、<code>mac2</code> 就行; 同时推荐也在 ESXi 里把这两个 “网络适配器” 手动设置成跟群晖里一样的 mac 地址, 避免 ESXi 某些安全机制导致你没法联网:</p><p><img src="https://cdn.oss.link/markdown/tGGEy8.png" srcset="/img/loading.gif" lazyload></p><h4 id="2-6-2、SataPortMap-和-DiskIdxMap"><a href="#2-6-2、SataPortMap-和-DiskIdxMap" class="headerlink" title="2.6.2、SataPortMap 和 DiskIdxMap"></a>2.6.2、SataPortMap 和 DiskIdxMap</h4><p><code>SataPortMap</code> 用于定义我们有几个 Sata 驱动器, 如果按照我的教程来走基本上是两个驱动器:</p><ul><li><code>Sata0</code>: 专门挂载 arpl 启动盘</li><li><code>Sata1</code>: 专门挂载用自己的磁盘, 主要用于 RDM 模式</li></ul><p>如果不使用 RDM 而是直通 Sata Controller, 那么理论上这个 Sata 控制器等同于 <code>Sata1</code>(都是第二个). 明白了这一点就好理解为什么 <code>SataPortMap</code> 教程里被设置为 <code>14</code> 了: 因为第一个 <code>Sata0</code> 肯定只有 arpl 启动盘, 所以是 <code>1</code>, 第二个需要根据用户实际情况自己写自己有几个盘; 我这里是 4 个 RDM, 所以自然写 <code>4</code>.</p><p><code>DiskIdxMap</code> 用于定义群晖里硬盘识别的计数, 有个小技巧就是如果你把某个 SATA 控制器上的磁盘计数设置成 <code>0F</code> 就会隐藏这个驱动器上的所有磁盘; 文章里 <code>0F00</code> 的意思就是告诉群晖: 挂 arpl 启动盘的这个 “Stata0” 控制器上所有磁盘给我隐藏掉, 所有硬盘序号从第二个控制器开始数”.</p><h3 id="2-7、添加物理硬盘"><a href="#2-7、添加物理硬盘" class="headerlink" title="2.7、添加物理硬盘"></a>2.7、添加物理硬盘</h3><blockquote><p>我在这一步翻车遇到了点问题, 当时以为是 ESXi 版本问题, 所以从 7.0 切换到 8.0; 后续截图会看到是 8.0 的截图, 所以不用怀疑, 我不是在胡编滥造… 当然升级 ESXi 8.0 以后得到了一个好消息和一个坏消息, 好消息是确实是版本问题, 坏消息是 8.0 也特么没修复(郭德纲经典相声了属于是)…</p></blockquote><p><del>这部分本来不太想写, 网上随便一搜就有</del>(翻车了…); 简单的说 ESXi 把物理硬盘直通到虚拟机里就两种方式, 一种是编辑 <code>/etc/vmware/passthru.map</code> 直接把 SATA 控制器直通进去, 另一种就是采用 RDM 方式创建 RDM 磁盘链接来直通; 两种方式孰优孰劣这里不做讨论; 唯一要说明的是如果采用 RDM 记得把 RDM 盘挂载到 <code>Sata1</code> 上, 因为上面的 <code>SataPortMap</code> 和 <code>DiskIdxMap</code> 都是按照两个 SATA 控制器设计的.</p><p>下面是我添加 RDM 的一些步骤和截图, 仅供参考:</p><hr><p><strong>首先命令行创建 RDM 磁盘, 核心命令就是 <code>vmkfstools -z &quot;物理磁盘路径&quot; &quot;RDM 磁盘路径&quot;</code>:</strong></p><p><img src="https://cdn.oss.link/markdown/iOtGOE.png" srcset="/img/loading.gif" lazyload></p><hr><p>接下来就是把 RDM 磁盘添加到虚拟机里; 说起来我写文章的时候觉得我以前操作很简单… 没想到这里翻车了; 简单说下问题, 估计大部分人跟我都一样, <strong>RDM 创建好以后发现添加现有硬盘添加不上, 表现跟上面说 UI 添加 ARPL 磁盘一样, 都是容量不显示也没法保存</strong>; 经过查论坛文章发现这是从 “ESXi 7.0 Update 3i” 版本开始导致的 UI BUG, 目前解决方案只有通过 PowerCLI 命令行方式解决:</p><ul><li>1、准备一台 Windows 11 的虚拟机, 以管理员权限运行 PowerCLI(Terminal)</li><li>2、执行 <code>Install-Module VMware.PowerCLI</code> 安装 VMWare 的命令行工具, 过程中出现的提示全部选 “(Y) 是”</li><li>3、执行 <code>Set-ExecutionPolicy Unrestricted</code> 设置执行策略不受限制</li><li>4、执行 <code>Set-PowerCLIConfiguration -Scope User -InvalidCertificateAction warn</code> 设置忽略 TLS 证书不信任问题(一般 ESXi 默认自签名证书)</li><li>5、退出终端重新打开, 同样要以管理员身份运行</li><li>6、执行 <code>Connect-VIServer -Server 服务器IP地址 -SaveCredentials -Protocol https -User root -Password 密码</code> 完成登陆</li><li>7、执行 <code>$vm = Get-VM -Name &quot;你的虚拟机名称&quot;</code> 设置 <code>$vm</code> 这个变量</li><li>6、执行 <code>New-HardDisk -VM $vm -diskPath 磁盘位置 -Confirm:$false</code> 来添加 RDM 磁盘</li></ul><p>其中第 6 步的 “磁盘存储位置” 可以从 “数据存储浏览器” 中复制, <strong>注意要连前面的存储名称一起复制, 比如我的第一块盘就是 “[ssd] XPEnology&#x2F;RDM-S4Y0TMG0.vmdk”; 实操请看截图:</strong></p><p><img src="https://cdn.oss.link/markdown/6xiZKi.png" srcset="/img/loading.gif" lazyload></p><p><strong>最后一步, 去 UI 界面编辑虚拟机, 把后添加的这几个 RDM 磁盘的控制器全部切换到 <code>Sata1</code> 上, 然后把命令行添加 RDM 时自动创建的 <code>SCSI</code> 控制器删了.</strong></p><hr><p>本部分参考:</p><ul><li><a target="_blank" rel="noopener" href="https://communities.vmware.com/t5/ESXi-Discussions/ESXi-8-RDM-not-working/td-p/2942004">ESXi 8 RDM not working</a></li><li><a target="_blank" rel="noopener" href="https://www.techrepublic.com/article/how-to-manage-esxi-hosts-remotely-with-powercli/">How to manage ESXi hosts remotely with PowerCLI</a></li><li><a target="_blank" rel="noopener" href="https://williamlam.com/2022/12/heads-up-esxi-8-0-host-client-unable-to-attach-existing-virtual-disk-to-vm.html">Heads Up - ESXi 8.0 Host Client unable to attach existing virtual disk to VM</a></li><li><a target="_blank" rel="noopener" href="https://developer.vmware.com/docs/powercli/latest/vmware.vimautomation.core/commands/new-harddisk/#CreateNew">VMware Developer Documentation</a></li></ul><h2 id="三、安装黑群晖"><a href="#三、安装黑群晖" class="headerlink" title="三、安装黑群晖"></a>三、安装黑群晖</h2><p>总结一下上面 ARPL 虚拟机初始化的核心步骤:</p><ul><li>1、创建一个 BIOS 引导的虚拟机</li><li>2、设置两个 SATA 控制器</li><li>3、ARPL 挂载到第一个 SATA</li><li>4、其他磁盘挂载到第二个 SATA</li><li>5、配置 ARPL 参数</li></ul><p>在完整这些步骤后只需要简单的重启虚拟机, 等待启动完成就可以着手安装群晖系统了; <strong>安装群晖系统不需要借助群晖的 Find 查找工具, 虚拟机启动后会在控制台打印 IP, 直接访问 <code>http://IP:5000</code> 端口即可.</strong></p><p><img src="https://cdn.oss.link/markdown/KFd4yO.png" srcset="/img/loading.gif" lazyload></p><p><strong>安装时可以直接从提示处在线下载系统, 不过需要注意的是如果 ARPL 的编译版本号与最新的不匹配可能会有问题, 所以还是推荐点一下 “All Downloads” 然后自行查找.</strong></p><p><img src="https://cdn.oss.link/markdown/9CHpZg.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/C3GHlF.png" srcset="/img/loading.gif" lazyload></p><p><img src="https://cdn.oss.link/markdown/V98A6j.png" srcset="/img/loading.gif" lazyload></p><p>剩下的安装步骤这里就不截图了, 基本上有手就行.</p><h2 id="四、关机修复"><a href="#四、关机修复" class="headerlink" title="四、关机修复"></a>四、关机修复</h2><p>ESXi 默认情况下想要安全关闭一个虚拟机, 需要虚拟机内安装 VMWare 的 <code>open-vm-tools</code> 工具; 该工具作为一个 Agent 运行, 并上报系统的 IP、网速、磁盘、内存使用情况等信息给 ESXi; 当 ESXi 发出关机等指令时该工具根据系统类型自动调用系统命令来完成该操作. <strong>当我们在 ESXi 上安装黑群晖后, ESXi 无法识别系统类型, 所以在管理界面只会显示一个 “关闭电源” 的按钮, 这个关机等同于物理机直接拔电源, 非常容易造成数据损坏.</strong></p><p><img src="https://cdn.oss.link/markdown/Lktuit.png" srcset="/img/loading.gif" lazyload></p><p>解决办法只有一个就是安装 <code>open-vm-tools</code>, 问题在于黑群晖系统不在 VMWare 官方的支持列表中, 所以并未提供安装包; 不过目前也有两种解决方案, 一种是采用 docker 运行 <code>open-vm-tool</code>, 另一种是自己编译 <code>open-vm-tools</code>; 两种方案各有优缺点:</p><ul><li>docker 安装: 缺点是 ESXi 界面显示操作系统选择错误, 因为 <code>open-vm-tools</code> 上报的操作系统是 docker 容器的系统; 好处就是 “永久兼容” 没有群晖版本依赖问题.</li><li>自编译 <code>open-vm-tools</code>: 缺点是绑定群晖系统版本, 需要等待社区大神改代码才能跟上群晖的发版; 好处就是原生运行不需要群晖内有额外的系统资源占用.</li></ul><h3 id="4-1、Docker-安装-open-vm-tools"><a href="#4-1、Docker-安装-open-vm-tools" class="headerlink" title="4.1、Docker 安装 open-vm-tools"></a>4.1、Docker 安装 open-vm-tools</h3><p>这个是最简单的, 需要先在系统内安装 Docker 套件, 然后 SSH 到群晖系统, 执行以下命令运行容器(需要使用 root 用户):</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 生成 ssh key, 一顿回车就行, 其实目的是创建 .ssh 目录</span><br>ssh-keygen<br><br><span class="hljs-comment"># 直接运行这个容器即可</span><br>docker run -dt --name open-vm-tools -v /root/.ssh:/root/.ssh --privileged --pid host --ipc host --uts host --network host --restart always mritd/open-vm-tools<br></code></pre></td></tr></table></figure><p><strong>关于 <code>mritd/open-vm-tools</code> 这个镜像是我自己编译的, 担心安全问题的可以自行查看源码 <a target="_blank" rel="noopener" href="https://github.com/mritd/autobuild/tree/main/open-vm-tools">AutoBuild</a>; 原理其实就是点关机时帮你自动从 Docker 容器 ssh 到群晖系统然后执行关机命令.</strong></p><h3 id="4-2、自编译安装-open-vm-tools"><a href="#4-2、自编译安装-open-vm-tools" class="headerlink" title="4.2、自编译安装 open-vm-tools"></a>4.2、自编译安装 open-vm-tools</h3><p>期望自行编译 <code>open-vm-tools</code> 可以参考 <a target="_blank" rel="noopener" href="https://github.com/tbc0309/synology-dsm-open-vm-tools">synology-dsm-open-vm-tools</a> 仓库文档, <strong>编译时请保证网络环境畅通, 有条件的最好用国外 VPS 8C 16G 配置进行编译.</strong> 编译完成后会生成 SPK 安装包, 直接在套件中心选择手动安装即可:</p><p><img src="https://cdn.oss.link/markdown/yum3pE.png" srcset="/img/loading.gif" lazyload></p><p>安装成功后, 回到 ESXi 中就可以看到虚拟机电源控制中出现了 “关机” 选项:</p><p><img src="https://cdn.oss.link/markdown/bwAfs3.png" srcset="/img/loading.gif" lazyload></p><p>目前我已经编译好了适用于 <code>7.1.1</code> 系统的 <code>open-vm-tools</code>, 截止文章编写时间还没想上传到公网, 有需要的可以留言.</p><h2 id="五、开机自启动"><a href="#五、开机自启动" class="headerlink" title="五、开机自启动"></a>五、开机自启动</h2><p>目前我使用的是 HPE Gen8 作为主机, 宿主机的来电自启动 ESXi 都已经配置完成; 如果想要让特殊情况断电以后 ESXi 能够自动启动黑群晖, 只需要在 ESXi 中配置一下即可:</p><p><img src="https://cdn.oss.link/markdown/xjvo5Q.png" srcset="/img/loading.gif" lazyload></p><p>到此 ESXi 上基本的黑群晖已经安装完成, 剩下的系统内折腾就各凭本事了.</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/linux/" class="category-chain-item">Linux</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/synology/" class="print-no-link">#Synology</a> <a href="/tags/esxi/" class="print-no-link">#ESXi</a> <a href="/tags/arpl/" class="print-no-link">#ARPL</a></div></div><div class="license-box my-3"><div class="license-title"><div>ESXi ARPL 安装黑群晖</div><div>https://mritd.com/2023/03/21/install-xpenology-on-esxi-using-arpl/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Kovacs</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年3月21日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/05/23/write-mysql-udf-in-golang/" title="Golang 编写 MySQL UDF"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Golang 编写 MySQL UDF</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/03/18/ups-nut-configuration-tutorial/" title="UPS Nut 配置教程"><span class="hidden-mobile">UPS Nut 配置教程</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://mritd.com/2023/03/21/install-xpenology-on-esxi-using-arpl/",this.page.identifier="/2023/03/21/install-xpenology-on-esxi-using-arpl/"};Fluid.utils.loadComments("#disqus_thread",(function(){var e=document,t=e.createElement("script");t.src="//bleem.disqus.com/embed.js",t.setAttribute("data-timestamp",new Date),(e.head||e.body).appendChild(t)}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-docker"></i> <a href="https://bandwagonhost.com/aff.php?aff=61367" target="_blank" rel="nofollow noopener"><span>BandwagonHost</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!0,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>