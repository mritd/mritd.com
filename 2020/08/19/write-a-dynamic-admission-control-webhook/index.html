<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Kovacs"><meta name="keywords" content="Admission"><meta name="description" content="前段时间弄了一个 imgsync 的工具把 gcr.io 的镜像搬运到了 Docker Hub，但是即使这样我每次还是需要编辑 yaml 配置手动改镜像名称；所以我萌生了一个想法: 能不能自动化这个过程？"><meta property="og:type" content="article"><meta property="og:title" content="编写一个动态准入控制来实现自动化"><meta property="og:url" content="https://mritd.com/2020/08/19/write-a-dynamic-admission-control-webhook/index.html"><meta property="og:site_name" content="Kovacs"><meta property="og:description" content="前段时间弄了一个 imgsync 的工具把 gcr.io 的镜像搬运到了 Docker Hub，但是即使这样我每次还是需要编辑 yaml 配置手动改镜像名称；所以我萌生了一个想法: 能不能自动化这个过程？"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mritd.com/img/kubernetes.jpeg"><meta property="article:published_time" content="2020-08-19T06:35:00.000Z"><meta property="article:modified_time" content="2020-08-19T06:35:00.000Z"><meta property="article:author" content="Kovacs"><meta property="article:tag" content="Admission"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://mritd.com/img/kubernetes.jpeg"><meta name="twitter:creator" content="@kovacs_orz"><meta name="twitter:site" content="https://twitter.com/kovacs_orz"><title>编写一个动态准入控制来实现自动化 - Kovacs</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"mritd.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!0,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:"G-H06NPECR0Z"},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-H06NPECR0Z",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-H06NPECR0Z")}))</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Kovacs" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="Kovacs" type="application/rss+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Kovacs</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/friends/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="编写一个动态准入控制来实现自动化"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Kovacs </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-08-19 14:35" pubdate>2020年8月19日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.4k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 29 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">编写一个动态准入控制来实现自动化</h1><div class="markdown-body"><h2 id="一、准入控制介绍"><a href="#一、准入控制介绍" class="headerlink" title="一、准入控制介绍"></a>一、准入控制介绍</h2><p>在 Kubernetes 整个请求链路中，请求通过认证和授权之后、对象被持久化之前需要通过一连串的 “准入控制拦截器”；这些准入控制器负载验证请求的合法性，必要情况下也可以对请求进行修改；默认准入控制器编写在 kube-apiserver 的代码中，针对于当前 kube-apiserver 默认启用的准入控制器你可以通过以下命令查看:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kube-apiserver -h | grep enable-admission-plugins<br></code></pre></td></tr></table></figure><p>具体每个准入控制器的作用可以通过 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/">Using Admission Controllers</a> 文档查看。在这些准入控制器中有两个特殊的准入控制器 <code>MutatingAdmissionWebhook</code> 和 <code>ValidatingAdmissionWebhook</code>。<strong>这两个准入控制器以 WebHook 的方式提供扩展能力，从而我们可以实现自定义的一些功能。当我们在集群中创建相关 WebHook 配置后，我们配置中描述的想要关注的资源在集群中创建、修改等都会触发 WebHook，我们再编写具体的应用来响应 WebHook 即可完成特定功能。</strong></p><h2 id="二、动态准入控制"><a href="#二、动态准入控制" class="headerlink" title="二、动态准入控制"></a>二、动态准入控制</h2><p>动态准入控制实际上指的就是上面所说的两个 WebHook，在使用动态准入控制时需要一些先决条件:</p><ul><li>确保 Kubernetes 集群版本至少为 v1.16 (以便使用 <code>admissionregistration.k8s.io/v1 API</code>)或者 v1.9 (以便使用 <code>admissionregistration.k8s.io/v1beta1</code> API)。</li><li>确保启用 MutatingAdmissionWebhook 和 ValidatingAdmissionWebhook 控制器。</li><li>确保启用 <code>admissionregistration.k8s.io/v1</code> 或 <code>admissionregistration.k8s.io/v1beta1</code> API。</li></ul><p>如果要使用 Mutating Admission Webhook，在满足先决条件后，需要在系统中 create 一个 MutatingWebhookConfiguration:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">admissionregistration.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">MutatingWebhookConfiguration</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;mutating-webhook.mritd.me&quot;</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-addons</span><br><span class="hljs-attr">webhooks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;mutating-webhook.mritd.me&quot;</span><br>    <span class="hljs-attr">rules:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span>   [<span class="hljs-string">&quot;&quot;</span>]<br>        <span class="hljs-attr">apiVersions:</span> [<span class="hljs-string">&quot;v1&quot;</span>]<br>        <span class="hljs-attr">operations:</span>  [<span class="hljs-string">&quot;CREATE&quot;</span>,<span class="hljs-string">&quot;UPDATE&quot;</span>]<br>        <span class="hljs-attr">resources:</span>   [<span class="hljs-string">&quot;pods&quot;</span>]<br>        <span class="hljs-attr">scope:</span>       <span class="hljs-string">&quot;Namespaced&quot;</span><br>    <span class="hljs-attr">clientConfig:</span><br>      <span class="hljs-attr">service:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;mutating-webhook&quot;</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">&quot;kube-addons&quot;</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/print</span><br>      <span class="hljs-attr">caBundle:</span> <span class="hljs-string">$&#123;CA_BUNDLE&#125;</span><br>    <span class="hljs-attr">admissionReviewVersions:</span> [<span class="hljs-string">&quot;v1&quot;</span>, <span class="hljs-string">&quot;v1beta1&quot;</span>]<br>    <span class="hljs-attr">sideEffects:</span> <span class="hljs-string">None</span><br>    <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>    <span class="hljs-attr">failurePolicy:</span> <span class="hljs-string">Ignore</span><br>    <span class="hljs-attr">namespaceSelector:</span><br>      <span class="hljs-attr">matchLabels:</span><br>        <span class="hljs-attr">mutating-webhook.mritd.me:</span> <span class="hljs-string">&quot;true&quot;</span><br></code></pre></td></tr></table></figure><p>同样要使用 Validating Admission Webhook 也需要类似的配置:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">admissionregistration.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ValidatingWebhookConfiguration</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;validating-webhook.mritd.me&quot;</span><br><span class="hljs-attr">webhooks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;validating-webhook.mritd.me&quot;</span><br>    <span class="hljs-attr">rules:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span>   [<span class="hljs-string">&quot;&quot;</span>]<br>        <span class="hljs-attr">apiVersions:</span> [<span class="hljs-string">&quot;v1&quot;</span>]<br>        <span class="hljs-attr">operations:</span>  [<span class="hljs-string">&quot;CREATE&quot;</span>,<span class="hljs-string">&quot;UPDATE&quot;</span>]<br>        <span class="hljs-attr">resources:</span>   [<span class="hljs-string">&quot;pods&quot;</span>]<br>        <span class="hljs-attr">scope:</span>       <span class="hljs-string">&quot;Namespaced&quot;</span><br>    <span class="hljs-attr">clientConfig:</span><br>      <span class="hljs-attr">service:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;validating-webhook&quot;</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">&quot;kube-addons&quot;</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/print</span><br>      <span class="hljs-attr">caBundle:</span> <span class="hljs-string">$&#123;CA_BUNDLE&#125;</span><br>    <span class="hljs-attr">admissionReviewVersions:</span> [<span class="hljs-string">&quot;v1&quot;</span>, <span class="hljs-string">&quot;v1beta1&quot;</span>]<br>    <span class="hljs-attr">sideEffects:</span> <span class="hljs-string">None</span><br>    <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>    <span class="hljs-attr">failurePolicy:</span> <span class="hljs-string">Ignore</span><br>    <span class="hljs-attr">namespaceSelector:</span><br>      <span class="hljs-attr">matchLabels:</span><br>        <span class="hljs-attr">validating-webhook.mritd.me:</span> <span class="hljs-string">&quot;true&quot;</span><br></code></pre></td></tr></table></figure><p>从配置文件中可以看到，<code>webhooks.rules</code> 段落中具体指定了我们想要关注的资源及其行为，<code>webhooks.clientConfig</code> 中指定了 webhook 触发后将其发送到那个地址以及证书配置等，这些具体字段的含义可以通过官方文档 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers/">Dynamic Admission Control</a> 来查看。</p><p><strong>值得注意的是 Mutating Admission Webhook 会在 Validating Admission Webhook 之前触发；Mutating Admission Webhook 可以修改用户的请求，比如自动调整镜像名称、增加注解等，而 Validating Admission Webhook 只能做校验(true or false)，不可以进行修改操作。</strong></p><h2 id="三、编写一个-WebHook"><a href="#三、编写一个-WebHook" class="headerlink" title="三、编写一个 WebHook"></a>三、编写一个 WebHook</h2><blockquote><p><strong>郑重提示: 本部分文章请结合 <a target="_blank" rel="noopener" href="https://github.com/mritd/goadmission">goadmission</a> 框架源码进行阅读。</strong></p></blockquote><h3 id="3-1、大体思路"><a href="#3-1、大体思路" class="headerlink" title="3.1、大体思路"></a>3.1、大体思路</h3><p>在编写之前一般我们先大体了解一下流程并制订方案再去实现，边写边思考适合在细节实现上，对于整体的把控需要提前作好预习。针对于这个准入控制的 WebHook 来说，根据其官方文档大致总结重点如下:</p><ul><li>WebHook 接收者就是一个标准的 HTTP Server，请求方式是 POST + JSON</li><li>请求响应都是一个 AdmissionReview 对象</li><li>响应时需要请求时的 UID(<code>request.uid</code>)</li><li>响应时 Mutating Admission Webhook 可以包含对请求的修改信息，格式为 JSONPatch</li></ul><p>有了以上信息以后便可以知道编写 WebHook 需要的东西，根据这些信息目前我作出的大体方案如下:</p><ul><li>最起码我们要有个 HTTP Server，考虑到后续可能会同时处理多种 WebHook，所以需要一个带有路径匹配的 HTTP 框架，Gin 什么的虽然不错但是太重，最终选择简单轻量的 <code>gorilla/mux</code>。</li><li>应该做好适当的抽象，因为对于响应需要包含的 UID 等限制在每个请求都有可以提取出来自动化完成。</li><li>针对于 Mutating Admission Webhook 响应的 JSONPatch 可以弄个结构体然后直接反序列化。</li></ul><h3 id="3-2、AdmissionReview-对象"><a href="#3-2、AdmissionReview-对象" class="headerlink" title="3.2、AdmissionReview 对象"></a>3.2、AdmissionReview 对象</h3><p>基于 3.1 部分的分析可以知道，WebHook 接收和响应都是一个 AdmissionReview 对象，在查看源码以后可以看到 AdmissionReview 结构如下:</p><p><img src="https://cdn.oss.link/markdown/jro62.png" srcset="/img/loading.gif" lazyload alt="AdmissionReview"></p><p>从代码的命名中可以很清晰的看出，在请求发送到 WebHook 时我们只需要关注内部的 AdmissionRequest(实际入参)，在我们编写的 WebHook 处理完成后只需要返回包含有 AdmissionResponse(实际返回体) 的 AdmissionReview 对象即可；总的来说 <strong>AdmissionReview 对象是个套壳，请求是里面的 AdmissionRequest，响应是里面的 AdmissionResponse</strong>。</p><h3 id="3-3、Hello-World"><a href="#3-3、Hello-World" class="headerlink" title="3.3、Hello World"></a>3.3、Hello World</h3><p>有了上面的一些基础知识，我们就可以简单的实行一个什么也不干的 WebHook 方法(本地无法直接运行，重点在于思路):</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// printRequest 接收 AdmissionRequest 对象并将其打印到到控制台，接着不做任何处理直接返回一个 AdmissionResponse 对象</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printRequest</span><span class="hljs-params">(request *admissionv1.AdmissionRequest)</span></span> (*admissionv1.AdmissionResponse, <span class="hljs-type">error</span>) &#123;<br>	bs, err := jsoniter.MarshalIndent(request, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;    &quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	logger.Infof(<span class="hljs-string">&quot;print request: %s&quot;</span>, <span class="hljs-type">string</span>(bs))<br><br>	<span class="hljs-keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;<br>		Allowed: <span class="hljs-literal">true</span>,<br>		Result: &amp;metav1.Status&#123;<br>			Code:    http.StatusOK,<br>			Message: <span class="hljs-string">&quot;Hello World&quot;</span>,<br>		&#125;,<br>	&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>上面这个 <code>printRequest</code> 方法最细粒度的控制到只面向我们的实际请求和响应；而对于 WebHook Server 来说其接到的是 http 请求，<strong>所以我们还需要在外面包装一下，将 http 请求转换为 AdmissionReview 并提取 AdmissionRequest 再调用上面的 <code>printRequest</code> 来处理，最后将返回结果重新包装为 AdmissionReview 重新返回；整体的代码如下</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 通用的错误返回方法</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">responseErr</span><span class="hljs-params">(handlePath, msg <span class="hljs-type">string</span>, httpCode <span class="hljs-type">int</span>, w http.ResponseWriter)</span></span> &#123;<br>	logger.Errorf(<span class="hljs-string">&quot;handle func [%s] response err: %s&quot;</span>, handlePath, msg)<br>	review := &amp;admissionv1.AdmissionReview&#123;<br>		Response: &amp;admissionv1.AdmissionResponse&#123;<br>			Allowed: <span class="hljs-literal">false</span>,<br>			Result: &amp;metav1.Status&#123;<br>				Message: msg,<br>			&#125;,<br>		&#125;,<br>	&#125;<br>	bs, err := jsoniter.Marshal(review)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		logger.Errorf(<span class="hljs-string">&quot;failed to marshal response: %v&quot;</span>, err)<br>		w.WriteHeader(http.StatusInternalServerError)<br>		_, _ = w.Write([]<span class="hljs-type">byte</span>(fmt.Sprintf(<span class="hljs-string">&quot;failed to marshal response: %s&quot;</span>, err)))<br>	&#125;<br><br>	w.WriteHeader(httpCode)<br>	_, err = w.Write(bs)<br>	logger.Debugf(<span class="hljs-string">&quot;write err response: %d: %v: %v&quot;</span>, httpCode, review, err)<br>&#125;<br><br><span class="hljs-comment">// printRequest 接收 AdmissionRequest 对象并将其打印到到控制台，接着不做任何处理直接返回一个 AdmissionResponse 对象</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printRequest</span><span class="hljs-params">(request *admissionv1.AdmissionRequest)</span></span> (*admissionv1.AdmissionResponse, <span class="hljs-type">error</span>) &#123;<br>	bs, err := jsoniter.MarshalIndent(request, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;    &quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	logger.Infof(<span class="hljs-string">&quot;print request: %s&quot;</span>, <span class="hljs-type">string</span>(bs))<br><br>	<span class="hljs-keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;<br>		Allowed: <span class="hljs-literal">true</span>,<br>		Result: &amp;metav1.Status&#123;<br>			Code:    http.StatusOK,<br>			Message: <span class="hljs-string">&quot;Hello World&quot;</span>,<br>		&#125;,<br>	&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// http server 的处理方法</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">headler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>			<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; _ = r.Body.Close() &#125;()<br>			w.Header().Set(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>)<br><br>			<span class="hljs-comment">// 读取 body，出错直接返回</span><br>			reqBs, err := ioutil.ReadAll(r.Body)<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				responseErr(handlePath, err.Error(), http.StatusInternalServerError, w)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>			<span class="hljs-keyword">if</span> reqBs == <span class="hljs-literal">nil</span> || <span class="hljs-built_in">len</span>(reqBs) == <span class="hljs-number">0</span> &#123;<br>				responseErr(handlePath, <span class="hljs-string">&quot;request body is empty&quot;</span>, http.StatusBadRequest, w)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>			logger.Debugf(<span class="hljs-string">&quot;request body: %s&quot;</span>, <span class="hljs-type">string</span>(reqBs))<br><br>			<span class="hljs-comment">// 将 body 反序列化为 AdmissionReview</span><br>			reqReview := admissionv1.AdmissionReview&#123;&#125;<br>			<span class="hljs-keyword">if</span> _, _, err := deserializer.Decode(reqBs, <span class="hljs-literal">nil</span>, &amp;reqReview); err != <span class="hljs-literal">nil</span> &#123;<br>				responseErr(handlePath, fmt.Sprintf(<span class="hljs-string">&quot;failed to decode req: %s&quot;</span>, err), http.StatusInternalServerError, w)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>			<span class="hljs-keyword">if</span> reqReview.Request == <span class="hljs-literal">nil</span> &#123;<br>				responseErr(handlePath, <span class="hljs-string">&quot;admission review request is empty&quot;</span>, http.StatusBadRequest, w)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br><br>			<span class="hljs-comment">// 提取 AdmissionRequest 并调用 printRequest 处理</span><br>			resp, err := printRequest(reqReview.Request)<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				responseErr(handlePath, fmt.Sprintf(<span class="hljs-string">&quot;admission func response: %s&quot;</span>, err), http.StatusForbidden, w)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>			<span class="hljs-keyword">if</span> resp == <span class="hljs-literal">nil</span> &#123;<br>				responseErr(handlePath, <span class="hljs-string">&quot;admission func response is empty&quot;</span>, http.StatusInternalServerError, w)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>			<br>			<span class="hljs-comment">// 复制 AdmissionRequest 中的 UID 到 AdmissionResponse 中(必须进行，否则会导致响应无效)</span><br>			resp.UID = reqReview.Request.UID<br>			<span class="hljs-comment">// 复制 reqReview.TypeMeta 到新的响应 AdmissionReview 中</span><br>			respReview := admissionv1.AdmissionReview&#123;<br>				TypeMeta: reqReview.TypeMeta,<br>				Response: resp,<br>			&#125;<br>			<br>			<span class="hljs-comment">// 重新序列化响应并返回</span><br>			respBs, err := jsoniter.Marshal(respReview)<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				responseErr(handlePath, fmt.Sprintf(<span class="hljs-string">&quot;failed to marshal response: %s&quot;</span>, err), http.StatusInternalServerError, w)<br>				logger.Errorf(<span class="hljs-string">&quot;the expected response is: %v&quot;</span>, respReview)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>			w.WriteHeader(http.StatusOK)<br>			_, err = w.Write(respBs)<br>			logger.Debugf(<span class="hljs-string">&quot;write response: %d: %s: %v&quot;</span>, http.StatusOK, <span class="hljs-type">string</span>(respBs), err)<br>		&#125;<br></code></pre></td></tr></table></figure><h3 id="3-4、抽象出框架"><a href="#3-4、抽象出框架" class="headerlink" title="3.4、抽象出框架"></a>3.4、抽象出框架</h3><p>编写了简单的 Hello World 以后可以看出，真正在编写时我们需要实现的都是处理 AdmissionRequest 并返回 AdmissionResponse 这部份(printRequest)；外部的包装为 AdmissionReview、复制 UID、复制 TypeMeta 等都是通用的方法，所以基于这一点我们可以进行适当的抽象:</p><h4 id="3-4-1、AdmissionFunc"><a href="#3-4-1、AdmissionFunc" class="headerlink" title="3.4.1、AdmissionFunc"></a>3.4.1、AdmissionFunc</h4><p>针对每一个贴合业务的 WebHook 来说，其大致有三大属性:</p><ul><li>WebHook 的类型(Mutating&#x2F;Validating)</li><li>WebHook 拦截的 URL 路径(&#x2F;print_request)</li><li>WebHook 核心的处理逻辑(处理 Request 和返回 Response)</li></ul><p>我们将其抽象为 AdmissionFunc 结构体以后如下所示</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// WebHook 类型</span><br><span class="hljs-keyword">const</span> (<br>	Mutating   AdmissionFuncType = <span class="hljs-string">&quot;Mutating&quot;</span><br>	Validating AdmissionFuncType = <span class="hljs-string">&quot;Validating&quot;</span><br>)<br><br><span class="hljs-comment">// 每一个对应到我们业务的 WebHook 抽象的 struct</span><br><span class="hljs-keyword">type</span> AdmissionFunc <span class="hljs-keyword">struct</span> &#123;<br>	Type AdmissionFuncType<br>	Path <span class="hljs-type">string</span><br>	Func <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(request *admissionv1.AdmissionRequest)</span></span> (*admissionv1.AdmissionResponse, <span class="hljs-type">error</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-4-2、HandleFunc"><a href="#3-4-2、HandleFunc" class="headerlink" title="3.4.2、HandleFunc"></a>3.4.2、HandleFunc</h4><p>我们知道 WebHook 是基于 HTTP 的，所以上面抽象出的 AdmissionFunc 还不能直接用在 HTTP 请求代码中；如果直接偶合到 HTTP 请求代码中，我们就没法为 HTTP 代码再增加其他拦截路径等等特殊的底层设置；<strong>所以站在 HTTP 层面来说还需要抽象一个 “更高层面的且包含 AdmissionFunc 全部能力的 HandleFunc” 来使用；HandleFunc 抽象 HTTP 层面的需求:</strong></p><ul><li>HTTP 请求方法</li><li>HTTP 请求路径</li><li>HTTP 处理方法</li></ul><p>以下为 HandleFunc 的抽象:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> HandleFunc <span class="hljs-keyword">struct</span> &#123;<br>	Path   <span class="hljs-type">string</span><br>	Method <span class="hljs-type">string</span><br>	Func   <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-5、goadmission-框架"><a href="#3-5、goadmission-框架" class="headerlink" title="3.5、goadmission 框架"></a>3.5、goadmission 框架</h3><p>有了以上两个角度的抽象，再结合 命令行参数解析、日志处理、配置文件读取等等，我揉合出了一个 <a target="_blank" rel="noopener" href="https://github.com/mritd/goadmission">goadmission</a> 框架，以方便动态准入控制的快速开发。</p><h4 id="3-5-1、基本结构"><a href="#3-5-1、基本结构" class="headerlink" title="3.5.1、基本结构"></a>3.5.1、基本结构</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh">.<br>├── main.go<br>└── pkg<br>    ├── adfunc<br>    │   ├── adfuncs.go<br>    │   ├── adfuncs_json.go<br>    │   ├── func_check_deploy_time.go<br>    │   ├── func_disable_service_links.go<br>    │   ├── func_image_rename.go<br>    │   └── func_print_request.go<br>    ├── conf<br>    │   └── conf.go<br>    ├── route<br>    │   ├── route_available.go<br>    │   ├── route_health.go<br>    │   └── router.go<br>    └── zaplogger<br>        ├── config.go<br>        └── logger.go<br><br>5 directories, 13 files<br></code></pre></td></tr></table></figure><ul><li>main.go 为程序运行入口，在此设置命令行 flag 参数等</li><li>pkg&#x2F;conf 为框架配置包，所有的配置读取只读取这个包即可</li><li>pkg&#x2F;zaplogger zap log 库的日志抽象和处理(copy 自 operator-sdk)</li><li>pkg&#x2F;route http 级别的路由抽象(HandleFunc)</li><li>pkg&#x2F;adfunc 动态准入控制 WebHook 级别的抽(AdmissionFunc)</li></ul><h4 id="3-5-2、增加动态准入控制"><a href="#3-5-2、增加动态准入控制" class="headerlink" title="3.5.2、增加动态准入控制"></a>3.5.2、增加动态准入控制</h4><p>由于框架已经作好了路由注册等相关抽象，所以只需要新建 go 文件，然后通过 init 方法注册到全局 WebHook 组中即可，新编写的 WebHook 对已有代码不会有任何侵入:</p><p><img src="https://cdn.oss.link/markdown/lg6zc.png" srcset="/img/loading.gif" lazyload alt="add_adfunc"></p><p><strong>需要注意的是所有 validating 类型的 WebHook 会在 URL 路径前自动拼接 <code>/validating</code> 路径，mutating 类型的 WebHook 会在 URL 路径前自动拼接 <code>/mutating</code> 路径；</strong>这么做是为了避免在更高层级的 HTTP Route 上添加冲突的路由。</p><p><img src="https://cdn.oss.link/markdown/nd5ez.png" srcset="/img/loading.gif" lazyload alt="auto_fix_url"></p><h4 id="3-5-3、实现-image-自动修改"><a href="#3-5-3、实现-image-自动修改" class="headerlink" title="3.5.3、实现 image 自动修改"></a>3.5.3、实现 image 自动修改</h4><p>所以一切准备就绪以后，就需要 “不忘初心”，撸一个自动修改镜像名称的 WebHook:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> adfunc<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>	<span class="hljs-string">&quot;sync&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br><br>	<span class="hljs-string">&quot;github.com/mritd/goadmission/pkg/conf&quot;</span><br><br>	jsoniter <span class="hljs-string">&quot;github.com/json-iterator/go&quot;</span><br><br>	corev1 <span class="hljs-string">&quot;k8s.io/api/core/v1&quot;</span><br>	metav1 <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span><br><br>	<span class="hljs-string">&quot;github.com/mritd/goadmission/pkg/route&quot;</span><br>	admissionv1 <span class="hljs-string">&quot;k8s.io/api/admission/v1&quot;</span><br>)<br><br><span class="hljs-comment">// 只初始化一次 renameMap</span><br><span class="hljs-keyword">var</span> renameOnce sync.Once<br><span class="hljs-comment">// renameMap 保存镜像名称的替换规则，目前粗略实现为纯文本替换</span><br><span class="hljs-keyword">var</span> renameMap <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>	route.Register(route.AdmissionFunc&#123;<br>		Type: route.Mutating,<br>		Path: <span class="hljs-string">&quot;/rename&quot;</span>,<br>		Func: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(request *admissionv1.AdmissionRequest)</span></span> (*admissionv1.AdmissionResponse, <span class="hljs-type">error</span>) &#123;<br>			<span class="hljs-comment">// init rename rules map</span><br>			renameOnce.Do(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>				renameMap = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>, <span class="hljs-number">10</span>)<br>				<span class="hljs-comment">// 将镜像重命名规则初始化到 renameMap 中，方便后续读取</span><br>				<span class="hljs-comment">// rename rule example: k8s.gcr.io/=gcrxio/k8s.gcr.io_</span><br>				<span class="hljs-keyword">for</span> _, s := <span class="hljs-keyword">range</span> conf.ImageRename &#123;<br>					ss := strings.Split(s, <span class="hljs-string">&quot;=&quot;</span>)<br>					<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ss) != <span class="hljs-number">2</span> &#123;<br>						logger.Fatalf(<span class="hljs-string">&quot;failed to parse image name rename rules: %s&quot;</span>, s)<br>					&#125;<br>					renameMap[ss[<span class="hljs-number">0</span>]] = ss[<span class="hljs-number">1</span>]<br>				&#125;<br>			&#125;)<br><br>			<span class="hljs-comment">// 这个准入控制的 WebHook 只针对 Pod 处理，非 Pod 类请求直接返回错误</span><br>			<span class="hljs-keyword">switch</span> request.Kind.Kind &#123;<br>			<span class="hljs-keyword">case</span> <span class="hljs-string">&quot;Pod&quot;</span>:<br>				<span class="hljs-comment">// 从 request 中反序列化出 Pod 实例</span><br>				<span class="hljs-keyword">var</span> pod corev1.Pod<br>				err := jsoniter.Unmarshal(request.Object.Raw, &amp;pod)<br>				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>					errMsg := fmt.Sprintf(<span class="hljs-string">&quot;[route.Mutating] /rename: failed to unmarshal object: %v&quot;</span>, err)<br>					logger.Error(errMsg)<br>					<span class="hljs-keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;<br>						Allowed: <span class="hljs-literal">false</span>,<br>						Result: &amp;metav1.Status&#123;<br>							Code:    http.StatusBadRequest,<br>							Message: errMsg,<br>						&#125;,<br>					&#125;, <span class="hljs-literal">nil</span><br>				&#125;<br><br>				<span class="hljs-comment">// 后来我发现带有下面这个注解的 Pod 是没法更改成功的，这种 Pod 是由 kubelet 直接</span><br>				<span class="hljs-comment">// 启动的 static pod，在 api server 中只能看到它的 &quot;mirror&quot;，不能改的</span><br>				<span class="hljs-comment">// skip static pod</span><br>				<span class="hljs-keyword">for</span> k := <span class="hljs-keyword">range</span> pod.Annotations &#123;<br>					<span class="hljs-keyword">if</span> k == <span class="hljs-string">&quot;kubernetes.io/config.mirror&quot;</span> &#123;<br>						errMsg := fmt.Sprintf(<span class="hljs-string">&quot;[route.Mutating] /rename: pod %s has kubernetes.io/config.mirror annotation, skip image rename&quot;</span>, pod.Name)<br>						logger.Warn(errMsg)<br>						<span class="hljs-keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;<br>							Allowed: <span class="hljs-literal">true</span>,<br>							Result: &amp;metav1.Status&#123;<br>								Code:    http.StatusOK,<br>								Message: errMsg,<br>							&#125;,<br>						&#125;, <span class="hljs-literal">nil</span><br>					&#125;<br>				&#125;<br><br>				<span class="hljs-comment">// 遍历所有 Pod，然后生成 JSONPatch</span><br>				<span class="hljs-comment">// 注意: 返回结果必须是 JSONPatch，k8s api server 再将 JSONPatch 应用到 Pod 上 </span><br>				<br>				<span class="hljs-comment">// 由于有多个 Pod，所以最终会产生一个补丁数组</span><br>				<span class="hljs-keyword">var</span> patches []Patch<br>				<span class="hljs-keyword">for</span> i, c := <span class="hljs-keyword">range</span> pod.Spec.Containers &#123;<br>					<span class="hljs-keyword">for</span> s, t := <span class="hljs-keyword">range</span> renameMap &#123;<br>						<span class="hljs-keyword">if</span> strings.HasPrefix(c.Image, s) &#123;<br>							patches = <span class="hljs-built_in">append</span>(patches, Patch&#123;<br>								<span class="hljs-comment">// 指定 JSONPatch 动作为 replace </span><br>								Option: PatchOptionReplace,<br>								<span class="hljs-comment">// 打补丁的绝对位置</span><br>								Path:   fmt.Sprintf(<span class="hljs-string">&quot;/spec/containers/%d/image&quot;</span>, i),<br>								<span class="hljs-comment">// replace 为处理过的镜像名</span><br>								Value:  strings.Replace(c.Image, s, t, <span class="hljs-number">1</span>),<br>							&#125;)<br><br>							<span class="hljs-comment">// 为了后期调试和留存历史，我们再为修改过的 Pod 加个注解</span><br>							patches = <span class="hljs-built_in">append</span>(patches, Patch&#123;<br>								Option: PatchOptionAdd,<br>								Path:   <span class="hljs-string">&quot;/metadata/annotations&quot;</span>,<br>								Value: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>&#123;<br>									fmt.Sprintf(<span class="hljs-string">&quot;rename-mutatingwebhook-%d.mritd.me&quot;</span>, time.Now().Unix()): fmt.Sprintf(<span class="hljs-string">&quot;%d-%s-%s&quot;</span>, i, strings.ReplaceAll(s, <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;_&quot;</span>), strings.ReplaceAll(t, <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;_&quot;</span>)),<br>								&#125;,<br>							&#125;)<br>							<span class="hljs-keyword">break</span><br>						&#125;<br>					&#125;<br>				&#125;<br><br>				<span class="hljs-comment">// 将所有 JSONPatch 序列化成 json，然后返回即可</span><br>				patch, err := jsoniter.Marshal(patches)<br>				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>					errMsg := fmt.Sprintf(<span class="hljs-string">&quot;[route.Mutating] /rename: failed to marshal patch: %v&quot;</span>, err)<br>					logger.Error(errMsg)<br>					<span class="hljs-keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;<br>						Allowed: <span class="hljs-literal">false</span>,<br>						Result: &amp;metav1.Status&#123;<br>							Code:    http.StatusInternalServerError,<br>							Message: errMsg,<br>						&#125;,<br>					&#125;, <span class="hljs-literal">nil</span><br>				&#125;<br><br>				logger.Infof(<span class="hljs-string">&quot;[route.Mutating] /rename: patches: %s&quot;</span>, <span class="hljs-type">string</span>(patch))<br>				<span class="hljs-keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;<br>					Allowed:   <span class="hljs-literal">true</span>,<br>					Patch:     patch,<br>					PatchType: JSONPatch(),<br>					Result: &amp;metav1.Status&#123;<br>						Code:    http.StatusOK,<br>						Message: <span class="hljs-string">&quot;success&quot;</span>,<br>					&#125;,<br>				&#125;, <span class="hljs-literal">nil</span><br>			<span class="hljs-keyword">default</span>:<br>				errMsg := fmt.Sprintf(<span class="hljs-string">&quot;[route.Mutating] /rename: received wrong kind request: %s, Only support Kind: Pod&quot;</span>, request.Kind.Kind)<br>				logger.Error(errMsg)<br>				<span class="hljs-keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;<br>					Allowed: <span class="hljs-literal">false</span>,<br>					Result: &amp;metav1.Status&#123;<br>						Code:    http.StatusForbidden,<br>						Message: errMsg,<br>					&#125;,<br>				&#125;, <span class="hljs-literal">nil</span><br>			&#125;<br>		&#125;,<br>	&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><ul><li>动态准入控制其实就是个 WebHook，我们弄个 HTTP Server 接收 AdmissionRequest 响应 AdmissionResponse 就行。</li><li>Request、Response 会包装到 AdmissionReview 中，我们还需要做一些边缘处理，比如复制 UID、TypeMeta 等</li><li>MutatingWebHook 想要修改东西时，要返回描述修改操作的 JSONPatch 补丁</li><li>单个 WebHook 很简单，写多个的时候要自己抽好框架，尽量优雅的作好复用和封装</li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/kubernetes/" class="category-chain-item">Kubernetes</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/admission/" class="print-no-link">#Admission</a></div></div><div class="license-box my-3"><div class="license-title"><div>编写一个动态准入控制来实现自动化</div><div>https://mritd.com/2020/08/19/write-a-dynamic-admission-control-webhook/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Kovacs</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2020年8月19日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2020/10/08/switch-jekyll-to-hexo/" title="网站切换到 Hexo"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">网站切换到 Hexo</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2020/08/19/use-etcdadm-to-build-etcd-cluster-in-3-minutes/" title="使用 etcdadm 三分钟搭建 etcd 集群"><span class="hidden-mobile">使用 etcdadm 三分钟搭建 etcd 集群</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://mritd.com/2020/08/19/write-a-dynamic-admission-control-webhook/",this.page.identifier="/2020/08/19/write-a-dynamic-admission-control-webhook/"};Fluid.utils.loadComments("#disqus_thread",(function(){var t=document,e=t.createElement("script");e.src="//bleem.disqus.com/embed.js",e.setAttribute("data-timestamp",new Date),(t.head||t.body).appendChild(e)}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-docker"></i> <a href="https://bandwagonhost.com/aff.php?aff=61367" target="_blank" rel="nofollow noopener"><span>BandwagonHost</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!0,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>