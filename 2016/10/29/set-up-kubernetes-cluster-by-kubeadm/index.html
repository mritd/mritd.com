<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Kovacs"><meta name="keywords" content="kubeadm,Kubernetes"><meta name="description" content="距离上一篇 [kubernetes 1.4 集群搭建](https:&#x2F;&#x2F;mritd.me&#x2F;2016&#x2F;10&#x2F;09&#x2F;kubernetes-1.4-create-cluster&#x2F;) 发布间隔不算太久，自己也不断地在生产和测试环境鼓捣，有不少 &quot;逗比&quot; 的经历，准备写一下具体的 kubeadm 搭建集群的一些坑和踩坑的经验，如果没有使用过 kubeadm 的同学，最好先看下上面的文章，然后鼓捣一遍，也许并"><meta property="og:type" content="article"><meta property="og:title" content="kubeadm 搭建 kubernetes 集群"><meta property="og:url" content="https://mritd.com/2016/10/29/set-up-kubernetes-cluster-by-kubeadm/index.html"><meta property="og:site_name" content="Kovacs"><meta property="og:description" content="距离上一篇 [kubernetes 1.4 集群搭建](https:&#x2F;&#x2F;mritd.me&#x2F;2016&#x2F;10&#x2F;09&#x2F;kubernetes-1.4-create-cluster&#x2F;) 发布间隔不算太久，自己也不断地在生产和测试环境鼓捣，有不少 &quot;逗比&quot; 的经历，准备写一下具体的 kubeadm 搭建集群的一些坑和踩坑的经验，如果没有使用过 kubeadm 的同学，最好先看下上面的文章，然后鼓捣一遍，也许并"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mritd.com/img/kubeadm_cluster.png"><meta property="article:published_time" content="2016-10-29T06:58:49.000Z"><meta property="article:modified_time" content="2016-10-29T06:58:49.000Z"><meta property="article:author" content="Kovacs"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Kubernetes"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://mritd.com/img/kubeadm_cluster.png"><meta name="twitter:creator" content="@kovacs_orz"><meta name="twitter:site" content="https://twitter.com/kovacs_orz"><title>kubeadm 搭建 kubernetes 集群 - Kovacs</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"mritd.com",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!0,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:"G-H06NPECR0Z"},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=G-H06NPECR0Z",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","G-H06NPECR0Z")}))</script><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Kovacs" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="Kovacs" type="application/rss+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Kovacs</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/friends/" target="_self"><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="kubeadm 搭建 kubernetes 集群"></span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Kovacs </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2016-10-29 14:58" pubdate>2016年10月29日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.4k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 21 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">kubeadm 搭建 kubernetes 集群</h1><div class="markdown-body"><blockquote><p>距离上一篇 <a target="_blank" rel="noopener" href="https://mritd.me/2016/10/09/kubernetes-1.4-create-cluster/">kubernetes 1.4 集群搭建</a> 发布间隔不算太久，自己也不断地在生产和测试环境鼓捣，有不少 “逗比” 的经历，准备写一下具体的 kubeadm 搭建集群的一些坑和踩坑的经验，如果没有使用过 kubeadm 的同学，最好先看下上面的文章，然后鼓捣一遍，也许并不会成功，但大部分坑再来看此文会有收获</p></blockquote><h3 id="一、环境准备"><a href="#一、环境准备" class="headerlink" title="一、环境准备"></a>一、环境准备</h3><p>首先环境还是三台虚拟机，虚拟机地址如下</p><table><thead><tr><th>IP 地址</th><th>节点</th></tr></thead><tbody><tr><td>192.168.1.167</td><td>master</td></tr><tr><td>192.168.1.189</td><td>node1</td></tr><tr><td>192.168.1.176</td><td>node2</td></tr></tbody></table><p>然后每台机器安装好 docker，至于 rpm 安装包版本下面介绍</p><h3 id="二、说点正经事"><a href="#二、说点正经事" class="headerlink" title="二、说点正经事"></a>二、说点正经事</h3><h4 id="2-1、安装包从哪来"><a href="#2-1、安装包从哪来" class="headerlink" title="2.1、安装包从哪来"></a>2.1、安装包从哪来</h4><p>官方的文档页面更新并不及时，同时他的 yum 源更新也很慢，再者…那他妈可是 Google 的服务器，能特么连上吗？以前总是在国外服务器使用 <code>yumdownloader</code> 下载，然后 <code>scp</code> 到本地，虽然能解决问题，但是蛋碎一地…最后找到了源头，如下</p><p><strong>Kubernetes 编译的各种发行版安装包来源于 Github 上的另一个叫 release 的项目，地址 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/release">点这里</a>，把这个项目 <code>clone</code> 下来，由于本人是 Centos 用户，所以进入 rpm 目录，在安装好 docker 的机器上执行那个 <code>docker-build.sh</code> 脚本即可编译 rpm 包，最后会生成到当前目录的 <code>output</code> 目录下,截图如下</strong></p><p><img src="https://cdn.oss.link/markdown/3zs7u.jpg" srcset="/img/loading.gif" lazyload alt="release"></p><p><img src="https://cdn.oss.link/markdown/8b3a4.jpg" srcset="/img/loading.gif" lazyload alt="rpm目录"></p><h4 id="2-2、镜像从哪来"><a href="#2-2、镜像从哪来" class="headerlink" title="2.2、镜像从哪来"></a>2.2、镜像从哪来</h4><p>对的，没错，gcr.io 就是 Google 的域名，服务器更不用提，所以在进行 <code>kubeadm init</code> 操作时如果不先把这些镜像 load 进去绝对会卡死不动，以下列出了所需镜像，但是版本号根据 rpm 版本不同可能略有不同，具体怎么看下面介绍</p><table><thead><tr><th>镜像名称</th><th>版本号</th></tr></thead><tbody><tr><td>gcr.io&#x2F;google_containers&#x2F;kube-discovery-amd64</td><td>1.0</td></tr><tr><td>gcr.io&#x2F;google_containers&#x2F;kubedns-amd64</td><td>1.7</td></tr><tr><td>gcr.io&#x2F;google_containers&#x2F;kube-proxy-amd64</td><td>v1.4.1</td></tr><tr><td>gcr.io&#x2F;google_containers&#x2F;kube-scheduler-amd64</td><td>v1.4.1</td></tr><tr><td>gcr.io&#x2F;google_containers&#x2F;kube-controller-manager-amd64</td><td>v1.4.1</td></tr><tr><td>gcr.io&#x2F;google_containers&#x2F;kube-apiserver-amd64</td><td>v1.4.1</td></tr><tr><td>gcr.io&#x2F;google_containers&#x2F;etcd-amd64</td><td>2.2.5</td></tr><tr><td>gcr.io&#x2F;google_containers&#x2F;kube-dnsmasq-amd64</td><td>1.3</td></tr><tr><td>gcr.io&#x2F;google_containers&#x2F;exechealthz-amd64</td><td>1.1</td></tr><tr><td>gcr.io&#x2F;google_containers&#x2F;pause-amd64</td><td>3.0</td></tr></tbody></table><p><strong>这些镜像有两种办法可以获取，第一种是利用一台国外的服务器，在上面 pull 下来，然后再 save 成 tar 文件，最后 scp 到本地 load 进去；相对于第一种方式比较坑的是取决于服务器速度，每次搞起来也很蛋疼，第二种方式就是利用 docker hub 做中转，简单的说就是利用 docker hub 的自动构建功能，在 Github 中创建一个 Dockerfile，里面只需要 <code>FROM xxxx</code> 这些 gcr.io 的镜像即可，最后 pull 到本地，然后再 tag 一下</strong></p><p><strong>首先创建一个 github 项目，可以直接 fork 我的即可</strong></p><p><img src="https://cdn.oss.link/markdown/2eo34.jpg" srcset="/img/loading.gif" lazyload alt="docker-libray"></p><p>其中每个 Dockerfile 只需要 <code>FROM</code> 一下即可</p><p><img src="https://cdn.oss.link/markdown/cxva2.jpg" srcset="/img/loading.gif" lazyload alt="Dockerfile"></p><p><strong>最后在 Docker Hub 上创建自动构建项目</strong></p><p><img src="https://cdn.oss.link/markdown/p5khs.jpg" srcset="/img/loading.gif" lazyload alt="createproject"></p><p><img src="https://cdn.oss.link/markdown/gc8vl.jpg" srcset="/img/loading.gif" lazyload alt="from github"></p><p><img src="https://cdn.oss.link/markdown/9ufnd.jpg" srcset="/img/loading.gif" lazyload alt="selectproject"></p><p><img src="https://cdn.oss.link/markdown/ud42y.jpg" srcset="/img/loading.gif" lazyload alt="details"></p><p><strong>最后要手动触发一下，然后 Docker Hub 才会开始给你编译</strong></p><p><img src="https://cdn.oss.link/markdown/phgsg.jpg" srcset="/img/loading.gif" lazyload alt="Tigger"></p><p><strong>等待完成即可直接 pull 了</strong></p><p><img src="https://cdn.oss.link/markdown/itnw3.jpg" srcset="/img/loading.gif" lazyload alt="success"></p><h4 id="2-3、镜像版本怎么整"><a href="#2-3、镜像版本怎么整" class="headerlink" title="2.3、镜像版本怎么整"></a>2.3、镜像版本怎么整</h4><p>上面已经解决了镜像获取问题，但是一大心病就是 “我特么怎么知道是哪个版本的”，为了发扬 “刨根问底” 的精神，<strong>先进行一遍 <code>kubeadm init</code>，这时候绝对卡死，此时进入 <code>/etc/kubernetes/manifests</code> 可以看到许多 json 文件，这些文件中定义了需要哪些基础镜像</strong></p><p><img src="https://cdn.oss.link/markdown/3ovg8.jpg" srcset="/img/loading.gif" lazyload alt="all json"></p><p><img src="https://cdn.oss.link/markdown/uitnd.jpg" srcset="/img/loading.gif" lazyload alt="image version"></p><p>从上图中基本可以看到 <code>kubeadm init</code> 的时候会拉取哪些基础镜像了，<strong>但是还有一些镜像，仍然无法找到，比如<code>kubedns</code>、<code>pause</code> 等，至于其他的镜像版本，可以从源码中找到，源码位置是 <code>kubernetes/cmd/kubeadm/app/images/images.go</code> 这个文件中，如下所示:</strong></p><p><img src="https://cdn.oss.link/markdown/ocgu4.jpg" srcset="/img/loading.gif" lazyload alt="image version"></p><p>剩余的一些镜像，比如 <code>kube-proxy-amd64</code>、<code>kube-discovery-amd64</code> 两个镜像，其中 <code>kube-discovery-amd64</code> 现在一直是 1.0 版本，源码如下所示</p><p><img src="https://cdn.oss.link/markdown/mp3qo.jpg" srcset="/img/loading.gif" lazyload alt="discovery version"></p><p><code>kube-proxy-amd64</code> 则是一直跟随基础组件的主版本，也就是说如果从 <code>manifests</code> 中看到 controller 等版本是 <code>v.1.4.4</code>，那么 <code>kube-proxy-amd64</code> 也是这个版本，源码如下</p><p><img src="https://cdn.oss.link/markdown/tienu.jpg" srcset="/img/loading.gif" lazyload alt="proxy version"></p><p>最后根据这些版本去 github 上准备相应的 Dockerfile，在利用 Docker Hub 的自动构建 build 一下，再 pull 下来 tag 成对应的镜像名称即可</p><h3 id="三、搭建集群"><a href="#三、搭建集群" class="headerlink" title="三、搭建集群"></a>三、搭建集群</h3><h4 id="3-1、主机名处理"><a href="#3-1、主机名处理" class="headerlink" title="3.1、主机名处理"></a>3.1、主机名处理</h4><p><strong>经过亲测，节点主机名最好为 <code>xxx.xxx</code> 这种域名格式，否则在某些情况下，POD 中跑的程序使用域名解析时可能出现问题，所以先要处理一下主机名</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 写入 hostname(node 节点后缀改成 .node)</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;192-168-1-167.master&quot;</span> &gt; /etc/hostname <br><span class="hljs-comment"># 加入 hosts</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;127.0.0.1   192-168-1-167.master&quot;</span> &gt;&gt; /etc/hosts<br><span class="hljs-comment"># 不重启情况下使内核生效</span><br>sysctl kernel.hostname=192-168-1-167.master<br><span class="hljs-comment"># 验证是否修改成功</span><br>➜  ~ hostname<br>192-168-1-167.master<br></code></pre></td></tr></table></figure><h4 id="3-2、load-镜像"><a href="#3-2、load-镜像" class="headerlink" title="3.2、load 镜像"></a>3.2、load 镜像</h4><p>由于本人已经在 Docker Hub 上处理好了相关镜像，所以直接 pull 下来 tag 一下即可，</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">images=(kube-proxy-amd64:v1.4.4 kube-discovery-amd64:1.0 kubedns-amd64:1.7 kube-scheduler-amd64:v1.4.4 kube-controller-manager-amd64:v1.4.4 kube-apiserver-amd64:v1.4.4 etcd-amd64:2.2.5 kube-dnsmasq-amd64:1.3 exechealthz-amd64:1.1 pause-amd64:3.0 kubernetes-dashboard-amd64:v1.4.1)<br><span class="hljs-keyword">for</span> imageName <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;images[@]&#125;</span> ; <span class="hljs-keyword">do</span><br>  docker pull mritd/<span class="hljs-variable">$imageName</span><br>  docker tag mritd/<span class="hljs-variable">$imageName</span> gcr.io/google_containers/<span class="hljs-variable">$imageName</span><br>  docker rmi mritd/<span class="hljs-variable">$imageName</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h4 id="3-3、安装-rpm"><a href="#3-3、安装-rpm" class="headerlink" title="3.3、安装 rpm"></a>3.3、安装 rpm</h4><p>rpm 获取办法上文已经提到，可以自己编译，这里我已经编译好并维护了一个 yum 源，直接yum install 即可(懒)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 添加 yum 源</span><br><span class="hljs-built_in">tee</span> /etc/yum.repos.d/mritd.repo &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">[mritdrepo]</span><br><span class="hljs-string">name=Mritd Repository</span><br><span class="hljs-string">baseurl=https://rpm.mritd.me/centos/7/x86_64</span><br><span class="hljs-string">enabled=1</span><br><span class="hljs-string">gpgcheck=1</span><br><span class="hljs-string">gpgkey=https://cdn.oss.link/keys/rpm.public.key</span><br><span class="hljs-string">EOF</span><br><span class="hljs-comment"># 刷新cache</span><br>yum makecache<br><span class="hljs-comment"># 安装</span><br>yum install -y kubelet kubectl kubernetes-cni kubeadm<br></code></pre></td></tr></table></figure><h4 id="3-4、初始化-master"><a href="#3-4、初始化-master" class="headerlink" title="3.4、初始化 master"></a>3.4、初始化 master</h4><p><strong>等会有个坑，kubeadm 等相关 rpm 安装后会生成 <code>/etc/kubernetes</code> 目录，而 kubeadm init 时候又会检测这些目录是否存在，如果存在则停止初始化，所以要先清理一下，以下清理脚本来源于 <a target="_blank" rel="noopener" href="http://kubernetes.io/docs/getting-started-guides/kubeadm/">官方文档 Tear down 部分</a>，该脚本同样适用于初始化失败进行重置</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl stop kubelet;<br><span class="hljs-comment"># 注意: 下面这条命令会干掉所有正在运行的 docker 容器，</span><br><span class="hljs-comment"># 如果要进行重置操作，最好先确定当前运行的所有容器都能干掉(干掉不影响业务)，</span><br><span class="hljs-comment"># 否则的话最好手动删除 kubeadm 创建的相关容器(gcr.io 相关的)</span><br>docker <span class="hljs-built_in">rm</span> -f -v $(docker ps -q);<br>find /var/lib/kubelet | xargs -n 1 findmnt -n -t tmpfs -o TARGET -T | <span class="hljs-built_in">uniq</span> | xargs -r umount -v;<br><span class="hljs-built_in">rm</span> -r -f /etc/kubernetes /var/lib/kubelet /var/lib/etcd;<br></code></pre></td></tr></table></figure><p><strong>还有个坑，初始化以前记得一定要启动 kubelet，虽然你 <code>systemctl status kubelet</code> 看着他是启动失败，但是也得启动，否则绝壁卡死</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl <span class="hljs-built_in">enable</span> kubelet<br>systemctl start kubelet<br></code></pre></td></tr></table></figure><p><strong>等会等会，还有坑，新版本直接 init 会提示 <code>ebtables not found in system path</code> 错误，所以还得先安装一下这个包在初始化</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 安装 ebtables</span><br>yum install -y ebtables<br></code></pre></td></tr></table></figure><p><strong>最后见证奇迹的时刻</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 初始化并指定 apiserver 监听地址</span><br>kubeadm init --api-advertise-addresses 192.168.1.167<br></code></pre></td></tr></table></figure><p><strong>完美截图如下</strong></p><p><img src="https://cdn.oss.link/markdown/rs2mw.jpg" srcset="/img/loading.gif" lazyload alt="init master"></p><p><strong>这里再爆料一个坑，底下的 <code>kubeadm join --token=b17964.5d8a3c14e99cf6aa 192.168.1.167</code> 这条命令一定保存好，因为后期没法重现的，你们老大再让你添加机器的时候如果没这个你会哭的</strong></p><h4 id="3-5、加入-node"><a href="#3-5、加入-node" class="headerlink" title="3.5、加入 node"></a>3.5、加入 node</h4><p>上面所有坑大约说的差不多了，直接上命令了</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 处理主机名</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;192-168-1-189.node&quot;</span> &gt; /etc/hostname <br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;127.0.0.1   192-168-1-189.node&quot;</span> &gt;&gt; /etc/hosts<br>sysctl kernel.hostname=192-168-1-189.node<br><span class="hljs-comment"># 拉取镜像</span><br>images=(kube-proxy-amd64:v1.4.4 kube-discovery-amd64:1.0 kubedns-amd64:1.7 kube-scheduler-amd64:v1.4.4 kube-controller-manager-amd64:v1.4.4 kube-apiserver-amd64:v1.4.4 etcd-amd64:2.2.5 kube-dnsmasq-amd64:1.3 exechealthz-amd64:1.1 pause-amd64:3.0 kubernetes-dashboard-amd64:v1.4.1)<br><span class="hljs-keyword">for</span> imageName <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;images[@]&#125;</span> ; <span class="hljs-keyword">do</span><br>  docker pull mritd/<span class="hljs-variable">$imageName</span><br>  docker tag mritd/<span class="hljs-variable">$imageName</span> gcr.io/google_containers/<span class="hljs-variable">$imageName</span><br>  docker rmi mritd/<span class="hljs-variable">$imageName</span><br><span class="hljs-keyword">done</span><br><span class="hljs-comment"># 装 rpm</span><br><span class="hljs-built_in">tee</span> /etc/yum.repos.d/mritd.repo &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">[mritdrepo]</span><br><span class="hljs-string">name=Mritd Repository</span><br><span class="hljs-string">baseurl=https://rpm.mritd.me/centos/7/x86_64</span><br><span class="hljs-string">enabled=1</span><br><span class="hljs-string">gpgcheck=1</span><br><span class="hljs-string">gpgkey=https://cdn.oss.link/keys/rpm.public.key</span><br><span class="hljs-string">EOF</span><br>yum makecache<br>yum install -y kubelet kubectl kubernetes-cni kubeadm ebtables<br><span class="hljs-comment"># 清理目录(没初始化过只需要删目录)</span><br><span class="hljs-built_in">rm</span> -r -f /etc/kubernetes /var/lib/kubelet /var/lib/etcd;<br><span class="hljs-comment"># 启动 kubelet</span><br>systemctl <span class="hljs-built_in">enable</span> kubelet<br>systemctl start kubelet<br><span class="hljs-comment"># 初始化加入集群</span><br>kubeadm <span class="hljs-built_in">join</span> --token=b17964.5d8a3c14e99cf6aa 192.168.1.167<br></code></pre></td></tr></table></figure><p><strong>同样完美截图</strong></p><p><img src="https://cdn.oss.link/markdown/9c8eu.jpg" srcset="/img/loading.gif" lazyload alt="join master"></p><p><img src="https://cdn.oss.link/markdown/ri4q9.jpg" srcset="/img/loading.gif" lazyload alt="get node"></p><h4 id="3-6、部署-weave-网络"><a href="#3-6、部署-weave-网络" class="headerlink" title="3.6、部署 weave 网络"></a>3.6、部署 weave 网络</h4><p>再没部署 weave 时，dns 是启动不了的，如下</p><p><img src="https://cdn.oss.link/markdown/fqjsg.jpg" srcset="/img/loading.gif" lazyload alt="dns not work"></p><p><strong>官方给出的命令是这样的</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl create -f https://git.io/weave-kube<br></code></pre></td></tr></table></figure><p>本着 “刨根问底挖祖坟” 的精神，先把这个 yaml 搞下来</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://git.io/weave-kube -O weave-kube.yaml<br></code></pre></td></tr></table></figure><p>然后同样的套路，打开看一下镜像，利用 Docker Hub 做中转，搞下来再 load 进去，然后 <code>create -f</code> 就行了</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker pull mritd/weave-kube:1.7.2<br>docker tag mritd/weave-kube:1.7.2 weaveworks/weave-kube:1.7.2<br>docker rmi mritd/weave-kube:1.7.2<br>kubectl create -f weave-kube.yaml<br></code></pre></td></tr></table></figure><p><strong>完美截图</strong></p><p><img src="https://cdn.oss.link/markdown/0ja5f.jpg" srcset="/img/loading.gif" lazyload alt="create weave"></p><h4 id="3-7、部署-dashboard"><a href="#3-7、部署-dashboard" class="headerlink" title="3.7、部署 dashboard"></a>3.7、部署 dashboard</h4><p><strong>dashboard 的命令也跟 weave 的一样，不过有个大坑，默认的 yaml 文件中对于 image 拉取策略的定义是 无论何时都会去拉取镜像，导致即使你 load 进去也无卵用，所以还得先把 yaml 搞下来然后改一下镜像拉取策略，最后再 <code>create -f</code> 即可</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://rawgit.com/kubernetes/dashboard/master/src/deploy/kubernetes-dashboard.yaml -O kubernetes-dashboard.yaml<br></code></pre></td></tr></table></figure><p><strong>编辑 yaml 改一下 <code>imagePullPolicy</code>，把 <code>Always</code> 改成 <code>IfNotPresent</code>(本地没有再去拉取) 或者 <code>Never</code>(从不去拉取) 即可</strong></p><p><img src="https://cdn.oss.link/markdown/lqvh1.jpg" srcset="/img/loading.gif" lazyload alt="IfNotPresent"></p><p>最后再利用 Dokcer Hub 中转，然后创建(实际上 dashboard 已经有了 v1.4.1，我这里已经改了)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl create -f kubernetes-dashboard.yaml<br></code></pre></td></tr></table></figure><p><strong>截图如下</strong></p><p><img src="https://cdn.oss.link/markdown/xsn9u.jpg" srcset="/img/loading.gif" lazyload alt="create dashboard"></p><p><strong>通过 describe 命令我们可以查看其暴露出的 <code>NodePoint</code>,然后便可访问</strong></p><p><img src="https://cdn.oss.link/markdown/5a94q.jpg" srcset="/img/loading.gif" lazyload alt="describe dashboard"></p><p><img src="https://cdn.oss.link/markdown/xwjvs.jpg" srcset="/img/loading.gif" lazyload alt="show dashboard"></p><h3 id="四、其他的一些坑"><a href="#四、其他的一些坑" class="headerlink" title="四、其他的一些坑"></a>四、其他的一些坑</h3><p>还有一些其他的坑等着大家去摸索，其中有一个是 DNS 解析错误，表现形式为 <strong>POD 内的程序通过域名访问解析不了，cat 一下容器的 <code>/etc/resolv.conf</code>发现指向的 dns 服务器与 <code>kubectl get svc --namespace=kube-system</code> 中的 kube-dsn 地址不符</strong>；解决办法就是 <strong>编辑节点的 <code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> 文件，更改 <code>KUBELET_DNS_ARGS</code> 地址为 <code>get svc</code> 中的 kube-dns 地址，然后重启 kubelet 服务，重新杀掉 POD 让 kubernetes 重建即可</strong></p><p><img src="https://cdn.oss.link/markdown/hhozt.jpg" srcset="/img/loading.gif" lazyload alt="modify kube-dns"></p><p><strong>其他坑欢迎大家补充</strong></p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/kubernetes/" class="category-chain-item">Kubernetes</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/linux/" class="print-no-link">#Linux</a> <a href="/tags/docker/" class="print-no-link">#Docker</a> <a href="/tags/kubernetes/" class="print-no-link">#Kubernetes</a></div></div><div class="license-box my-3"><div class="license-title"><div>kubeadm 搭建 kubernetes 集群</div><div>https://mritd.com/2016/10/29/set-up-kubernetes-cluster-by-kubeadm/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Kovacs</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2016年10月29日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2016/11/02/wanyue/" title="晚月"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">晚月</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2016/10/25/waved-goodbye/" title="人生就是会不断挥手说再见的啊"><span class="hidden-mobile">人生就是会不断挥手说再见的啊</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://mritd.com/2016/10/29/set-up-kubernetes-cluster-by-kubeadm/",this.page.identifier="/2016/10/29/set-up-kubernetes-cluster-by-kubeadm/"};Fluid.utils.loadComments("#disqus_thread",(function(){var e=document,t=e.createElement("script");t.src="//bleem.disqus.com/embed.js",t.setAttribute("data-timestamp",new Date),(e.head||e.body).appendChild(t)}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-docker"></i> <a href="https://bandwagonhost.com/aff.php?aff=61367" target="_blank" rel="nofollow noopener"><span>BandwagonHost</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!0,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>